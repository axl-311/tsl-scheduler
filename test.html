<!DOCTYPE html>
<html>
<head>
  <title>Test Google Calendar</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { padding: 10px; margin: 5px; }
    #log { background: #f0f0f0; padding: 10px; margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Google Calendar Test</h1>
  <button id="connectBtn" disabled>Connect to Google</button>
  <button id="testLoadBtn" disabled>Test Load Events</button>
  <button id="testCreateBtn" disabled>Test Create Event</button>
  
  <div id="log">Waiting for Google APIs to load...</div>

  <script>
    const log = (msg) => {
      document.getElementById('log').innerHTML += '\n' + new Date().toLocaleTimeString() + ': ' + msg;
    };

    let tokenClient = null;

    window.gapiLoaded = function() {
      log('GAPI loaded, initializing...');
      gapi.load('client', async () => {
        try {
          await gapi.client.init({
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
          });
          log('✓ GAPI initialized');
          checkReady();
        } catch(e) {
          log('✗ GAPI init error: ' + e.message);
        }
      });
    };

    window.gisLoaded = function() {
      log('GIS loaded, initializing...');
      // Replace with your client ID
      const CLIENT_ID = '805806936738-svig4rs4b96t849n81b7e5hi8p44qo0v.apps.googleusercontent.com';
      
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/calendar.events',
        callback: (response) => {
          if (response && !response.error) {
            log('✓ Connected to Google!');
            document.getElementById('testLoadBtn').disabled = false;
            document.getElementById('testCreateBtn').disabled = false;
          } else {
            log('✗ Connection failed: ' + JSON.stringify(response));
          }
        }
      });
      log('✓ GIS initialized');
      checkReady();
    };

    function checkReady() {
      if (typeof gapi !== 'undefined' && gapi.client && tokenClient) {
        document.getElementById('connectBtn').disabled = false;
        log('✓ Ready to connect!');
      }
    }

    document.getElementById('connectBtn').onclick = () => {
      log('Requesting access token...');
      tokenClient.requestAccessToken({ prompt: '' });
    };

    document.getElementById('testLoadBtn').onclick = async () => {
      log('Loading events from calendar...');
      try {
        const response = await gapi.client.calendar.events.list({
          calendarId: 'primary',
          timeMin: new Date().toISOString(),
          maxResults: 10,
          singleEvents: true,
          orderBy: 'startTime'
        });
        
        const events = response.result.items || [];
        log(`✓ Found ${events.length} events`);
        events.forEach(event => {
          const start = event.start.dateTime || event.start.date;
          log(`  - ${event.summary} at ${start}`);
        });
      } catch(e) {
        log('✗ Load error: ' + e.message);
      }
    };

    document.getElementById('testCreateBtn').onclick = async () => {
      log('Creating test event...');
      try {
        const event = {
          summary: '[TSL] Test Event',
          start: {
            dateTime: new Date().toISOString(),
            timeZone: 'America/New_York'
          },
          end: {
            dateTime: new Date(Date.now() + 3600000).toISOString(),
            timeZone: 'America/New_York'
          }
        };
        
        const response = await gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: event
        });
        
        log('✓ Event created: ' + response.result.summary);
      } catch(e) {
        log('✗ Create error: ' + e.message);
      }
    };
  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>