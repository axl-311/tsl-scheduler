<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSL Scheduler 2.0</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--gray-100);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--gray-100);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Layout */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 300px;
      background: white;
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .movie-card {
      border: 2px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      cursor: grab;
      background: white;
    }

    .movie-card:hover {
      border-color: var(--primary);
    }

    .movie-card.dragging {
      opacity: 0.5;
    }

    /* Schedule */
    .schedule-area {
      flex: 1;
      overflow: auto;
      padding: 1.5rem;
    }

    .week-nav {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .schedule-grid {
      background: white;
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    .days-container {
      display: flex;
      min-width: fit-content;
    }

    .day-column {
      min-width: 500px;
      border-right: 1px solid var(--gray-200);
    }

    .day-header {
      padding: 0.75rem;
      background: var(--gray-100);
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
    }

    .theaters-row {
      display: flex;
      border-bottom: 1px solid var(--gray-200);
    }

    .time-header {
      width: 80px;
      padding: 0.5rem;
      text-align: center;
      border-right: 1px solid var(--gray-200);
    }

    .theater-header {
      flex: 1;
      padding: 0.5rem;
      text-align: center;
      border-right: 1px solid var(--gray-200);
    }

    .day-body {
      display: flex;
    }

    .time-column {
      width: 80px;
      border-right: 1px solid var(--gray-200);
    }

    .time-slot {
      height: 24px;
      padding: 0 0.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-size: 0.75rem;
      color: var(--gray-500);
      border-bottom: 1px solid var(--gray-100);
    }

    .time-slot.hour {
      font-weight: 600;
      border-bottom-color: var(--gray-200);
    }

    .theaters {
      flex: 1;
      display: flex;
    }

    .theater-lane {
      flex: 1;
      position: relative;
      border-right: 1px solid var(--gray-200);
      background-image: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 23px,
        var(--gray-100) 23px,
        var(--gray-100) 24px
      );
    }

    .theater-lane.drag-over {
      background-color: rgba(59, 130, 246, 0.1);
    }

    /* Schedule blocks */
    .schedule-block {
      position: absolute;
      left: 4px;
      right: 4px;
      background: var(--primary);
      color: white;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: grab;
    }

    .schedule-block:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .block-remove {
      float: right;
      cursor: pointer;
      font-weight: bold;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .form-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 2000;
    }

    .toast.show {
      display: block;
    }

    .google-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      background: var(--gray-200);
    }

    .google-status.connected {
      background: var(--success);
      color: white;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>
      üé¨ TSL Scheduler
      <span class="google-status" id="googleStatus">Not Connected</span>
    </h1>
    <div style="display: flex; gap: 0.5rem;">
      <button class="btn" onclick="app.openSettings()">‚öôÔ∏è Settings</button>
      <button class="btn btn-primary" onclick="app.saveAll()">üíæ Save</button>
      <button class="btn btn-success" id="connectBtn" onclick="app.connectGoogle()" disabled>üîó Connect</button>
      <button class="btn btn-primary" id="pushBtn" onclick="app.pushToGoogle()" style="display:none">üì§ Push</button>
      <button class="btn" id="loadBtn" onclick="app.loadFromGoogle()" style="display:none">üì• Load</button>
    </div>
  </div>

  <div class="main">
    <div class="sidebar">
      <div class="sidebar-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong>Film Library</strong>
          <button class="btn btn-primary" onclick="app.openMovieDialog()">+ Add Film</button>
        </div>
      </div>
      <div class="sidebar-content" id="moviesList"></div>
    </div>

    <div class="schedule-area">
      <div class="week-nav">
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button class="btn" onclick="app.changeWeek(-1)">‚Äπ</button>
          <strong id="weekLabel">Loading...</strong>
          <button class="btn" onclick="app.changeWeek(1)">‚Ä∫</button>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn" onclick="app.goToToday()">Today</button>
          <button class="btn btn-danger" onclick="app.clearWeek()">Clear Week</button>
        </div>
      </div>

      <div class="schedule-grid">
        <div class="days-container" id="daysContainer"></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button onclick="app.closeModal('settingsModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Start Hour (24h)</label>
          <input type="number" class="form-input" id="startHour" min="0" max="23" value="14">
        </div>
        <div class="form-group">
          <label class="form-label">End Hour (24h)</label>
          <input type="number" class="form-input" id="endHour" min="1" max="24" value="24">
        </div>
        <div class="form-group">
          <label class="form-label">Theater 1 Calendar ID</label>
          <input type="text" class="form-input" id="calT1" placeholder="Leave blank for primary">
        </div>
        <div class="form-group">
          <label class="form-label">Theater 2 Calendar ID</label>
          <input type="text" class="form-input" id="calT2" placeholder="Leave blank for primary">
        </div>
        <div class="form-group">
          <label class="form-label">TSL Events Calendar ID</label>
          <input type="text" class="form-input" id="calPublic" placeholder="Leave blank for primary">
        </div>
        <div class="form-group">
          <label class="form-label">TSL Events (NON-PUBLIC) Calendar ID</label>
          <input type="text" class="form-input" id="calNonPublic" placeholder="Leave blank for primary">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="app.closeModal('settingsModal')">Cancel</button>
        <button class="btn btn-primary" onclick="app.saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Movie Modal -->
  <div class="modal" id="movieModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add/Edit Film</h2>
        <button onclick="app.closeModal('movieModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" class="form-input" id="movieTitle">
        </div>
        <div class="form-group">
          <label class="form-label">Duration (minutes)</label>
          <input type="number" class="form-input" id="movieDuration" min="1" value="120">
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <input type="color" class="form-input" id="movieColor" value="#3b82f6">
        </div>
        <input type="hidden" id="movieId">
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="app.closeModal('movieModal')">Cancel</button>
        <button class="btn btn-primary" onclick="app.saveMovie()">Save</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    class Scheduler {
      constructor() {
        this.config = {
          startHour: 14,
          endHour: 24,
          slotMinutes: 15,
          calendars: {
            t1: '',
            t2: '',
            public: '',
            nonpublic: ''
          }
        };
        this.movies = [];
        this.schedules = {};
        this.currentWeek = null;
        this.draggedItem = null;
        this.googleConnected = false;
        this.init();
      }

      init() {
        this.loadConfig();
        this.loadMovies();
        this.setCurrentWeek(new Date());
        this.loadSchedules();
        this.render();
        this.setupDragDrop();
        this.initGoogle();
      }

      // Google Calendar
      initGoogle() {
        window.handleGapiLoad = () => {
          gapi.load('client', async () => {
            await gapi.client.init({
              discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
            });
            this.checkGoogleReady();
          });
        };

        window.handleGisLoad = () => {
          window.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '805806936738-svig4rs4b96t849n81b7e5hi8p44qo0v.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/calendar.events',
            callback: (response) => {
              if (response && !response.error) {
                this.onGoogleConnected();
              }
            }
          });
          this.checkGoogleReady();
        };

        // Load scripts
        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.onload = window.handleGapiLoad;
        document.body.appendChild(gapiScript);

        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.onload = window.handleGisLoad;
        document.body.appendChild(gisScript);
      }

      checkGoogleReady() {
        if (typeof gapi !== 'undefined' && gapi.client && window.tokenClient) {
          document.getElementById('connectBtn').disabled = false;
        }
      }

      connectGoogle() {
        if (window.tokenClient) {
          window.tokenClient.requestAccessToken({ prompt: '' });
        }
      }

      onGoogleConnected() {
        this.googleConnected = true;
        document.getElementById('googleStatus').textContent = 'Connected';
        document.getElementById('googleStatus').classList.add('connected');
        document.getElementById('pushBtn').style.display = 'inline-block';
        document.getElementById('loadBtn').style.display = 'inline-block';
        this.showToast('Connected to Google Calendar');
      }

      async loadFromGoogle() {
        if (!this.googleConnected) {
          this.showToast('Please connect to Google first');
          return;
        }

        try {
          const weekStart = new Date(this.currentWeek);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 7);

          this.schedules = {};
          let totalLoaded = 0;

          // Load from each calendar
          const calendars = [
            { id: this.config.calendars.t1 || 'primary', theater: 't1' },
            { id: this.config.calendars.t2 || 'primary', theater: 't2' },
            { id: this.config.calendars.public || 'primary', theater: 't1' },
            { id: this.config.calendars.nonpublic || 'primary', theater: 't2' }
          ];

          for (const cal of calendars) {
            try {
              const response = await gapi.client.calendar.events.list({
                calendarId: cal.id,
                timeMin: weekStart.toISOString(),
                timeMax: weekEnd.toISOString(),
                singleEvents: true,
                orderBy: 'startTime'
              });

              const events = response.result.items || [];
              
              for (const event of events) {
                if (!event.start.dateTime) continue;
                
                const start = new Date(event.start.dateTime);
                const end = new Date(event.end.dateTime);
                const duration = Math.round((end - start) / 60000);
                
                const dayIndex = Math.floor((start - weekStart) / (1000 * 60 * 60 * 24));
                if (dayIndex < 0 || dayIndex > 6) continue;
                
                const startMinutes = start.getHours() * 60 + start.getMinutes();
                const slot = Math.round((startMinutes - this.config.startHour * 60) / this.config.slotMinutes);
                
                const key = `${dayIndex}-${cal.theater}`;
                if (!this.schedules[key]) this.schedules[key] = [];
                
                this.schedules[key].push({
                  id: Date.now() + Math.random(),
                  title: event.summary || 'Untitled',
                  duration: duration,
                  startSlot: slot,
                  color: '#3b82f6'
                });
                
                totalLoaded++;
              }
            } catch (e) {
              console.log(`Failed to load from ${cal.id}:`, e);
            }
          }

          this.saveSchedules();
          this.renderSchedule();
          this.showToast(`Loaded ${totalLoaded} events from Google Calendar`);
        } catch (error) {
          this.showToast('Failed to load from Google');
          console.error(error);
        }
      }

      async pushToGoogle() {
        if (!this.googleConnected) {
          this.showToast('Please connect to Google first');
          return;
        }

        try {
          const weekStart = new Date(this.currentWeek);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 7);

          // Clear existing [TSL] events
          const calendars = [
            this.config.calendars.t1 || 'primary',
            this.config.calendars.t2 || 'primary'
          ];

          for (const calId of [...new Set(calendars)]) {
            const response = await gapi.client.calendar.events.list({
              calendarId: calId,
              timeMin: weekStart.toISOString(),
              timeMax: weekEnd.toISOString(),
              singleEvents: true
            });

            const events = response.result.items || [];
            for (const event of events) {
              if (event.summary && event.summary.includes('[TSL]')) {
                await gapi.client.calendar.events.delete({
                  calendarId: calId,
                  eventId: event.id
                });
              }
            }
          }

          // Add current schedule
          for (const [key, blocks] of Object.entries(this.schedules)) {
            const [dayIndex, theater] = key.split('-');
            const date = new Date(this.currentWeek);
            date.setDate(date.getDate() + parseInt(dayIndex));

            const calendarId = theater === 't1' 
              ? (this.config.calendars.t1 || 'primary')
              : (this.config.calendars.t2 || 'primary');

            for (const block of blocks) {
              const startDate = new Date(date);
              const totalMinutes = this.config.startHour * 60 + block.startSlot * this.config.slotMinutes;
              startDate.setHours(Math.floor(totalMinutes / 60), totalMinutes % 60, 0, 0);
              
              const endDate = new Date(startDate);
              endDate.setMinutes(endDate.getMinutes() + block.duration);

              await gapi.client.calendar.events.insert({
                calendarId: calendarId,
                resource: {
                  summary: `[TSL] ${block.title}`,
                  start: { dateTime: startDate.toISOString() },
                  end: { dateTime: endDate.toISOString() }
                }
              });
            }
          }

          this.showToast('Pushed to Google Calendar');
        } catch (error) {
          this.showToast('Failed to push to Google');
          console.error(error);
        }
      }

      // Settings
      openSettings() {
        document.getElementById('startHour').value = this.config.startHour;
        document.getElementById('endHour').value = this.config.endHour;
        document.getElementById('calT1').value = this.config.calendars.t1 || '';
        document.getElementById('calT2').value = this.config.calendars.t2 || '';
        document.getElementById('calPublic').value = this.config.calendars.public || '';
        document.getElementById('calNonPublic').value = this.config.calendars.nonpublic || '';
        document.getElementById('settingsModal').classList.add('open');
      }

      saveSettings() {
        this.config.startHour = parseInt(document.getElementById('startHour').value);
        this.config.endHour = parseInt(document.getElementById('endHour').value);
        this.config.calendars.t1 = document.getElementById('calT1').value;
        this.config.calendars.t2 = document.getElementById('calT2').value;
        this.config.calendars.public = document.getElementById('calPublic').value;
        this.config.calendars.nonpublic = document.getElementById('calNonPublic').value;
        
        this.saveConfig();
        this.render();
        this.closeModal('settingsModal');
        this.showToast('Settings saved');
      }

      // Data management
      loadConfig() {
        const saved = localStorage.getItem('tsl_config_clean');
        if (saved) {
          Object.assign(this.config, JSON.parse(saved));
        }
      }

      saveConfig() {
        localStorage.setItem('tsl_config_clean', JSON.stringify(this.config));
      }

      loadMovies() {
        const saved = localStorage.getItem('tsl_movies_clean');
        this.movies = saved ? JSON.parse(saved) : [
          { id: 1, title: 'Sample Film', duration: 120, color: '#3b82f6' }
        ];
      }

      saveMovies() {
        localStorage.setItem('tsl_movies_clean', JSON.stringify(this.movies));
      }

      loadSchedules() {
        const key = this.getWeekKey();
        const saved = localStorage.getItem(`tsl_schedule_clean_${key}`);
        this.schedules = saved ? JSON.parse(saved) : {};
      }

      saveSchedules() {
        const key = this.getWeekKey();
        localStorage.setItem(`tsl_schedule_clean_${key}`, JSON.stringify(this.schedules));
      }

      // Week management
      setCurrentWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = (day - 2 + 7) % 7; // Tuesday start
        d.setDate(d.getDate() - diff);
        d.setHours(0, 0, 0, 0);
        this.currentWeek = d;
      }

      getWeekKey() {
        const d = this.currentWeek;
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      }

      changeWeek(direction) {
        this.saveSchedules();
        const d = new Date(this.currentWeek);
        d.setDate(d.getDate() + (direction * 7));
        this.setCurrentWeek(d);
        this.loadSchedules();
        this.render();
      }

      goToToday() {
        this.saveSchedules();
        this.setCurrentWeek(new Date());
        this.loadSchedules();
        this.render();
      }

      clearWeek() {
        if (confirm('Clear all schedules for this week?')) {
          this.schedules = {};
          this.saveSchedules();
          this.renderSchedule();
          this.showToast('Week cleared');
        }
      }

      // Rendering
      render() {
        this.renderWeekLabel();
        this.renderMovies();
        this.renderSchedule();
      }

      renderWeekLabel() {
        const start = new Date(this.currentWeek);
        const end = new Date(start);
        end.setDate(end.getDate() + 6);
        document.getElementById('weekLabel').textContent = 
          `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
      }

      renderMovies() {
        const container = document.getElementById('moviesList');
        container.innerHTML = '';
        
        this.movies.forEach(movie => {
          const card = document.createElement('div');
          card.className = 'movie-card';
          card.draggable = true;
          card.dataset.movieId = movie.id;
          card.style.borderLeftWidth = '4px';
          card.style.borderLeftColor = movie.color;
          card.innerHTML = `
            <div style="font-weight: 600">${movie.title}</div>
            <div style="font-size: 0.875rem; color: var(--gray-500)">${movie.duration} min</div>
          `;
          container.appendChild(card);
        });
      }

      renderSchedule() {
        const container = document.getElementById('daysContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < 7; i++) {
          const dayColumn = this.createDayColumn(i);
          container.appendChild(dayColumn);
        }
        
        // Render blocks
        for (const [key, blocks] of Object.entries(this.schedules)) {
          const [dayIndex, theater] = key.split('-');
          const lane = document.querySelector(`[data-day="${dayIndex}"][data-theater="${theater}"]`);
          if (!lane) continue;
          
          blocks.forEach(block => {
            const el = document.createElement('div');
            el.className = 'schedule-block';
            el.style.top = `${block.startSlot * 24}px`;
            el.style.height = `${(block.duration / this.config.slotMinutes) * 24 - 4}px`;
            el.style.backgroundColor = block.color;
            el.innerHTML = `
              <span class="block-remove" onclick="app.removeBlock('${key}', '${block.id}')">√ó</span>
              <div>${block.title}</div>
            `;
            lane.appendChild(el);
          });
        }
      }

      createDayColumn(dayIndex) {
        const date = new Date(this.currentWeek);
        date.setDate(date.getDate() + dayIndex);
        
        const column = document.createElement('div');
        column.className = 'day-column';
        
        // Header
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        column.appendChild(header);
        
        // Theater headers
        const theaterRow = document.createElement('div');
        theaterRow.className = 'theaters-row';
        theaterRow.innerHTML = `
          <div class="time-header">Time</div>
          <div class="theater-header">Theater 1</div>
          <div class="theater-header">Theater 2</div>
        `;
        column.appendChild(theaterRow);
        
        // Body
        const body = document.createElement('div');
        body.className = 'day-body';
        
        // Time column
        const timeCol = document.createElement('div');
        timeCol.className = 'time-column';
        const slots = (this.config.endHour - this.config.startHour) * 4;
        for (let i = 0; i < slots; i++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          if (i % 4 === 0) {
            slot.classList.add('hour');
            const hour = this.config.startHour + i / 4;
            slot.textContent = `${hour % 12 || 12}:00`;
          }
          timeCol.appendChild(slot);
        }
        body.appendChild(timeCol);
        
        // Theater lanes
        const theaters = document.createElement('div');
        theaters.className = 'theaters';
        
        ['t1', 't2'].forEach(theater => {
          const lane = document.createElement('div');
          lane.className = 'theater-lane';
          lane.dataset.day = dayIndex;
          lane.dataset.theater = theater;
          lane.style.height = `${slots * 24}px`;
          theaters.appendChild(lane);
        });
        
        body.appendChild(theaters);
        column.appendChild(body);
        
        return column;
      }

      // Drag and drop
      setupDragDrop() {
        document.addEventListener('dragstart', (e) => {
          if (e.target.classList.contains('movie-card')) {
            const movieId = parseInt(e.target.dataset.movieId);
            const movie = this.movies.find(m => m.id === movieId);
            this.draggedItem = { type: 'movie', data: movie };
            e.target.classList.add('dragging');
          }
        });

        document.addEventListener('dragover', (e) => {
          const lane = e.target.closest('.theater-lane');
          if (lane && this.draggedItem) {
            e.preventDefault();
            document.querySelectorAll('.theater-lane').forEach(l => l.classList.remove('drag-over'));
            lane.classList.add('drag-over');
          }
        });

        document.addEventListener('drop', (e) => {
          const lane = e.target.closest('.theater-lane');
          if (lane && this.draggedItem) {
            e.preventDefault();
            
            const rect = lane.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const slot = Math.floor(y / 24);
            
            const dayIndex = lane.dataset.day;
            const theater = lane.dataset.theater;
            const key = `${dayIndex}-${theater}`;
            
            if (!this.schedules[key]) this.schedules[key] = [];
            
            this.schedules[key].push({
              id: Date.now().toString(),
              title: this.draggedItem.data.title,
              duration: this.draggedItem.data.duration,
              startSlot: slot,
              color: this.draggedItem.data.color
            });
            
            this.saveSchedules();
            this.renderSchedule();
          }
          
          document.querySelectorAll('.theater-lane').forEach(l => l.classList.remove('drag-over'));
          document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
          this.draggedItem = null;
        });

        document.addEventListener('dragend', () => {
          document.querySelectorAll('.theater-lane').forEach(l => l.classList.remove('drag-over'));
          document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
          this.draggedItem = null;
        });
      }

      removeBlock(key, blockId) {
        this.schedules[key] = this.schedules[key].filter(b => b.id !== blockId);
        if (this.schedules[key].length === 0) delete this.schedules[key];
        this.saveSchedules();
        this.renderSchedule();
      }

      // Movies
      openMovieDialog() {
        document.getElementById('movieId').value = '';
        document.getElementById('movieTitle').value = '';
        document.getElementById('movieDuration').value = '120';
        document.getElementById('movieColor').value = '#3b82f6';
        document.getElementById('movieModal').classList.add('open');
      }

      saveMovie() {
        const title = document.getElementById('movieTitle').value.trim();
        const duration = parseInt(document.getElementById('movieDuration').value);
        const color = document.getElementById('movieColor').value;
        
        if (!title || !duration) {
          this.showToast('Please enter title and duration');
          return;
        }
        
        this.movies.push({
          id: Date.now(),
          title,
          duration,
          color
        });
        
        this.saveMovies();
        this.renderMovies();
        this.closeModal('movieModal');
        this.showToast('Movie added');
      }

      // UI helpers
      closeModal(modalId) {
        document.getElementById(modalId).classList.remove('open');
      }

      showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }

      saveAll() {
        this.saveConfig();
        this.saveMovies();
        this.saveSchedules();
        this.showToast('All changes saved');
      }
    }

    // Initialize app
    const app = new Scheduler();
    window.app = app; // Make available globally
  </script>
</body>
</html>
