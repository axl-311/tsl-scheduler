<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Scheduler v2.4 - WordPress Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version {
            font-size: 12px;
            background: #34c759;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            background: #e8e8e8;
            color: #86868b;
        }

        .status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0051d5;
        }

        .btn-secondary {
            background: #f0f0f2;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e0e0e2;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30a852;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .btn-warning:hover {
            background: #e68600;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Controls */
        .controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-display {
            font-size: 16px;
            font-weight: 500;
            min-width: 350px;
            text-align: center;
        }

        .control-actions {
            display: flex;
            gap: 10px;
        }

        /* Main Layout */
        .main {
            display: flex;
            gap: 20px;
        }

        /* Library Panel */
        .library {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 220px);
            display: flex;
            flex-direction: column;
        }

        .library-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-count {
            font-size: 14px;
            color: #86868b;
            font-weight: normal;
        }

        .library-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .library-items {
            flex: 1;
            overflow-y: auto;
        }

        .library-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: move;
            background: #f0f0f2;
            transition: all 0.2s;
            user-select: none;
            border-left: 4px solid transparent;
        }

        .library-item.movie {
            border-left-color: #007aff;
            background: #e8f4ff;
        }

        .library-item.event {
            border-left-color: #e74c43;
            background: #ffe8e6;
        }

        .library-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .library-item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .library-item-info {
            font-size: 12px;
            color: #86868b;
        }

        /* Schedule Grid */
        .schedule {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px 20px 20px 80px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .days-grid {
            display: flex;
            gap: 4px;
        }

        .day-column {
            flex: 1;
            min-width: 310px;
        }

        .day-header {
            background: #f0f0f2;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            margin-bottom: 2px;
        }

        .theaters {
            display: flex;
            gap: 2px;
        }

        .theater {
            flex: 1;
            position: relative;
            background: #fafafa;
            border-radius: 0 0 8px 8px;
        }

        .theater-header {
            background: #e8e8e8;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .theater-grid {
            position: relative;
            height: 960px;
            border-left: 1px solid #e0e0e0;
        }

        .time-slot {
            height: 80px;
            border-bottom: 1px solid #e8e8e8;
            position: relative;
        }

        .time-label {
            position: absolute;
            left: -65px;
            width: 55px;
            text-align: right;
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
            top: -10px;
            padding-right: 8px;
        }

        /* Event Blocks */
        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 8px;
            border-radius: 6px;
            cursor: move;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }

        .event-block * {
            pointer-events: none;
            user-select: none;
        }

        .event-block.movie-t1 {
            background: #a5dceb;
        }

        .event-block.movie-t2 {
            background: #4bc4a5;
        }

        .event-block.event {
            background: #e74c43;
            color: white;
        }

        .event-block:hover .delete-btn {
            opacity: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.8;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            line-height: 1;
            pointer-events: auto !important;
        }

        .delete-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        /* Drag Preview */
        .drag-preview {
            position: absolute;
            left: 4px;
            right: 4px;
            height: 60px;
            background: rgba(0,122,255,0.2);
            border: 2px dashed #007aff;
            border-radius: 6px;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #007aff;
            font-weight: 600;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1d1d1f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>
                    TSL Scheduler
                    <span class="version">v2.4</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="status" id="status">Not connected</div>
                <button class="btn btn-success" id="authBtn">Connect Google</button>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="week-nav">
                <button class="btn btn-secondary" id="prevWeek">Prev</button>
                <div class="week-display" id="weekDisplay">Loading...</div>
                <button class="btn btn-secondary" id="nextWeek">Next</button>
                <button class="btn btn-secondary" id="lockStatusBtn" style="min-width: 100px; cursor: default;" disabled>DRAFT</button>
            </div>
            <div class="control-actions">
                <button class="btn btn-warning" id="unlockBtn" style="display:none;">Unlock Week</button>
                <button class="btn btn-primary" id="pushBtn" disabled>Push to Google</button>
                <button class="btn btn-secondary" id="clearBtn">Clear Schedule</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Library -->
            <div class="library">
                <div class="library-header">
                    <span>Library</span>
                    <span class="library-count" id="libCount">(0)</span>
                </div>
                <select class="library-search" id="recentFilter" style="margin-bottom: 10px;">
                    <option value="all">All Items</option>
                    <option value="30" selected>Recent (30 days)</option>
                    <option value="7">This Week (7 days)</option>
                    <option value="1">Today</option>
                </select>
                <input type="text" class="library-search" id="search" placeholder="Search...">
                <div class="library-items" id="library">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div>Import from database to get started</div>
                    </div>
                </div>
            </div>

            <!-- Schedule -->
            <div class="schedule">
                <div class="days-grid" id="schedule"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const WORDPRESS_URL = 'https://timeandspace.org'; // YOUR WORDPRESS SITE
        
        const SUPABASE_URL = 'https://tnnkfnattwpqqrydsyux.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubmtmbmF0dHdwcXFyeWRzeXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Njc3NDAsImV4cCI6MjA3MzA0Mzc0MH0.cNzStE1v6YA7HRvTeBCXxGFPuJPq1WmnuVGVaNLjOsE';
        
        const CLIENT_ID = '805806936738-svig4rs4b96t849n81b7e5hi8p44qo0v.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDzisAik43Rr1xTJXg2bHXNF_XRTjjZsh8';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events';
        
        const CALENDARS = {
            'events': '1ed95b09dcc5ea1a1e13267b6654eca3c892fc79c23e2e9edc1e271411967255@group.calendar.google.com',
            'theater-1': '007f10222d517076d028161a4cda7108e75444c18ef7ac0d79aee420313d1a7b@group.calendar.google.com',
            'theater-2': 'ed801a88ce91b43543ef4e87c34d1405a6e053c5254e55e2871f0d305ecc32c4@group.calendar.google.com'
        };

        // ============================================
        // STATE
        // ============================================
        
        let supabase = null;
        let accessToken = null;
        let currentWeek = new Date();
        let library = [];
        let scheduled = [];
        let draggedItem = null;
        let dragOffset = 0;
        let lockedWeeks = {}; // NEW: Track locked weeks by Friday date string
        
        // FIXED: Cache for library items to avoid JSON in HTML attributes
        window.libraryItemsCache = {};

        // ============================================
        // INITIALIZE
        // ============================================
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('TSL Scheduler v2.4 - WordPress Database Storage');

        // ============================================
        // GOOGLE API
        // ============================================
        
        function initGoogleAPI() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                });
                console.log('Google API client initialized');
            });
        }
        
        function initOAuth() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        document.getElementById('status').textContent = 'Connected';
                        document.getElementById('status').classList.add('connected');
                        updateWeekDisplay(); // Update button states
                        showToast('Connected to Google Calendar');
                    }
                },
            });
            
            window.tokenClient = tokenClient;
        }

        document.getElementById('authBtn').onclick = () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Access token revoked');
                });
                accessToken = null;
                document.getElementById('status').textContent = 'Not connected';
                document.getElementById('status').classList.remove('connected');
                updateWeekDisplay(); // Update button states
                showToast('Disconnected from Google Calendar');
            } else {
                if (window.tokenClient) {
                    window.tokenClient.requestAccessToken();
                } else {
                    showToast('Authentication not ready. Please refresh the page.');
                }
            }
        };

        // ============================================
        // WEEK LOCKING SYSTEM - NEW!
        // ============================================
        
        function getFridayOfWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function isCurrentWeekLocked() {
            const friday = getFridayOfWeek(currentWeek);
            const weekKey = formatDate(friday);
            return lockedWeeks[weekKey] || false;
        }

        function lockCurrentWeek() {
            const friday = getFridayOfWeek(currentWeek);
            const weekKey = formatDate(friday);
            lockedWeeks[weekKey] = true;
            console.log('Locking week:', weekKey, 'lockedWeeks:', lockedWeeks);
            saveToWordPress();
            updateWeekDisplay();
            renderSchedule();
            showToast('Week locked');
        }

        function unlockCurrentWeek() {
            if (!confirm('Unlock this week for editing? You will need to re-push to Google after making changes.')) {
                return;
            }
            const friday = getFridayOfWeek(currentWeek);
            const weekKey = formatDate(friday);
            delete lockedWeeks[weekKey];
            saveToWordPress();
            updateWeekDisplay();
            renderSchedule();
            showToast('Week unlocked');
        }

        // ============================================
        // WEEK NAVIGATION
        // ============================================
        
        let weekOffset = 0;
        
        function setWeek(offset) {
            weekOffset += offset;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const day = today.getDay();
            const daysFromFriday = (day + 2) % 7;
            
            currentWeek = new Date(today);
            currentWeek.setDate(today.getDate() - daysFromFriday);
            currentWeek.setDate(currentWeek.getDate() + (weekOffset * 7));
            
            updateWeekDisplay();
            renderSchedule();
        }
        
        function resetWeek() {
            weekOffset = 0;
            setWeek(0);
        }

        function updateWeekDisplay() {
            const friday = getFridayOfWeek(currentWeek);
            const end = new Date(currentWeek);
            end.setDate(end.getDate() + 3);
            
            const weekKey = formatDate(friday);
            const isLocked = lockedWeeks[weekKey] || false;
            
            console.log('updateWeekDisplay - weekKey:', weekKey, 'isLocked:', isLocked, 'lockedWeeks:', lockedWeeks);
            
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('weekDisplay').innerHTML = 
                `${currentWeek.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
            
            // Update lock status indicator (display-only, not clickable)
            const lockStatusBtn = document.getElementById('lockStatusBtn');
            if (isLocked) {
                lockStatusBtn.textContent = 'LOCKED';
                lockStatusBtn.style.background = '#ff4444';
                lockStatusBtn.style.color = 'white';
                lockStatusBtn.style.opacity = '1';
            } else {
                lockStatusBtn.textContent = 'DRAFT';
                lockStatusBtn.style.background = '#4CAF50';
                lockStatusBtn.style.color = 'white';
                lockStatusBtn.style.opacity = '1';
            }
            
            // Update push button state
            const pushBtn = document.getElementById('pushBtn');
            const unlockBtn = document.getElementById('unlockBtn');
            
            if (isLocked) {
                pushBtn.disabled = true;
                pushBtn.textContent = 'Week Locked';
                pushBtn.style.opacity = '0.5';
                pushBtn.style.cursor = 'not-allowed';
                unlockBtn.style.display = 'inline-block';
            } else {
                pushBtn.disabled = !accessToken;
                pushBtn.textContent = 'Push to Google';
                pushBtn.style.opacity = '1';
                pushBtn.style.cursor = 'pointer';
                unlockBtn.style.display = 'none';
            }
        }

        document.getElementById('prevWeek').onclick = () => setWeek(-1);
        document.getElementById('nextWeek').onclick = () => setWeek(1);
        document.getElementById('unlockBtn').onclick = unlockCurrentWeek;

        // ============================================
        // SAVE/LOAD TO WORDPRESS DATABASE
        // ============================================
        
        async function saveToWordPress() {
            try {
                const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        events: scheduled,
                        lockedWeeks: lockedWeeks
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to WordPress');
                }
                
                console.log('Saved to WordPress:', scheduled.length, 'events');
            } catch (error) {
                console.error('Failed to save to WordPress:', error);
                showToast('Warning: Failed to save to database');
            }
        }
        
        async function loadFromWordPress() {
            try {
                const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/load`);
                
                if (!response.ok) {
                    throw new Error('Failed to load from WordPress');
                }
                
                const data = await response.json();
                
                if (data.events && Array.isArray(data.events)) {
                    scheduled = data.events;
                    scheduled.forEach(event => {
                        if (event.startTime) {
                            event.startTime = new Date(event.startTime);
                        }
                        if (event.actualDate) {
                            event.actualDate = new Date(event.actualDate);
                        }
                    });
                    console.log('Loaded from WordPress:', scheduled.length, 'events');
                    renderSchedule();
                    showToast(`Loaded ${scheduled.length} scheduled events from database`);
                }
                
                if (data.lockedWeeks) {
                    lockedWeeks = data.lockedWeeks;
                    console.log('Loaded locked weeks from WordPress:', lockedWeeks);
                    updateWeekDisplay();
                }
            } catch (error) {
                console.error('Failed to load from WordPress:', error);
                showToast('Warning: Failed to load from database');
            }
        }
        
        function clearSchedule() {
            if (confirm('Clear all scheduled events? This cannot be undone.')) {
                scheduled = [];
                renderSchedule();
                saveToWordPress();
                showToast('Schedule cleared');
            }
        }

        // ============================================
        // IMPORT FROM DATABASE
        // ============================================
        
        async function importFromSupabase() {
            try {
                const [movies, events] = await Promise.all([
                    supabase.from('movies').select('*').order('updated_at', { ascending: false }),
                    supabase.from('events').select('*').order('updated_at', { ascending: false })
                ]);

                library = [];
                
                if (movies.data) {
                    movies.data.forEach(m => {
                        if (!m.title) return;
                        library.push({
                            id: `movie-${m.id}`,
                            title: m.title,
                            duration: parseInt(m.runtime_minutes) || 120,
                            type: 'movie',
                            supabaseId: m.id,
                            table: 'movies',
                            updatedAt: m.updated_at || m.created_at
                        });
                    });
                }
                
                if (events.data) {
                    events.data.forEach(e => {
                        if (!e.event_name) return;
                        library.push({
                            id: `event-${e.id}`,
                            title: e.event_name,
                            duration: parseInt(e.duration_minutes) || 120,
                            type: 'event',
                            supabaseId: e.id,
                            table: 'events',
                            updatedAt: e.updated_at || e.created_at
                        });
                    });
                }

                renderLibrary();
                showToast(`Loaded ${library.length} items from database`);
            } catch (error) {
                console.error('Import error:', error);
                showToast('Failed to load from database');
            }
        }

        // ============================================
        // LIBRARY RENDERING - FIXED FOR SPECIAL CHARS
        // ============================================
        
        function renderLibrary() {
            const container = document.getElementById('library');
            const search = document.getElementById('search').value.toLowerCase();
            const recentFilter = document.getElementById('recentFilter').value;
            
            let filtered = library.filter(item => 
                item.title.toLowerCase().includes(search)
            );
            
            if (recentFilter !== 'all') {
                const daysAgo = parseInt(recentFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                
                filtered = filtered.filter(item => {
                    if (!item.updatedAt) return true;
                    const itemDate = new Date(item.updatedAt);
                    return itemDate >= cutoffDate;
                });
            }

            document.getElementById('libCount').textContent = `(${filtered.length})`;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div>No items found</div>
                    </div>
                `;
                return;
            }

            // FIXED: Use cache instead of JSON in HTML attributes
            container.innerHTML = filtered.map((item, index) => {
                window.libraryItemsCache[index] = item;
                
                return `
                    <div class="library-item ${item.type}" draggable="true" data-item-index="${index}">
                        <div class="library-item-title">${item.title}</div>
                        <div class="library-item-info">${formatDuration(item.duration)} ¬∑ ${item.type}</div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.library-item').forEach(el => {
                el.addEventListener('dragstart', e => {
                    const index = parseInt(e.target.dataset.itemIndex);
                    draggedItem = window.libraryItemsCache[index];
                    dragOffset = 0;
                    e.dataTransfer.effectAllowed = 'move';
                    console.log('Dragging:', draggedItem.title);
                });
                
                el.addEventListener('dragend', () => {
                    document.querySelectorAll('.drag-preview').forEach(p => p.remove());
                });
            });
        }

        document.getElementById('search').oninput = renderLibrary;
        document.getElementById('recentFilter').onchange = renderLibrary;

        // ============================================
        // UTILITIES
        // ============================================
        
        function formatDuration(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // SCHEDULE RENDERING
        // ============================================
        
        function renderSchedule() {
            const container = document.getElementById('schedule');
            const days = ['Friday', 'Saturday', 'Sunday', 'Monday'];
            const isLocked = isCurrentWeekLocked();
            
            let html = '';
            for (let i = 0; i < 4; i++) {
                const date = new Date(currentWeek);
                date.setDate(date.getDate() + i);
                
                html += `
                    <div class="day-column">
                        <div class="day-header">${days[i].substr(0,3)} ${date.getMonth()+1}/${date.getDate()}</div>
                        <div class="theaters">
                            ${[1, 2].map(theater => `
                                <div class="theater">
                                    <div class="theater-header">T${theater}</div>
                                    <div class="theater-grid" data-day="${i}" data-theater="${theater}" ${isLocked ? 'style="opacity: 0.7;"' : ''}>
                                        ${Array.from({length: 12}, (_, hour) => {
                                            const displayHour = (hour + 12) > 12 ? (hour + 12) - 12 : (hour + 12);
                                            const period = (hour + 12) >= 12 ? 'PM' : 'AM';
                                            return `
                                            <div class="time-slot">
                                                ${theater === 1 ? 
                                                    `<div class="time-label">${displayHour}${period}</div>` 
                                                    : ''}
                                            </div>
                                        `;}).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Only enable drag/drop if week is NOT locked
            if (!isLocked) {
                document.querySelectorAll('.theater-grid').forEach(grid => {
                    grid.addEventListener('dragover', handleDragOver);
                    grid.addEventListener('dragleave', handleDragLeave);
                    grid.addEventListener('drop', handleDrop);
                });
            }
            
            renderScheduledEvents();
        }

        // ============================================
        // DRAG & DROP
        // ============================================
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            document.querySelectorAll('.drag-preview').forEach(p => p.remove());
            
            const rect = this.getBoundingClientRect();
            let y = e.clientY - rect.top;
            
            if (dragOffset > 0) {
                y = y - dragOffset;
            }
            
            const snappedY = Math.round(y / 20) * 20;
            
            const preview = document.createElement('div');
            preview.className = 'drag-preview';
            this.appendChild(preview);
            
            const hour = Math.floor(snappedY / 80) + 12;
            const min = Math.round((snappedY % 80) / 80 * 60);
            const displayHour = hour > 12 ? hour - 12 : hour;
            const period = hour >= 12 ? 'PM' : 'AM';
            
            preview.textContent = `${displayHour}:${min.toString().padStart(2,'0')} ${period}`;
            preview.style.top = `${snappedY}px`;
        }

        function handleDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                document.querySelectorAll('.drag-preview').forEach(p => p.remove());
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            // Check if week is locked
            if (isCurrentWeekLocked()) {
                showToast('Week is locked! Unlock it first to make changes.');
                document.querySelectorAll('.drag-preview').forEach(p => p.remove());
                return;
            }
            
            document.querySelectorAll('.drag-preview').forEach(p => p.remove());
            
            if (!draggedItem) {
                console.error('No dragged item');
                return;
            }
            
            // Validate dragged item
            if (!draggedItem.title || !draggedItem.duration) {
                console.error('Invalid dragged item:', draggedItem);
                showToast('Error: Invalid event data');
                return;
            }
            
            try {
                const rect = this.getBoundingClientRect();
                let y = e.clientY - rect.top;
                
                if (dragOffset > 0) {
                    y = y - dragOffset;
                }
                
                const snappedY = Math.round(y / 20) * 20;
                
                const day = parseInt(this.dataset.day);
                const theater = parseInt(this.dataset.theater);
                const hour = Math.floor(snappedY / 80) + 12;
                const min = Math.round((snappedY % 80) / 80 * 60);
                
                const date = new Date(currentWeek);
                date.setDate(date.getDate() + day);
                date.setHours(hour, min, 0, 0);
                
                if (draggedItem.fromSchedule && draggedItem.scheduleId) {
                    const index = scheduled.findIndex(e => e.scheduleId === draggedItem.scheduleId);
                    if (index !== -1) {
                        scheduled.splice(index, 1);
                    }
                }
                
                scheduled.push({
                    ...draggedItem,
                    day,
                    theater,
                    startTime: date,
                    position: snappedY,
                    scheduleId: `sched-${Date.now()}`,
                    fromSchedule: false
                });
                
                dragOffset = 0;
                
                renderSchedule();
                saveToWordPress();
                showToast(`${draggedItem.fromSchedule ? 'Moved' : 'Scheduled'}: ${draggedItem.title}`);
                
            } catch (error) {
                console.error('Drop error:', error);
                showToast('Error scheduling event');
            }
        }

        // ============================================
        // RENDER SCHEDULED EVENTS
        // ============================================
        
        function renderScheduledEvents() {
            const weekStart = new Date(currentWeek);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(currentWeek);
            weekEnd.setDate(weekEnd.getDate() + 3);
            weekEnd.setHours(23, 59, 59, 999);
            
            const isLocked = isCurrentWeekLocked();
            
            scheduled.forEach((event) => {
                const eventDate = new Date(event.startTime);
                
                if (eventDate < weekStart || eventDate > weekEnd) {
                    return;
                }
                
                const eventDayStart = new Date(eventDate);
                eventDayStart.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((eventDayStart - weekStart) / (1000 * 60 * 60 * 24));
                
                const grid = document.querySelector(`[data-day="${daysDiff}"][data-theater="${event.theater}"]`);
                if (!grid) return;
                
                const block = document.createElement('div');
                block.className = `event-block ${event.type === 'movie' ? `movie-t${event.theater}` : 'event'}`;
                block.style.top = `${event.position}px`;
                block.style.height = `${event.duration * 80 / 60}px`;
                
                // Only make draggable if week is NOT locked
                if (!isLocked) {
                    block.draggable = true;
                }
                
                const hour = eventDate.getHours();
                const min = eventDate.getMinutes();
                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                const period = hour >= 12 ? 'PM' : 'AM';
                
                block.innerHTML = `
                    <div class="event-title">${event.title}</div>
                    <div class="event-time">${displayHour}:${min.toString().padStart(2,'0')} ${period} ¬∑ ${formatDuration(event.duration)}</div>
                    ${!isLocked ? '<button class="delete-btn">√ó</button>' : ''}
                `;
                
                if (!isLocked) {
                    block.addEventListener('dragstart', e => {
                        const rect = block.getBoundingClientRect();
                        dragOffset = e.clientY - rect.top;
                        draggedItem = { ...event, fromSchedule: true, scheduleId: event.scheduleId };
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    
                    block.addEventListener('dragend', () => {
                        document.querySelectorAll('.drag-preview').forEach(p => p.remove());
                    });
                    
                    const deleteBtn = block.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteEvent(event.scheduleId);
                        });
                    }
                }
                
                grid.appendChild(block);
            });
        }

        // ============================================
        // DELETE EVENT
        // ============================================
        
        function deleteEvent(scheduleId) {
            // Check if week is locked
            if (isCurrentWeekLocked()) {
                showToast('Week is locked! Unlock it first to delete events.');
                return;
            }
            
            const index = scheduled.findIndex(e => e.scheduleId === scheduleId);
            if (index === -1) return;
            
            const event = scheduled[index];
            if (confirm(`Delete ${event.title}?`)) {
                scheduled.splice(index, 1);
                renderSchedule();
                saveToWordPress();
                showToast('Event deleted');
            }
        }

        // ============================================
        // GOOGLE CALENDAR PUSH
        // ============================================

        document.getElementById('pushBtn').onclick = async () => {
            if (!accessToken) {
                showToast('Please connect to Google first');
                return;
            }
            
            if (scheduled.length === 0) {
                showToast('No events to push');
                return;
            }
            
            // DISABLE BUTTON DURING PUSH
            const pushBtn = document.getElementById('pushBtn');
            pushBtn.disabled = true;
            pushBtn.textContent = 'Pushing...';
            
            showToast(`Pushing ${scheduled.length} events to Google Calendar...`);
            
            try {
                let created = 0;
                let skipped = 0;
                let errors = 0;
                
                for (const event of scheduled) {
                    try {
                        let calendarId;
                        if (event.type === 'movie') {
                            calendarId = event.theater === 1 ? CALENDARS['theater-1'] : CALENDARS['theater-2'];
                        } else {
                            calendarId = CALENDARS['events'];
                        }
                        
                        const startTime = new Date(event.startTime);
                        const endTime = new Date(startTime.getTime() + (event.duration * 60000));
                        
                        const googleEvent = {
                            summary: event.title,
                            start: {
                                dateTime: startTime.toISOString(),
                                timeZone: 'America/New_York'
                            },
                            end: {
                                dateTime: endTime.toISOString(),
                                timeZone: 'America/New_York'
                            },
                            extendedProperties: {
                                private: {
                                    supabaseId: event.supabaseId || '',
                                    supabaseTable: event.table || '',
                                    scheduleId: event.scheduleId || ''
                                }
                            }
                        };
                        
                        let shouldSkip = false;
                        
                        // Check if we have a saved googleEventId
                        if (event.googleEventId) {
                            try {
                                const checkResponse = await gapi.client.calendar.events.get({
                                    calendarId: calendarId,
                                    eventId: event.googleEventId
                                });
                                if (checkResponse.status === 200) {
                                    shouldSkip = true;
                                    console.log(`Skipping: ${event.title} (already in Google)`);
                                }
                            } catch (e) {
                                console.log('Saved event ID not found, will search for duplicates');
                            }
                        }
                        
                        // If no saved ID, search for duplicate by title + time
                        if (!shouldSkip && !event.googleEventId) {
                            try {
                                const searchResponse = await gapi.client.calendar.events.list({
                                    calendarId: calendarId,
                                    timeMin: startTime.toISOString(),
                                    timeMax: endTime.toISOString(),
                                    q: event.title,
                                    singleEvents: true
                                });
                                
                                if (searchResponse.result.items && searchResponse.result.items.length > 0) {
                                    const match = searchResponse.result.items.find(item => 
                                        item.summary === event.title &&
                                        item.start.dateTime === startTime.toISOString()
                                    );
                                    
                                    if (match) {
                                        shouldSkip = true;
                                        
                                        // Save the ID so we don't search next time
                                        const idx = scheduled.findIndex(e => e.scheduleId === event.scheduleId);
                                        if (idx !== -1) {
                                            scheduled[idx].googleEventId = match.id;
                                        }
                                        
                                        console.log(`Skipping: ${event.title} (duplicate found in Google)`);
                                    }
                                }
                            } catch (e) {
                                console.log('Search failed, will create new event');
                            }
                        }
                        
                        if (shouldSkip) {
                            skipped++;
                        } else {
                            // CREATE new event
                            const response = await gapi.client.calendar.events.insert({
                                calendarId: calendarId,
                                resource: googleEvent
                            });
                            
                            const idx = scheduled.findIndex(e => e.scheduleId === event.scheduleId);
                            if (idx !== -1) {
                                scheduled[idx].googleEventId = response.result.id;
                            }
                            
                            created++;
                            console.log(`Created: ${event.title}`);
                        }
                        
                    } catch (error) {
                        console.error(`Failed to push ${event.title}:`, error);
                        errors++;
                    }
                }
                
                saveToWordPress();
                
                // Always lock week after push (regardless of outcome)
                lockCurrentWeek();
                
                // RE-ENABLE BUTTON
                pushBtn.disabled = false;
                pushBtn.textContent = 'Push to Google';
                
                if (errors === 0 && created > 0) {
                    showToast(`Pushed: ${created} created, ${skipped} skipped - Week locked`);
                } else if (errors === 0) {
                    showToast(`All events in Google: ${skipped} skipped - Week locked`);
                } else {
                    showToast(`Pushed: ${created} created, ${skipped} skipped, ${errors} failed - Week locked`);
                }
                
            } catch (error) {
                console.error('Push error:', error);
                
                // NEW: Lock week even on catastrophic failure
                lockCurrentWeek();
                showToast('Failed to push to Google Calendar - Week locked anyway');
                
                // RE-ENABLE BUTTON
                pushBtn.disabled = false;
                pushBtn.textContent = 'Push to Google';
            }
        };

        // ============================================
        // START THE APP
        // ============================================
        
        setWeek(0);
        loadFromWordPress(); // Load events and locked weeks from WordPress
        importFromSupabase(); // Auto-import library on startup
        
        document.getElementById('clearBtn').onclick = clearSchedule;
        
        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.onload = initGoogleAPI;
        document.head.appendChild(gapiScript);
        
        const gsiScript = document.createElement('script');
        gsiScript.src = 'https://accounts.google.com/gsi/client';
        gsiScript.onload = () => {
            setTimeout(() => {
                initOAuth();
            }, 1000);
        };
        document.head.appendChild(gsiScript);
    </script>
</body>
</html>
