<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Scheduler v3.0 - FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version {
            font-size: 12px;
            background: #34c759;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.draft {
            background: #fff3cd;
            color: #856404;
        }

        .status.published {
            background: #d4edda;
            color: #155724;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0051d5;
        }

        .btn-secondary {
            background: #f0f0f2;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e0e0e2;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30a852;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .btn-warning:hover {
            background: #e68600;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Controls */
        .controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-display {
            font-size: 16px;
            font-weight: 500;
            min-width: 350px;
            text-align: center;
        }

        .control-actions {
            display: flex;
            gap: 10px;
        }

        /* Main Layout */
        .main {
            display: flex;
            gap: 20px;
        }

        /* Library Panel */
        .library {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 220px);
            display: flex;
            flex-direction: column;
        }

        .library-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-count {
            font-size: 14px;
            color: #86868b;
            font-weight: normal;
        }

        .library-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .library-items {
            flex: 1;
            overflow-y: auto;
        }

        .library-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: move;
            background: #f0f0f2;
            transition: all 0.2s;
            user-select: none;
            border-left: 4px solid transparent;
        }

        .library-item.movie {
            border-left-color: #007aff;
            background: #e8f4ff;
        }

        .library-item.event {
            border-left-color: #e74c43;
            background: #ffe8e6;
        }

        .library-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .library-item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .library-item-info {
            font-size: 12px;
            color: #86868b;
        }

        /* Schedule Grid */
        .schedule {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .days-grid {
            display: flex;
            gap: 4px;
            position: relative;
            padding-left: 60px;
        }

        .day-column {
            flex: 1;
            min-width: 310px;
        }

        .day-header {
            background: #f0f0f2;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            margin-bottom: 2px;
        }

        .theaters {
            display: flex;
            gap: 2px;
        }

        .theater {
            flex: 1;
            position: relative;
            background: #fafafa;
            border-radius: 0 0 8px 8px;
        }

        .theater-header {
            background: #e8e8e8;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .theater-grid {
            position: relative;
            height: 960px;
            border-left: 1px solid #e0e0e0;
        }

        .time-slot {
            height: 80px;
            border-bottom: 1px solid #e8e8e8;
            position: relative;
        }

        .time-label {
            position: absolute;
            left: -65px;
            width: 55px;
            text-align: right;
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
            top: -10px;
            padding-right: 8px;
        }

        /* Event Blocks */
        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 8px;
            border-radius: 6px;
            cursor: move;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }

        .event-block * {
            pointer-events: none;
            user-select: none;
        }

        .event-block.movie-t1 {
            background: #a5dceb;
        }

        .event-block.movie-t2 {
            background: #4bc4a5;
        }

        .event-block.event-t1 {
            background: #ff9999;
        }

        .event-block.event-t2 {
            background: #e74c43;
            color: white;
        }

        .event-block:hover .delete-btn {
            opacity: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.8;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            line-height: 1;
            pointer-events: auto !important;
        }

        .delete-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        /* Drag Preview - IMPROVED */
        .drag-preview {
            position: absolute;
            left: 4px;
            right: 4px;
            background: rgba(0,122,255,0.3);
            border: 3px dashed #007aff;
            border-radius: 6px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #007aff;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }

        .drag-preview.movie-preview {
            background: rgba(0,122,255,0.25);
            border-color: #007aff;
        }

        .drag-preview.event-preview {
            background: rgba(231,76,67,0.25);
            border-color: #e74c43;
            color: #e74c43;
        }

        .drag-preview-time {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .drag-preview-title {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            padding: 0 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .drag-preview-duration {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1d1d1f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>
                    TSL Scheduler
                    <span class="version">v3.0</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="status draft" id="statusBadge">DRAFT</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="week-nav">
                <button class="btn btn-secondary" id="prevWeek">Prev</button>
                <div class="week-display" id="weekDisplay">Loading...</div>
                <button class="btn btn-secondary" id="nextWeek">Next</button>
            </div>
            <div class="control-actions">
                <button class="btn btn-primary" id="refreshBtn">Refresh Library</button>
                <button class="btn btn-warning" id="saveDraftBtn">Save Draft</button>
                <button class="btn btn-success" id="publishBtn">Publish Schedule</button>
                <button class="btn btn-secondary" id="clearBtn">Clear Schedule</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Library -->
            <div class="library">
                <div class="library-header">
                    <span>Library</span>
                    <span class="library-count" id="libCount">(0)</span>
                </div>
                <select class="library-search" id="recentFilter" style="margin-bottom: 10px;">
                    <option value="all">All Items</option>
                    <option value="30" selected>Recent (30 days)</option>
                    <option value="7">This Week (7 days)</option>
                    <option value="1">Today</option>
                </select>
                <input type="text" class="library-search" id="search" placeholder="Search...">
                <div class="library-items" id="library">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <div>Click "Refresh Library" to import from Supabase</div>
                    </div>
                </div>
            </div>

            <!-- Schedule -->
            <div class="schedule">
                <div class="days-grid" id="schedule"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
// ==========================================
// CONFIGURATION - UPDATE THESE VALUES!
// ==========================================

const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';  // Get from Supabase dashboard
const SUPABASE_KEY = 'YOUR_SUPABASE_KEY_HERE';  // Get from Supabase dashboard
const WORDPRESS_URL = 'https://new.site.sesmultimedia.com';

let supabase = null;
let currentWeek = new Date();
let library = [];
let scheduled = [];
let draggedItem = null;
let weekStatuses = {};
window.libraryItemsCache = {};

// ==========================================
// INITIALIZATION
// ==========================================
async function init() {
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const today = new Date();
        const dayOfWeek = today.getDay();
        const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
        currentWeek = new Date(today);
        currentWeek.setDate(today.getDate() + daysUntilFriday);
        currentWeek.setHours(0, 0, 0, 0);

        await loadFromWordPress();
        await importFromSupabase();
        updateWeekDisplay();
        updateStatusBadge();
        renderSchedule();
    } catch (error) {
        console.error('Init error:', error);
        showToast('Initialization error - check console');
    }
}

// ==========================================
// WEEK MANAGEMENT
// ==========================================
function getWeekKey() {
    const friday = new Date(currentWeek);
    friday.setHours(0, 0, 0, 0);
    return friday.toISOString().split('T')[0];
}

function getCurrentWeekStatus() {
    const key = getWeekKey();
    return weekStatuses[key] || 'draft';
}

function setCurrentWeekStatus(status) {
    const key = getWeekKey();
    weekStatuses[key] = status;
}

function prevWeek() {
    currentWeek.setDate(currentWeek.getDate() - 7);
    updateWeekDisplay();
    updateStatusBadge();
    renderSchedule();
}

function nextWeek() {
    currentWeek.setDate(currentWeek.getDate() + 7);
    updateWeekDisplay();
    updateStatusBadge();
    renderSchedule();
}

function updateWeekDisplay() {
    const friday = new Date(currentWeek);
    const monday = new Date(currentWeek);
    monday.setDate(friday.getDate() + 3);

    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    const weekEl = document.getElementById('weekDisplay');
    if (weekEl) {
        weekEl.textContent = `${friday.toLocaleDateString('en-US', options)} - ${monday.toLocaleDateString('en-US', options)}`;
    }
}

function updateStatusBadge() {
    const status = getCurrentWeekStatus();
    const badge = document.getElementById('statusBadge');

    if (badge) {
        badge.textContent = status === 'published' ? 'PUBLISHED' : 'DRAFT';
        badge.className = 'status ' + (status === 'published' ? 'published' : 'draft');
    }
}

// ==========================================
// SAVE DRAFT
// ==========================================
async function saveDraft() {
    try {
        const validatedEvents = await validateEvents(scheduled);

        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                events: validatedEvents,
                weekStatuses: weekStatuses
            })
        });

        const data = await response.json();

        if (data.success) {
            scheduled = validatedEvents;
            setCurrentWeekStatus('draft');
            updateStatusBadge();

            if (data.stats && data.stats.orphaned_removed > 0) {
                showToast(`Draft saved! (${data.stats.orphaned_removed} orphaned events removed)`);
            } else {
                showToast('Draft saved!');
            }

            renderSchedule();
        } else {
            showToast('Failed to save draft');
        }
    } catch (error) {
        console.error('Save error:', error);
        showToast('Error saving draft');
    }
}

// ==========================================
// PUBLISH SCHEDULE
// ==========================================
async function publishSchedule() {
    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const currentWeekEvents = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate >= weekStart && eventDate <= weekEnd;
    });

    if (currentWeekEvents.length === 0) {
        showToast('Nothing to publish for this week!');
        return;
    }

    const validatedEvents = await validateEvents(currentWeekEvents);

    if (validatedEvents.length === 0) {
        showToast('No valid events to publish! All events missing WordPress posts.');
        return;
    }

    if (validatedEvents.length < currentWeekEvents.length) {
        const orphanCount = currentWeekEvents.length - validatedEvents.length;
        if (!confirm(`${orphanCount} events don't have WordPress posts and will be skipped. Continue?`)) {
            return;
        }
    }

    if (!confirm(`Publish ${validatedEvents.length} events for this week? This will create WooCommerce ticket products.`)) {
        return;
    }

    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                events: validatedEvents,
                weekKey: getWeekKey()
            })
        });

        const data = await response.json();

        if (data.success) {
            setCurrentWeekStatus('published');
            updateStatusBadge();

            let message = 'Schedule published!';
            if (data.stats) {
                message += ` (${data.stats.events_published} events, ${data.stats.posts_updated} posts updated)`;
            }
            showToast(message);

            renderSchedule();
        } else {
            showToast('Failed to publish schedule');
        }
    } catch (error) {
        console.error('Publish error:', error);
        showToast('Error publishing schedule');
    }
}

// ==========================================
// LOAD FROM WORDPRESS
// ==========================================
async function loadFromWordPress() {
    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/load`);
        const data = await response.json();

        if (data.success) {
            if (Array.isArray(data.events)) {
                scheduled = data.events;
            } else if (data.events && typeof data.events === 'object') {
                scheduled = Object.values(data.events);
            } else {
                scheduled = [];
            }

            if (data.weekStatuses && typeof data.weekStatuses === 'object') {
                weekStatuses = data.weekStatuses;
            } else {
                weekStatuses = {};
            }

            scheduled.forEach(event => {
                if (event.startTime && typeof event.startTime === 'string') {
                    event.startTime = new Date(event.startTime);
                }

                if (event.actualDate && event.actualDate.includes('T')) {
                    const oldDate = new Date(event.actualDate);
                    const year = oldDate.getFullYear();
                    const month = String(oldDate.getMonth() + 1).padStart(2, '0');
                    const day = String(oldDate.getDate()).padStart(2, '0');
                    const hours = String(oldDate.getHours()).padStart(2, '0');
                    const minutes = String(oldDate.getMinutes()).padStart(2, '0');
                    event.actualDate = `${year}-${month}-${day} ${hours}:${minutes}:00`;
                }
            });

            const beforeCount = scheduled.length;
            scheduled = scheduled.filter(event => {
                return event.supabaseId && (event.startTime || event.actualDate);
            });
            const removedCount = beforeCount - scheduled.length;

            if (removedCount > 0) {
                console.log(`Removed ${removedCount} invalid events on load`);
            }

            updateStatusBadge();
            renderSchedule();
        } else {
            scheduled = [];
            weekStatuses = {};
            updateStatusBadge();
        }
    } catch (error) {
        console.error('Load error:', error);
        scheduled = [];
        weekStatuses = {};
        updateStatusBadge();
    }
}

// ==========================================
// CLEAR SCHEDULE
// ==========================================
function clearSchedule() {
    if (!confirm('Clear this week\'s schedule? This cannot be undone.')) {
        return;
    }

    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const beforeCount = scheduled.length;

    scheduled = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate < weekStart || eventDate > weekEnd;
    });

    const clearedCount = beforeCount - scheduled.length;

    setCurrentWeekStatus('draft');
    renderSchedule();
    saveDraft();

    showToast(`Cleared ${clearedCount} event(s) from this week`);
}

// ==========================================
// DELETE EVENT
// ==========================================
function deleteEvent(scheduleId) {
    const index = scheduled.findIndex(e => e.scheduleId === scheduleId);

    if (index === -1) {
        showToast('Event not found');
        return;
    }

    const event = scheduled[index];

    if (confirm(`Delete ${event.title}?`)) {
        scheduled.splice(index, 1);
        renderSchedule();
        saveDraft();
        showToast('Event deleted');
    }
}

// ==========================================
// VALIDATION FUNCTIONS
// ==========================================
async function validateEvents(events) {
    const validEvents = [];
    const supabaseIds = [...new Set(events.map(e => e.supabaseId).filter(id => id))];
    const existingPosts = await checkPostsExist(supabaseIds);

    for (const event of events) {
        const supabaseId = event.supabaseId;

        if (!supabaseId) {
            console.warn('Event missing supabaseId:', event.title);
            continue;
        }

        if (existingPosts.has(supabaseId)) {
            validEvents.push(event);
        } else {
            console.warn(`Event ${event.title} (${supabaseId}) has no WordPress post`);
        }
    }

    return validEvents;
}

async function checkPostsExist(supabaseIds) {
    if (supabaseIds.length === 0) {
        return new Set();
    }

    const existingSet = new Set();

    for (const id of supabaseIds) {
        if (window.libraryItemsCache && window.libraryItemsCache[id]) {
            existingSet.add(id);
        }
    }

    return existingSet;
}

// ==========================================
// MANUAL CLEANUP
// ==========================================
async function manualCleanup() {
    if (!confirm('Clean up all orphaned events? This will remove events that don\'t have WordPress posts.')) {
        return;
    }

    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/cleanup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success && data.stats) {
            showToast(`Cleanup complete! Removed ${data.stats.removed} orphaned event(s)`);
            await loadFromWordPress();
        } else {
            showToast('Cleanup failed');
        }
    } catch (error) {
        console.error('Cleanup error:', error);
        showToast('Error during cleanup');
    }
}

// ==========================================
// SUPABASE IMPORT - VERIFIED EXACT SCHEMA
// ==========================================
async function importFromSupabase() {
    try {
        showToast('Importing from Supabase...');

        // âœ… MOVIES TABLE - VERIFIED SCHEMA
        // Table: movies (lowercase)
        // Fields: id, title, director, runtime_minutes, release_year
        // Filter: None - import all
        const { data: movies, error: moviesError } = await supabase
            .from('movies')
            .select('*')
            .order('title');

        // âœ… EVENTS TABLE - VERIFIED SCHEMA
        // Table: events (lowercase)
        // Fields: id, event_name, presented_by, duration_minutes, event_status, show_on_events_list
        // Filter: show_on_events_list = true
        const { data: events, error: eventsError } = await supabase
            .from('events')
            .select('*')
            .eq('show_on_events_list', true)
            .order('event_name');

        if (moviesError) throw moviesError;
        if (eventsError) throw eventsError;

        library = [];

        // Process movies - USE EXACT FIELD NAMES
        if (movies) {
            movies.forEach(movie => {
                const minutes = movie.runtime_minutes || 120;

                window.libraryItemsCache[movie.id] = {
                    id: movie.id,
                    title: movie.title || 'Untitled Movie',
                    duration: minutes,
                    type: 'movie',
                    supabaseId: movie.id,
                    table: 'movies'
                };

                library.push(window.libraryItemsCache[movie.id]);
            });
        }

        // Process events - USE EXACT FIELD NAMES
        if (events) {
            events.forEach(event => {
                const minutes = event.duration_minutes || 120;

                window.libraryItemsCache[event.id] = {
                    id: event.id,
                    title: event.event_name || 'Untitled Event',
                    duration: minutes,
                    type: 'event',
                    supabaseId: event.id,
                    table: 'events'
                };

                library.push(window.libraryItemsCache[event.id]);
            });
        }

        renderLibrary();

        const movieCount = movies ? movies.length : 0;
        const eventCount = events ? events.length : 0;
        showToast(`Library imported! ${movieCount} movies, ${eventCount} events`);
    } catch (error) {
        console.error('Import error:', error);
        showToast('Error importing from Supabase: ' + error.message);
    }
}

// ==========================================
// LIBRARY RENDERING
// ==========================================
function renderLibrary() {
    const container = document.getElementById('library');
    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('recentFilter');
    const countEl = document.getElementById('libCount');

    if (!container) return;

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const daysFilter = filterSelect ? filterSelect.value : 'all';

    let filtered = library;

    if (searchTerm) {
        filtered = filtered.filter(item =>
            item.title.toLowerCase().includes(searchTerm)
        );
    }

    if (countEl) {
        countEl.textContent = `(${filtered.length})`;
    }

    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“š</div>
                <div>No items found</div>
            </div>
        `;
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = `library-item ${item.type}`;
        div.draggable = true;
        div.innerHTML = `
            <div class="library-item-title">${item.title}</div>
            <div class="library-item-info">${item.duration}min â€¢ ${item.type}</div>
        `;

        div.addEventListener('dragstart', e => {
            draggedItem = { ...item, fromSchedule: false };
            e.dataTransfer.effectAllowed = 'copy';
        });

        container.appendChild(div);
    });
}

// ==========================================
// SCHEDULE RENDERING
// ==========================================
function renderSchedule() {
    const scheduleContainer = document.getElementById('schedule');
    if (!scheduleContainer) return;

    if (!scheduleContainer.querySelector('.day-column')) {
        buildScheduleGrid(scheduleContainer);
    }

    renderScheduledEvents();
}

function buildScheduleGrid(container) {
    const days = ['Friday', 'Saturday', 'Sunday', 'Monday'];
    container.innerHTML = '';

    days.forEach((day, dayIndex) => {
        const dayCol = document.createElement('div');
        dayCol.className = 'day-column';

        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        dayCol.appendChild(header);

        const theaters = document.createElement('div');
        theaters.className = 'theaters';

        for (let theater = 1; theater <= 2; theater++) {
            const theaterDiv = document.createElement('div');
            theaterDiv.className = 'theater';

            const theaterHeader = document.createElement('div');
            theaterHeader.className = 'theater-header';
            theaterHeader.textContent = `Theater ${theater}`;
            theaterDiv.appendChild(theaterHeader);

            const grid = document.createElement('div');
            grid.className = 'theater-grid';
            grid.dataset.day = dayIndex;
            grid.dataset.theater = theater;

            for (let hour = 12; hour <= 23; hour++) {
                const slot = document.createElement('div');
                slot.className = 'time-slot';

                if (theater === 1) {
                    const label = document.createElement('div');
                    label.className = 'time-label';
                    const displayHour = hour > 12 ? hour - 12 : hour;
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    label.textContent = `${displayHour}${ampm}`;
                    slot.appendChild(label);
                }

                grid.appendChild(slot);
            }

            setupDropZone(grid);
            theaterDiv.appendChild(grid);
            theaters.appendChild(theaterDiv);
        }

        dayCol.appendChild(theaters);
        container.appendChild(dayCol);
    });
}

function renderScheduledEvents() {
    document.querySelectorAll('.event-block').forEach(el => el.remove());

    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const currentWeekEvents = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate >= weekStart && eventDate <= weekEnd;
    });

    currentWeekEvents.forEach(event => {
        const eventDate = new Date(event.startTime);
        const friday = new Date(currentWeek);
        friday.setHours(0, 0, 0, 0);
        const dayDiff = Math.floor((eventDate - friday) / (1000 * 60 * 60 * 24));

        if (dayDiff < 0 || dayDiff > 3) return;

        const grid = document.querySelector(`.theater-grid[data-day="${dayDiff}"][data-theater="${event.theater}"]`);
        if (!grid) return;

        const hours = eventDate.getHours();
        const minutes = eventDate.getMinutes();
        const topPos = ((hours - 12) * 80) + (minutes / 60 * 80);

        const div = document.createElement('div');
        div.className = `event-block ${event.type}-t${event.theater}`;
        div.draggable = true;
        div.style.top = topPos + 'px';
        div.style.height = (event.duration * 80 / 60) + 'px';

        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        const timeStr = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;

        div.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${timeStr} â€¢ ${event.duration}min</div>
            <button class="delete-btn" onclick="deleteEvent('${event.scheduleId}')">Ã—</button>
        `;

        div.addEventListener('dragstart', e => {
            draggedItem = { ...event, fromSchedule: true, scheduleId: event.scheduleId };
            e.dataTransfer.effectAllowed = 'move';
        });

        grid.appendChild(div);
    });
}

// ==========================================
// DRAG & DROP - IMPROVED WITH BETTER SNAPPING
// ==========================================
function setupDropZone(grid) {
    grid.addEventListener('dragover', e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = draggedItem?.fromSchedule ? 'move' : 'copy';

        if (!draggedItem) return;

        const rect = grid.getBoundingClientRect();
        const y = e.clientY - rect.top;

        // IMPROVED SNAPPING: 15-minute intervals (20px = 15min since 80px = 1 hour)
        const snappedY = Math.round(y / 20) * 20;

        // Remove old preview
        grid.querySelectorAll('.drag-preview').forEach(p => p.remove());

        // Calculate time for preview
        const hour = Math.floor(snappedY / 80) + 12;
        const minute = Math.round((snappedY % 80) / 20) * 15; // 15-minute intervals

        // Format time display
        const displayHour = hour > 12 ? hour - 12 : hour;
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const timeDisplay = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;

        // Create enhanced preview - OFFSET UPWARD so cursor doesn't block view
        const preview = document.createElement('div');
        preview.className = `drag-preview ${draggedItem.type}-preview`;

        // Show preview 200px ABOVE actual drop position for visibility
        const previewOffset = 200;
        const previewY = Math.max(0, snappedY - previewOffset);
        preview.style.top = previewY + 'px';
        preview.style.height = ((draggedItem.duration || 120) * 80 / 60) + 'px';

        preview.innerHTML = `
            <div class="drag-preview-time">${timeDisplay}</div>
            <div class="drag-preview-title">${draggedItem.title}</div>
            <div class="drag-preview-duration">${draggedItem.duration}min</div>
        `;

        grid.appendChild(preview);
    });

    grid.addEventListener('dragleave', e => {
        if (e.target === grid || !grid.contains(e.relatedTarget)) {
            grid.querySelectorAll('.drag-preview').forEach(p => p.remove());
        }
    });

    grid.addEventListener('drop', e => {
        e.preventDefault();
        grid.querySelectorAll('.drag-preview').forEach(p => p.remove());

        if (!draggedItem) return;

        const rect = grid.getBoundingClientRect();
        const y = e.clientY - rect.top;

        // IMPROVED SNAPPING: Exact 15-minute intervals
        const snappedY = Math.round(y / 20) * 20;

        const day = parseInt(grid.dataset.day);
        const theater = parseInt(grid.dataset.theater);

        // Calculate hour and minute with proper 15-minute snapping
        const hour = Math.floor(snappedY / 80) + 12;
        const minute = Math.round((snappedY % 80) / 20) * 15; // 0, 15, 30, or 45

        const date = new Date(currentWeek);
        date.setDate(date.getDate() + day);
        date.setHours(hour, minute, 0, 0);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const dayOfMonth = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const localDateTime = `${year}-${month}-${dayOfMonth} ${hours}:${minutes}:00`;

        if (draggedItem.fromSchedule && draggedItem.scheduleId) {
            const index = scheduled.findIndex(e => e.scheduleId === draggedItem.scheduleId);
            if (index !== -1) scheduled.splice(index, 1);
        }

        const newEvent = {
            id: draggedItem.id,
            title: draggedItem.title,
            duration: draggedItem.duration,
            type: draggedItem.type,
            supabaseId: draggedItem.supabaseId,
            table: draggedItem.table,
            day,
            theater,
            startTime: date,
            scheduleId: `sched-${Date.now()}`,
            actualDate: localDateTime
        };

        scheduled.push(newEvent);
        renderSchedule();

        // Show confirmation with exact time
        const displayHour = hour > 12 ? hour - 12 : hour;
        const ampm = hour >= 12 ? 'PM' : 'AM';
        showToast(`Added at ${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`);

        draggedItem = null;
    });
}

// ==========================================
// TOAST NOTIFICATIONS
// ==========================================
function showToast(message) {
    const toast = document.getElementById('toast');
    if (!toast) return;

    toast.textContent = message;
    toast.style.display = 'block';

    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

// ==========================================
// EVENT LISTENERS
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    init();

    const prevBtn = document.getElementById('prevWeek');
    const nextBtn = document.getElementById('nextWeek');
    if (prevBtn) prevBtn.addEventListener('click', prevWeek);
    if (nextBtn) nextBtn.addEventListener('click', nextWeek);

    const refreshBtn = document.getElementById('refreshBtn');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const publishBtn = document.getElementById('publishBtn');
    const clearBtn = document.getElementById('clearBtn');

    if (refreshBtn) refreshBtn.addEventListener('click', importFromSupabase);
    if (saveDraftBtn) saveDraftBtn.addEventListener('click', saveDraft);
    if (publishBtn) publishBtn.addEventListener('click', publishSchedule);
    if (clearBtn) clearBtn.addEventListener('click', clearSchedule);

    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('recentFilter');

    if (searchInput) searchInput.addEventListener('input', renderLibrary);
    if (filterSelect) filterSelect.addEventListener('change', renderLibrary);
});
    </script>
</body>
</html>
