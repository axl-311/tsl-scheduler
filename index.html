<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Scheduler v3.0 - WORKING DRAG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version {
            font-size: 12px;
            background: #34c759;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.draft {
            background: #fff3cd;
            color: #856404;
        }

        .status.published {
            background: #d4edda;
            color: #155724;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0051d5;
        }

        .btn-secondary {
            background: #f0f0f2;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e0e0e2;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30a852;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .btn-warning:hover {
            background: #e68600;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-display {
            font-size: 16px;
            font-weight: 500;
            min-width: 350px;
            text-align: center;
        }

        .control-actions {
            display: flex;
            gap: 10px;
        }

        .main {
            display: flex;
            gap: 20px;
        }

        .library {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 220px);
            display: flex;
            flex-direction: column;
        }

        .library-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-count {
            font-size: 14px;
            color: #86868b;
            font-weight: normal;
        }

        .library-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .library-items {
            flex: 1;
            overflow-y: auto;
        }

        .library-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: move;
            background: #f0f0f2;
            transition: all 0.2s;
            user-select: none;
            border-left: 4px solid transparent;
        }

        .library-item.movie {
            border-left-color: #007aff;
            background: #e8f4ff;
        }

        .library-item.event {
            border-left-color: #e74c43;
            background: #ffe8e6;
        }

        .library-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .library-item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .library-item-info {
            font-size: 12px;
            color: #86868b;
        }

        .schedule {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .days-grid {
            display: flex;
            gap: 4px;
            position: relative;
            padding-left: 60px;
        }

        .day-column {
            flex: 1;
            min-width: 310px;
        }

        .day-header {
            background: #f0f0f2;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            margin-bottom: 2px;
        }

        .theaters {
            display: flex;
            gap: 2px;
        }

        .theater {
            flex: 1;
            position: relative;
            background: #fafafa;
            border-radius: 0 0 8px 8px;
        }

        .theater-header {
            background: #e8e8e8;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .theater-grid {
            position: relative;
            height: 960px;
            border-left: 1px solid #e0e0e0;
        }

        .time-slot {
            height: 80px;
            border-bottom: 1px solid #e8e8e8;
            position: relative;
        }

        .time-label {
            position: absolute;
            left: -65px;
            width: 55px;
            text-align: right;
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
            top: -10px;
            padding-right: 8px;
        }

        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 8px;
            border-radius: 6px;
            cursor: move;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }

        .event-block * {
            pointer-events: none;
            user-select: none;
        }

        .event-block.movie-t1 {
            background: #a5dceb;
        }

        .event-block.movie-t2 {
            background: #4bc4a5;
        }

        .event-block.event-t1 {
            background: #ff9999;
        }

        .event-block.event-t2 {
            background: #e74c43;
            color: white;
        }

        .event-block:hover .delete-btn {
            opacity: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.8;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            line-height: 1;
            pointer-events: auto !important;
        }

        .delete-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        .drag-preview {
            position: absolute;
            left: 4px;
            right: 4px;
            background: rgba(0,122,255,0.25);
            border: 4px dashed #007aff;
            border-radius: 8px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: #007aff;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0,122,255,0.5);
            animation: pulse 0.8s infinite;
        }

        .drag-preview.event-preview {
            background: rgba(255,50,50,0.25);
            border-color: #ff3333;
            color: #ff0000;
            box-shadow: 0 0 20px rgba(255,50,50,0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .drag-preview-time {
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 4px;
        }

        .drag-preview-title {
            font-size: 12px;
            font-weight: 600;
        }

        /* Make dragged items invisible */
        .library-item.dragging,
        .event-block.dragging,
        .library-item.dragging *,
        .event-block.dragging * {
            opacity: 0 !important;
            transition: none !important;
        }

        .dragging {
            opacity: 0 !important;
        }

        /* Hide cursor during drag */
        body.dragging-active,
        body.dragging-active *,
        body.dragging-active .theater-grid,
        body.dragging-active .day-column,
        body.dragging-active .schedule {
            cursor: none !important;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1d1d1f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Date Filter Buttons */
        .tsl-date-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
        }

        .tsl-date-btn {
            background: #2c2c2c;
            color: #ffffff;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: inherit;
        }

        .tsl-date-btn:hover {
            background: #3c3c3c;
            border-color: #007aff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .tsl-date-btn.active {
            background: #007aff;
            border-color: #007aff;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>
                    TSL Scheduler
                    <span class="version">v3.0</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="status draft" id="statusBadge">DRAFT</div>
            </div>
        </div>

        <div class="controls">
            <div class="week-nav">
                <button class="btn btn-secondary" id="prevWeek">Prev</button>
                <div class="week-display" id="weekDisplay">Loading...</div>
                <button class="btn btn-secondary" id="nextWeek">Next</button>
            </div>
            <div class="control-actions">
                <button class="btn btn-primary" id="refreshBtn">Refresh Library</button>
                <button class="btn btn-warning" id="saveDraftBtn">Save Draft</button>
                <button class="btn btn-success" id="publishBtn">Publish Schedule</button>
                <button class="btn btn-secondary" id="clearBtn">Clear Schedule</button>
            </div>
        </div>

        <div class="main">
            <div class="library">
                <div class="library-header">
                    <span>Library</span>
                    <span class="library-count" id="libCount">(0)</span>
                </div>
                <div class="tsl-date-buttons" style="margin-bottom: 15px;">
                    <button class="tsl-date-btn active" data-filter="all">All Items</button>
                    <button class="tsl-date-btn" data-filter="30">Recent (30 days)</button>
                    <button class="tsl-date-btn" data-filter="7">This Week</button>
                    <button class="tsl-date-btn" data-filter="1">Today</button>
                </div>
                <input type="text" class="library-search" id="search" placeholder="Search...">
                <div class="library-items" id="library">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <div>Click "Refresh Library"</div>
                    </div>
                </div>
            </div>

            <div class="schedule">
                <div class="days-grid" id="schedule"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
const SUPABASE_URL = 'https://tnnkfnattwpqqrydsyux.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubmtmbmF0dHdwcXFyeWRzeXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Njc3NDAsImV4cCI6MjA3MzA0Mzc0MH0.cNzStE1v6YA7HRvTeBCXxGFPuJPq1WmnuVGVaNLjOsE';
const WORDPRESS_URL = 'https://new.site.sesmultimedia.com';

let supabase = null;
let currentWeek = new Date();
let library = [];
let scheduled = [];
let draggedItem = null;
let dragOffset = 0;
let weekStatuses = {};
window.libraryItemsCache = {};

async function init() {
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const today = new Date();
        const dayOfWeek = today.getDay();
        const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
        currentWeek = new Date(today);
        currentWeek.setDate(today.getDate() + daysUntilFriday);
        currentWeek.setHours(0, 0, 0, 0);

        await loadFromWordPress();
        await importFromSupabase();
        updateWeekDisplay();
        updateStatusBadge();
        renderSchedule();
    } catch (error) {
        console.error('Init error:', error);
        showToast('Error loading');
    }
}

function getWeekKey() {
    const friday = new Date(currentWeek);
    friday.setHours(0, 0, 0, 0);
    return friday.toISOString().split('T')[0];
}

function getCurrentWeekStatus() {
    return weekStatuses[getWeekKey()] || 'draft';
}

function setCurrentWeekStatus(status) {
    weekStatuses[getWeekKey()] = status;
}

function prevWeek() {
    currentWeek.setDate(currentWeek.getDate() - 7);
    updateWeekDisplay();
    updateStatusBadge();
    renderSchedule();
}

function nextWeek() {
    currentWeek.setDate(currentWeek.getDate() + 7);
    updateWeekDisplay();
    updateStatusBadge();
    renderSchedule();
}

function updateWeekDisplay() {
    const friday = new Date(currentWeek);
    const monday = new Date(currentWeek);
    monday.setDate(friday.getDate() + 3);
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    const weekEl = document.getElementById('weekDisplay');
    if (weekEl) {
        weekEl.textContent = `${friday.toLocaleDateString('en-US', options)} - ${monday.toLocaleDateString('en-US', options)}`;
    }
}

function updateStatusBadge() {
    const status = getCurrentWeekStatus();
    const badge = document.getElementById('statusBadge');
    if (badge) {
        badge.textContent = status === 'published' ? 'PUBLISHED' : 'DRAFT';
        badge.className = 'status ' + (status === 'published' ? 'published' : 'draft');
    }
}

async function saveDraft() {
    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ events: scheduled, weekStatuses: weekStatuses })
        });
        const data = await response.json();
        if (data.success) {
            setCurrentWeekStatus('draft');
            updateStatusBadge();
            showToast('Saved!');
            renderSchedule();
        }
    } catch (error) {
        console.error('Save error:', error);
        showToast('Save failed');
    }
}

async function publishSchedule() {
    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const currentWeekEvents = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate >= weekStart && eventDate <= weekEnd;
    });

    if (currentWeekEvents.length === 0) {
        showToast('Nothing to publish!');
        return;
    }

    if (!confirm(`Publish ${currentWeekEvents.length} events?\n\nThis will:\nâœ“ Sync latest from Supabase\nâœ“ Update WordPress posts\nâœ“ Publish showtimes\nâœ“ Create WooCommerce products`)) return;

    try {
        showToast('Syncing all data...');
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/sync-all`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ events: currentWeekEvents, weekKey: getWeekKey() })
        });
        const data = await response.json();
        if (data.success) {
            setCurrentWeekStatus('published');
            updateStatusBadge();
            const stats = data.stats || {};
            showToast(`âœ“ Complete! ${stats.movies_synced || 0} movies, ${stats.events_synced || 0} events, ${stats.products_created || 0} products`);
        } else {
            showToast('Sync failed - check console');
            console.error('Sync errors:', data.stats?.errors);
        }
    } catch (error) {
        console.error('Publish error:', error);
        showToast('Publish failed');
    }
}

async function loadFromWordPress() {
    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/load`);
        const data = await response.json();
        if (data.success) {
            scheduled = Array.isArray(data.events) ? data.events : [];
            weekStatuses = data.weekStatuses || {};
            scheduled.forEach(event => {
                if (event.startTime && typeof event.startTime === 'string') {
                    event.startTime = new Date(event.startTime);
                }
            });
            updateStatusBadge();
            renderSchedule();
        }
    } catch (error) {
        console.error('Load error:', error);
    }
}

function clearSchedule() {
    if (!confirm('Clear this week?')) return;
    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    scheduled = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate < weekStart || eventDate > weekEnd;
    });

    setCurrentWeekStatus('draft');
    renderSchedule();
    saveDraft();
}

function deleteEvent(scheduleId) {
    const index = scheduled.findIndex(e => e.scheduleId === scheduleId);
    if (index === -1) return;
    if (confirm(`Delete ${scheduled[index].title}?`)) {
        scheduled.splice(index, 1);
        renderSchedule();
        saveDraft();
    }
}

async function importFromSupabase() {
    try {
        showToast('Importing...');
        const { data: movies, error: moviesError } = await supabase.from('movies').select('*').order('title');
        const { data: events, error: eventsError } = await supabase.from('events').select('*').eq('show_on_events_list', true).order('event_name');

        if (moviesError) throw moviesError;
        if (eventsError) throw eventsError;

        library = [];

        if (movies) {
            movies.forEach(movie => {
                window.libraryItemsCache[movie.id] = {
                    id: movie.id,
                    title: movie.title || 'Untitled',
                    duration: movie.runtime_minutes || 120,
                    type: 'movie',
                    supabaseId: movie.id,
                    table: 'movies'
                };
                library.push(window.libraryItemsCache[movie.id]);
            });
        }

        if (events) {
            events.forEach(event => {
                window.libraryItemsCache[event.id] = {
                    id: event.id,
                    title: event.event_name || 'Untitled',
                    duration: event.duration_minutes || 120,
                    type: 'event',
                    supabaseId: event.id,
                    table: 'events'
                };
                library.push(window.libraryItemsCache[event.id]);
            });
        }

        renderLibrary();
        showToast(`Loaded ${library.length} items`);
    } catch (error) {
        console.error('Import error:', error);
        showToast('Import failed');
    }
}

function renderLibrary() {
    const container = document.getElementById('library');
    const searchInput = document.getElementById('search');
    const countEl = document.getElementById('libCount');
    if (!container) return;

    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    let filtered = searchTerm ? library.filter(item => item.title.toLowerCase().includes(searchTerm)) : library;

    if (countEl) countEl.textContent = `(${filtered.length})`;
    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“š</div><div>No items</div></div>';
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = `library-item ${item.type}`;
        div.draggable = true;
        div.innerHTML = `<div class="library-item-title">${item.title}</div><div class="library-item-info">${item.duration}min</div>`;

        div.addEventListener('dragstart', e => {
            document.body.classList.add('dragging-active');
            e.target.style.opacity = '0';
            e.target.classList.add('dragging');

            const dragImg = document.createElement('div');
            dragImg.style.opacity = '0';
            dragImg.style.position = 'absolute';
            dragImg.style.top = '-1000px';
            document.body.appendChild(dragImg);
            e.dataTransfer.setDragImage(dragImg, 0, 0);
            setTimeout(() => dragImg.remove(), 0);

            console.log('Added dragging class:', e.target.classList.contains('dragging'));
            dragOffset = 0;
            draggedItem = { ...item, fromSchedule: false };
            e.dataTransfer.effectAllowed = 'copy';
        });

        div.addEventListener('dragend', e => {
            document.body.classList.remove('dragging-active');
            e.target.style.opacity = '';
            e.target.classList.remove('dragging');
        });

        container.appendChild(div);
    });
}

function renderSchedule() {
    const scheduleContainer = document.getElementById('schedule');
    if (!scheduleContainer) return;
    if (!scheduleContainer.querySelector('.day-column')) {
        buildScheduleGrid(scheduleContainer);
    }
    renderScheduledEvents();
}

function buildScheduleGrid(container) {
    const days = ['Friday', 'Saturday', 'Sunday', 'Monday'];
    container.innerHTML = '';

    days.forEach((day, dayIndex) => {
        const dayCol = document.createElement('div');
        dayCol.className = 'day-column';

        // Calculate actual date for this day
        const dayDate = new Date(currentWeek);
        dayDate.setDate(dayDate.getDate() + dayIndex);
        const monthName = dayDate.toLocaleDateString('en-US', { month: 'short' });
        const dayNum = dayDate.getDate();

        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = `${day}, ${monthName} ${dayNum}`;
        dayCol.appendChild(header);

        const theaters = document.createElement('div');
        theaters.className = 'theaters';

        for (let theater = 1; theater <= 2; theater++) {
            const theaterDiv = document.createElement('div');
            theaterDiv.className = 'theater';

            const theaterHeader = document.createElement('div');
            theaterHeader.className = 'theater-header';
            theaterHeader.textContent = `Theater ${theater}`;
            theaterDiv.appendChild(theaterHeader);

            const grid = document.createElement('div');
            grid.className = 'theater-grid';
            grid.dataset.day = dayIndex;
            grid.dataset.theater = theater;

            for (let hour = 12; hour <= 23; hour++) {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                if (theater === 1) {
                    const label = document.createElement('div');
                    label.className = 'time-label';
                    const displayHour = hour > 12 ? hour - 12 : hour;
                    label.textContent = `${displayHour}${hour >= 12 ? 'PM' : 'AM'}`;
                    slot.appendChild(label);
                }
                grid.appendChild(slot);
            }

            grid.addEventListener('dragover', handleDragOver);
            grid.addEventListener('dragleave', handleDragLeave);
            grid.addEventListener('drop', handleDrop);

            theaterDiv.appendChild(grid);
            theaters.appendChild(theaterDiv);
        }

        dayCol.appendChild(theaters);
        container.appendChild(dayCol);
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = draggedItem?.fromSchedule ? 'move' : 'copy';
    if (!draggedItem) return;

    document.querySelectorAll('.drag-preview').forEach(p => p.remove());

    const rect = this.getBoundingClientRect();
    let y = e.clientY - rect.top - dragOffset;

    const snappedY = Math.round(y / 20) * 20;

    const hour = Math.floor(snappedY / 80) + 12;
    const minute = Math.round((snappedY % 80) / 20) * 15;
    const displayHour = hour > 12 ? hour - 12 : hour;
    const period = hour >= 12 ? 'PM' : 'AM';

    const preview = document.createElement('div');
    preview.className = `drag-preview ${draggedItem.type}-preview`;
    preview.style.top = `${snappedY}px`;
    preview.style.height = `${(draggedItem.duration || 120) * 80 / 60}px`;
    preview.innerHTML = `
        <div class="drag-preview-time">${displayHour}:${minute.toString().padStart(2,'0')} ${period}</div>
        <div class="drag-preview-title">${draggedItem.title}</div>
    `;
    this.appendChild(preview);
}

function handleDragLeave(e) {
    if (!e.currentTarget.contains(e.relatedTarget)) {
        document.querySelectorAll('.drag-preview').forEach(p => p.remove());
    }
}

function handleDrop(e) {
    e.preventDefault();
    document.querySelectorAll('.drag-preview').forEach(p => p.remove());
    if (!draggedItem) return;

    const rect = this.getBoundingClientRect();
    let y = e.clientY - rect.top - dragOffset;
    const snappedY = Math.round(y / 20) * 20;

    const day = parseInt(this.dataset.day);
    const theater = parseInt(this.dataset.theater);
    const hour = Math.floor(snappedY / 80) + 12;
    const minute = Math.round((snappedY % 80) / 20) * 15;

    const date = new Date(currentWeek);
    date.setDate(date.getDate() + day);
    date.setHours(hour, minute, 0, 0);

    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const dayOfMonth = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    if (draggedItem.fromSchedule && draggedItem.scheduleId) {
        const index = scheduled.findIndex(e => e.scheduleId === draggedItem.scheduleId);
        if (index !== -1) scheduled.splice(index, 1);
    }

    scheduled.push({
        id: draggedItem.id,
        title: draggedItem.title,
        duration: draggedItem.duration,
        type: draggedItem.type,
        supabaseId: draggedItem.supabaseId,
        table: draggedItem.table,
        day,
        theater,
        startTime: date,
        scheduleId: `sched-${Date.now()}`,
        actualDate: `${year}-${month}-${dayOfMonth} ${hours}:${minutes}:00`
    });

    dragOffset = 0;
    renderSchedule();
    saveDraft();
}

function renderScheduledEvents() {
    document.querySelectorAll('.event-block').forEach(el => el.remove());

    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const currentWeekEvents = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate >= weekStart && eventDate <= weekEnd;
    });

    currentWeekEvents.forEach(event => {
        const eventDate = new Date(event.startTime);
        const friday = new Date(currentWeek);
        friday.setHours(0, 0, 0, 0);
        const dayDiff = Math.floor((eventDate - friday) / (1000 * 60 * 60 * 24));

        if (dayDiff < 0 || dayDiff > 3) return;

        const grid = document.querySelector(`.theater-grid[data-day="${dayDiff}"][data-theater="${event.theater}"]`);
        if (!grid) return;

        const hours = eventDate.getHours();
        const minutes = eventDate.getMinutes();
        const topPos = ((hours - 12) * 80) + (minutes / 60 * 80);

        const div = document.createElement('div');
        div.className = `event-block ${event.type}-t${event.theater}`;
        div.draggable = true;
        div.style.top = topPos + 'px';
        div.style.height = (event.duration * 80 / 60) + 'px';

        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;

        div.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm} â€¢ ${event.duration}min</div>
            <button class="delete-btn" onclick="deleteEvent('${event.scheduleId}')">Ã—</button>
        `;

        div.addEventListener('dragstart', e => {
            document.body.classList.add('dragging-active');
            e.target.style.opacity = '0';
            e.target.classList.add('dragging');

            const dragImg = document.createElement('div');
            dragImg.style.opacity = '0';
            dragImg.style.position = 'absolute';
            dragImg.style.top = '-1000px';
            document.body.appendChild(dragImg);
            e.dataTransfer.setDragImage(dragImg, 0, 0);
            setTimeout(() => dragImg.remove(), 0);

            const rect = div.getBoundingClientRect();
            dragOffset = e.clientY - rect.top;
            draggedItem = { ...event, fromSchedule: true, scheduleId: event.scheduleId };
            e.dataTransfer.effectAllowed = 'move';
        });

        div.addEventListener('dragend', (e) => {
            document.body.classList.remove('dragging-active');
            e.target.style.opacity = '';
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-preview').forEach(p => p.remove());
        });

        grid.appendChild(div);
    });
}

function showToast(message) {
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = message;
    toast.style.display = 'block';
    toast.style.cursor = 'pointer';

    // Clear any existing timeout
    if (toast.timeoutId) {
        clearTimeout(toast.timeoutId);
    }

    // Click to dismiss
    toast.onclick = () => {
        toast.style.display = 'none';
        if (toast.timeoutId) {
            clearTimeout(toast.timeoutId);
        }
    };

    // Auto-dismiss after 10 seconds
    toast.timeoutId = setTimeout(() => {
        toast.style.display = 'none';
    }, 10000);
}

document.addEventListener('DOMContentLoaded', () => {
    init();
    document.getElementById('prevWeek')?.addEventListener('click', prevWeek);
    document.getElementById('nextWeek')?.addEventListener('click', nextWeek);
    document.getElementById('refreshBtn')?.addEventListener('click', importFromSupabase);
    document.getElementById('saveDraftBtn')?.addEventListener('click', saveDraft);
    document.getElementById('publishBtn')?.addEventListener('click', publishSchedule);
    document.getElementById('clearBtn')?.addEventListener('click', clearSchedule);
    document.getElementById('search')?.addEventListener('input', renderLibrary);

    // Date filter buttons
    document.querySelectorAll('.tsl-date-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tsl-date-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLibrary();
        });
    });
});
    </script>
</body>
</html>
