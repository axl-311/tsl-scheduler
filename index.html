<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSL Scheduler 2.0 - Theater Scheduling System</title>
  <style>
    /* CSS Reset & Variables */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Colors */
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* Layout */
      --sidebar-width: 320px;
      --header-height: 60px;
      --slot-height: 24px;
      --time-width: 70px;
      --theater-width: 240px;
      
      /* Transitions */
      --transition: all 0.2s ease;
    }

    /* Base Styles */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      height: var(--header-height);
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.625rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      background: var(--success);
      color: white;
    }

    /* Buttons */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: 1px solid transparent;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      white-space: nowrap;
      background: white;
      color: var(--gray-700);
      border-color: var(--gray-300);
    }

    .btn:hover:not(:disabled) {
      background: var(--gray-50);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: white;
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
      margin-right: calc(var(--sidebar-width) * -1);
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .sidebar-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.75rem;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .sidebar-footer {
      padding: 0.75rem;
      border-top: 1px solid var(--gray-200);
      font-size: 0.75rem;
      color: var(--gray-500);
      line-height: 1.5;
    }

    /* Movie Cards */
    .movie-card {
      background: white;
      border: 2px solid var(--gray-200);
      border-left-width: 4px;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      cursor: grab;
      transition: var(--transition);
      position: relative;
    }

    .movie-card:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .movie-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .movie-title {
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }

    .movie-info {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .movie-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.25rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .movie-card:hover .movie-actions {
      opacity: 1;
    }

    .icon-btn {
      width: 24px;
      height: 24px;
      border-radius: 0.25rem;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      font-size: 0.75rem;
    }

    .icon-btn:hover {
      background: var(--gray-200);
    }

    .icon-btn.delete:hover {
      background: var(--danger);
      color: white;
    }

    /* Schedule Area */
    .schedule-container {
      flex: 1;
      overflow: auto;
      background: var(--gray-50);
      padding: 1.5rem;
    }

    .week-header {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .week-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .week-label {
      font-weight: 600;
      min-width: 200px;
      text-align: center;
    }

    /* Schedule Grid */
    .schedule-grid {
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .days-container {
      display: flex;
      overflow-x: auto;
    }

    .day-column {
      min-width: calc(var(--time-width) + 2 * var(--theater-width));
      border-right: 1px solid var(--gray-200);
    }

    .day-column:last-child {
      border-right: none;
    }

    .day-header {
      background: var(--gray-50);
      padding: 0.75rem;
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .day-header.today {
      background: var(--primary);
      color: white;
    }

    .theaters-row {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 41px;
      z-index: 9;
    }

    .time-header {
      width: var(--time-width);
      padding: 0.5rem;
      text-align: center;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-600);
      border-right: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .theater-header {
      flex: 1;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 500;
      border-right: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .theater-header:last-child {
      border-right: none;
    }

    .day-content {
      display: flex;
      position: relative;
    }

    .time-column {
      width: var(--time-width);
      border-right: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .time-slot {
      height: var(--slot-height);
      padding: 0 0.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-size: 0.6875rem;
      color: var(--gray-500);
      border-bottom: 1px solid var(--gray-100);
    }

    .time-slot.hour {
      font-weight: 600;
      color: var(--gray-700);
      border-bottom-color: var(--gray-200);
    }

    .theaters-container {
      display: flex;
      flex: 1;
    }

    .theater-lane {
      width: var(--theater-width);
      position: relative;
      border-right: 1px solid var(--gray-200);
      background-image: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent calc(var(--slot-height) - 1px),
        var(--gray-100) calc(var(--slot-height) - 1px),
        var(--gray-100) var(--slot-height)
      );
    }

    .theater-lane:last-child {
      border-right: none;
    }

    .theater-lane.drag-over {
      background-color: rgba(59, 130, 246, 0.05);
    }

    /* Schedule Blocks */
    .schedule-block {
      position: absolute;
      left: 4px;
      right: 4px;
      background: var(--primary);
      color: white;
      border-radius: 0.375rem;
      padding: 0.375rem 0.5rem;
      font-size: 0.75rem;
      cursor: grab;
      transition: var(--transition);
      z-index: 5;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .schedule-block:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      z-index: 6;
      transform: scale(1.02);
    }

    .schedule-block.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .block-title {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .block-time {
      font-size: 0.625rem;
      opacity: 0.9;
      margin-top: 0.125rem;
    }

    .block-actions {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      display: flex;
      gap: 0.125rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .schedule-block:hover .block-actions {
      opacity: 1;
    }

    .block-btn {
      width: 18px;
      height: 18px;
      border-radius: 0.25rem;
      border: none;
      background: rgba(255, 255, 255, 0.3);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      transition: var(--transition);
    }

    .block-btn:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Drop Preview */
    .drop-preview {
      position: absolute;
      left: 4px;
      right: 4px;
      background: rgba(59, 130, 246, 0.2);
      border: 2px dashed var(--primary);
      border-radius: 0.375rem;
      pointer-events: none;
      z-index: 4;
    }

    .drop-preview.conflict {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--danger);
    }

    /* Dialogs */
    .dialog {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 100;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .dialog.open {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .dialog-content {
      background: white;
      border-radius: 0.75rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .dialog-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dialog-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .dialog-close {
      width: 32px;
      height: 32px;
      border-radius: 0.375rem;
      border: none;
      background: transparent;
      color: var(--gray-400);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .dialog-close:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .dialog-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .dialog-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.375rem;
    }

    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-row {
      display: flex;
      gap: 0.75rem;
    }

    .form-row .form-group {
      flex: 1;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .toast {
      background: white;
      padding: 1rem 1.25rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.3s ease;
      min-width: 250px;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.info {
      border-left: 4px solid var(--primary);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        z-index: 50;
        height: 100%;
      }
      
      .schedule-container {
        padding: 1rem;
      }
      
      .day-column {
        min-width: calc(var(--time-width) + var(--theater-width));
      }
    }

    /* Utility Classes */
    .hidden { display: none !important; }
    .text-muted { color: var(--gray-500); }
    .text-small { font-size: 0.875rem; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-title">
      🎬 TSL Scheduler 2.0
      <span class="status-badge">✓ Ready</span>
    </div>
    <div class="header-controls">
      <button class="btn" id="toggleSidebar" title="Toggle Sidebar">☰</button>
      <button class="btn btn-primary" id="saveBtn" title="Save all changes">💾 Save</button>
      <button class="btn" id="exportBtn" title="Export Schedule">📤 Export</button>
      <button class="btn" id="importBtn" title="Import Schedule">📥 Import</button>
      <input type="file" id="importFile" accept=".json" style="display: none;">
      <button class="btn" id="settingsBtn" title="Settings">⚙️</button>
    </div>
  </header>

  <!-- Main Container -->
  <main class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Film Library</div>
        <div class="header-controls">
          <button class="btn btn-primary btn-sm" id="addMovieBtn">+ Add Film</button>
        </div>
      </div>
      <div class="sidebar-content" id="moviesList">
        <!-- Movies will be rendered here -->
      </div>
      <div class="sidebar-footer">
        <div>💡 Tips:</div>
        <div>• Drag films to schedule</div>
        <div>• Double-click to edit</div>
        <div>• Data saves automatically</div>
      </div>
    </aside>

    <!-- Schedule Container -->
    <section class="schedule-container">
      <!-- Week Header -->
      <div class="week-header">
        <div class="week-nav">
          <button class="btn" id="prevWeekBtn">‹ Previous</button>
          <div class="week-label" id="weekLabel">Loading...</div>
          <button class="btn" id="nextWeekBtn">Next ›</button>
        </div>
        <div class="header-controls">
          <button class="btn btn-success" id="todayBtn">Today</button>
          <button class="btn btn-danger" id="clearWeekBtn">Clear Week</button>
        </div>
      </div>

      <!-- Schedule Grid -->
      <div class="schedule-grid">
        <div class="days-container" id="daysContainer">
          <!-- Days will be rendered here -->
        </div>
      </div>
    </section>
  </main>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Movie Dialog -->
  <div class="dialog" id="movieDialog">
    <div class="dialog-content">
      <div class="dialog-header">
        <h2 class="dialog-title">Add/Edit Film</h2>
        <button class="dialog-close" onclick="tslApp.closeDialog('movieDialog')">✕</button>
      </div>
      <div class="dialog-body">
        <form id="movieForm">
          <div class="form-group">
            <label class="form-label" for="movieTitle">Title</label>
            <input type="text" class="form-input" id="movieTitle" placeholder="Enter film title" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="movieHours">Hours</label>
              <input type="number" class="form-input" id="movieHours" min="0" max="12" value="2">
            </div>
            <div class="form-group">
              <label class="form-label" for="movieMinutes">Minutes</label>
              <input type="number" class="form-input" id="movieMinutes" min="0" max="59" value="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="movieColor">Color</label>
            <input type="color" class="form-input" id="movieColor" value="#3b82f6">
          </div>
          <input type="hidden" id="movieId">
        </form>
      </div>
      <div class="dialog-footer">
        <button class="btn" onclick="tslApp.closeDialog('movieDialog')">Cancel</button>
        <button class="btn btn-primary" onclick="tslApp.saveMovie()">Save Film</button>
      </div>
    </div>
  </div>

  <!-- Settings Dialog -->
  <div class="dialog" id="settingsDialog">
    <div class="dialog-content">
      <div class="dialog-header">
        <h2 class="dialog-title">Settings</h2>
        <button class="dialog-close" onclick="tslApp.closeDialog('settingsDialog')">✕</button>
      </div>
      <div class="dialog-body">
        <form id="settingsForm">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="startHour">Start Hour (24h)</label>
              <input type="number" class="form-input" id="startHour" min="0" max="23" value="14">
            </div>
            <div class="form-group">
              <label class="form-label" for="endHour">End Hour (24h)</label>
              <input type="number" class="form-input" id="endHour" min="1" max="24" value="24">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="weekStart">Week Starts On</label>
            <select class="form-input" id="weekStart">
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2" selected>Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
        </form>
      </div>
      <div class="dialog-footer">
        <button class="btn" onclick="tslApp.closeDialog('settingsDialog')">Cancel</button>
        <button class="btn btn-primary" onclick="tslApp.saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <script>
    // TSL Scheduler Application - No External Dependencies
    class TSLScheduler {
      constructor() {
        this.config = {
          startHour: 14,
          endHour: 24,
          slotMinutes: 15,
          weekStartDay: 2 // Tuesday
        };
        
        this.state = {
          movies: [],
          schedules: {},
          currentWeek: null,
          draggedItem: null,
          sidebarCollapsed: false
        };
        
        this.init();
      }

      init() {
        this.loadConfig();
        this.loadMovies();
        this.setCurrentWeek(new Date());
        this.loadSchedules();
        this.bindEvents();
        this.render();
        this.showWelcome();
      }

      showWelcome() {
        if (!localStorage.getItem('tsl_welcomed_v2')) {
          setTimeout(() => {
            this.showToast('Welcome to TSL Scheduler! All data is saved locally.', 'success');
            localStorage.setItem('tsl_welcomed_v2', 'true');
          }, 1000);
        }
      }

      // Configuration Management
      loadConfig() {
        const saved = localStorage.getItem('tsl_config_v2');
        if (saved) {
          Object.assign(this.config, JSON.parse(saved));
        }
      }

      saveConfig() {
        localStorage.setItem('tsl_config_v2', JSON.stringify(this.config));
      }

      // Data Management
      loadMovies() {
        const saved = localStorage.getItem('tsl_movies_v2');
        this.state.movies = saved ? JSON.parse(saved) : [
          { id: 1, title: 'Oppenheimer', duration: 180, color: '#3b82f6' },
          { id: 2, title: 'Barbie', duration: 114, color: '#ec4899' },
          { id: 3, title: 'Dune: Part Two', duration: 166, color: '#f59e0b' },
          { id: 4, title: 'The Batman', duration: 176, color: '#6b7280' },
          { id: 5, title: 'Spider-Man: Across the Spider-Verse', duration: 140, color: '#ef4444' }
        ];
      }

      saveMovies() {
        localStorage.setItem('tsl_movies_v2', JSON.stringify(this.state.movies));
      }

      loadSchedules() {
        const key = this.getWeekKey();
        const saved = localStorage.getItem(`tsl_schedule_${key}`);
        this.state.schedules = saved ? JSON.parse(saved) : {};
      }

      saveSchedules() {
        const key = this.getWeekKey();
        localStorage.setItem(`tsl_schedule_${key}`, JSON.stringify(this.state.schedules));
      }

      // Week Management
      setCurrentWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = (day - this.config.weekStartDay + 7) % 7;
        d.setDate(d.getDate() - diff);
        d.setHours(0, 0, 0, 0);
        this.state.currentWeek = d;
      }

      getWeekKey() {
        const d = this.state.currentWeek;
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      }

      changeWeek(direction) {
        this.saveSchedules();
        const d = new Date(this.state.currentWeek);
        d.setDate(d.getDate() + (direction * 7));
        this.setCurrentWeek(d);
        this.loadSchedules();
        this.render();
      }

      // Rendering Methods
      render() {
        this.renderWeekLabel();
        this.renderMoviesList();
        this.renderScheduleGrid();
      }

      renderWeekLabel() {
        const start = new Date(this.state.currentWeek);
        const end = new Date(start);
        end.setDate(end.getDate() + 6);
        
        const today = new Date();
        const isCurrentWeek = start <= today && today <= end;
        
        const format = (date) => date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric'
        });
        
        let label = `${format(start)} - ${format(end)}`;
        if (isCurrentWeek) {
          label += ' (This Week)';
        }
        
        document.getElementById('weekLabel').textContent = label;
      }

      renderMoviesList() {
        const container = document.getElementById('moviesList');
        container.innerHTML = '';
        
        if (this.state.movies.length === 0) {
          container.innerHTML = '<div class="text-muted text-small" style="padding: 1rem; text-align: center;">No films in library. Click "Add Film" to start.</div>';
          return;
        }
        
        this.state.movies.forEach(movie => {
          const card = document.createElement('div');
          card.className = 'movie-card';
          card.draggable = true;
          card.dataset.movieId = movie.id;
          card.style.borderLeftColor = movie.color;
          
          card.innerHTML = `
            <div class="movie-title">${this.escapeHtml(movie.title)}</div>
            <div class="movie-info">${this.formatDuration(movie.duration)}</div>
            <div class="movie-actions">
              <button class="icon-btn" onclick="tslApp.editMovie(${movie.id})" title="Edit">✏️</button>
              <button class="icon-btn delete" onclick="tslApp.deleteMovie(${movie.id})" title="Delete">🗑</button>
            </div>
          `;
          
          // Add drag event listeners
          card.addEventListener('dragstart', (e) => this.handleMovieDragStart(e, movie));
          card.addEventListener('dblclick', () => this.editMovie(movie.id));
          
          container.appendChild(card);
        });
      }

      renderScheduleGrid() {
        const container = document.getElementById('daysContainer');
        container.innerHTML = '';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < 7; i++) {
          const dayColumn = this.createDayColumn(i, today);
          container.appendChild(dayColumn);
        }
        
        this.renderAllScheduledBlocks();
      }

      createDayColumn(dayIndex, today) {
        const date = new Date(this.state.currentWeek);
        date.setDate(date.getDate() + dayIndex);
        
        const column = document.createElement('div');
        column.className = 'day-column';
        column.dataset.dayIndex = dayIndex;
        
        // Day header
        const header = document.createElement('div');
        header.className = 'day-header';
        if (date.toDateString() === today.toDateString()) {
          header.classList.add('today');
        }
        header.textContent = date.toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
        column.appendChild(header);
        
        // Theater headers
        const theatersRow = document.createElement('div');
        theatersRow.className = 'theaters-row';
        theatersRow.innerHTML = `
          <div class="time-header">Time</div>
          <div class="theater-header">Theater 1</div>
          <div class="theater-header">Theater 2</div>
        `;
        column.appendChild(theatersRow);
        
        // Day content
        const content = document.createElement('div');
        content.className = 'day-content';
        
        // Time column
        const timeColumn = this.createTimeColumn();
        content.appendChild(timeColumn);
        
        // Theater lanes
        const theatersContainer = document.createElement('div');
        theatersContainer.className = 'theaters-container';
        
        ['t1', 't2'].forEach(theater => {
          const lane = this.createTheaterLane(dayIndex, theater);
          theatersContainer.appendChild(lane);
        });
        
        content.appendChild(theatersContainer);
        column.appendChild(content);
        
        return column;
      }

      createTimeColumn() {
        const column = document.createElement('div');
        column.className = 'time-column';
        
        const slots = (this.config.endHour - this.config.startHour) * (60 / this.config.slotMinutes);
        
        for (let i = 0; i < slots; i++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          
          const minutes = i * this.config.slotMinutes;
          const hour = Math.floor(minutes / 60) + this.config.startHour;
          const minute = minutes % 60;
          
          if (minute === 0) {
            slot.classList.add('hour');
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const ampm = hour < 12 ? 'am' : 'pm';
            slot.textContent = `${displayHour}:00`;
          } else {
            slot.textContent = `:${String(minute).padStart(2, '0')}`;
          }
          
          column.appendChild(slot);
        }
        
        return column;
      }

      createTheaterLane(dayIndex, theater) {
        const lane = document.createElement('div');
        lane.className = 'theater-lane';
        lane.dataset.day = dayIndex;
        lane.dataset.theater = theater;
        
        const slots = (this.config.endHour - this.config.startHour) * (60 / this.config.slotMinutes);
        lane.style.height = `${slots * 24}px`;
        
        // Add drag and drop event listeners
        lane.addEventListener('dragover', (e) => this.handleDragOver(e));
        lane.addEventListener('drop', (e) => this.handleDrop(e));
        lane.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        
        return lane;
      }

      renderAllScheduledBlocks() {
        // Clear existing blocks
        document.querySelectorAll('.schedule-block').forEach(block => block.remove());
        
        // Render all blocks
        for (const [key, blocks] of Object.entries(this.state.schedules)) {
          const [dayIndex, theater] = key.split('-');
          const lane = document.querySelector(`.theater-lane[data-day="${dayIndex}"][data-theater="${theater}"]`);
          
          if (lane) {
            blocks.forEach(block => {
              this.renderScheduleBlock(lane, block, key);
            });
          }
        }
      }

      renderScheduleBlock(lane, block, key) {
        const blockEl = document.createElement('div');
        blockEl.className = 'schedule-block';
        blockEl.draggable = true;
        blockEl.dataset.blockId = block.id;
        blockEl.dataset.key = key;
        blockEl.style.backgroundColor = block.color;
        
        const slots = Math.ceil(block.duration / this.config.slotMinutes);
        blockEl.style.top = `${block.startSlot * 24}px`;
        blockEl.style.height = `${slots * 24 - 4}px`;
        
        // Calculate time
        const startMinutes = this.config.startHour * 60 + block.startSlot * this.config.slotMinutes;
        const startHour = Math.floor(startMinutes / 60);
        const startMin = startMinutes % 60;
        const endMinutes = startMinutes + block.duration;
        const endHour = Math.floor(endMinutes / 60);
        const endMin = endMinutes % 60;
        
        const formatTime = (h, m) => {
          const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
          return `${displayHour}:${String(m).padStart(2, '0')}${h < 12 ? 'am' : 'pm'}`;
        };
        
        blockEl.innerHTML = `
          <div class="block-title">${this.escapeHtml(block.title)}</div>
          <div class="block-time">${formatTime(startHour, startMin)} - ${formatTime(endHour, endMin)}</div>
          <div class="block-actions">
            <button class="block-btn" onclick="tslApp.deleteScheduleBlock('${key}', '${block.id}')" title="Remove">✕</button>
          </div>
        `;
        
        // Add drag event listener
        blockEl.addEventListener('dragstart', (e) => this.handleBlockDragStart(e, block, key));
        
        lane.appendChild(blockEl);
      }

      // Drag and Drop Handlers
      handleMovieDragStart(e, movie) {
        this.state.draggedItem = { type: 'movie', data: movie };
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('text/plain', '');
      }

      handleBlockDragStart(e, block, key) {
        this.state.draggedItem = { type: 'block', data: block, originalKey: key };
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', '');
      }

      handleDragOver(e) {
        if (!this.state.draggedItem) return;
        
        const lane = e.target.closest('.theater-lane');
        if (lane) {
          e.preventDefault();
          e.dataTransfer.dropEffect = this.state.draggedItem.type === 'movie' ? 'copy' : 'move';
          
          // Clear previous highlights
          document.querySelectorAll('.theater-lane').forEach(l => l.classList.remove('drag-over'));
          lane.classList.add('drag-over');
          
          // Show drop preview
          this.showDropPreview(lane, e);
        }
      }

      handleDragLeave(e) {
        const lane = e.target.closest('.theater-lane');
        if (lane && !lane.contains(e.relatedTarget)) {
          lane.classList.remove('drag-over');
          this.removeDropPreview();
        }
      }

      handleDrop(e) {
        e.preventDefault();
        
        const lane = e.target.closest('.theater-lane');
        if (!lane || !this.state.draggedItem) return;
        
        const dayIndex = parseInt(lane.dataset.day);
        const theater = lane.dataset.theater;
        const key = `${dayIndex}-${theater}`;
        
        // Calculate drop position
        const rect = lane.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const slot = Math.max(0, Math.floor(y / 24));
        
        if (this.state.draggedItem.type === 'movie') {
          this.addMovieToSchedule(key, slot, this.state.draggedItem.data);
        } else if (this.state.draggedItem.type === 'block') {
          this.moveScheduleBlock(this.state.draggedItem.originalKey, key, slot, this.state.draggedItem.data);
        }
        
        this.handleDragEnd();
      }

      handleDragEnd() {
        // Clean up
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        this.removeDropPreview();
        this.state.draggedItem = null;
      }

      showDropPreview(lane, e) {
        this.removeDropPreview();
        
        if (!this.state.draggedItem) return;
        
        const rect = lane.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const slot = Math.max(0, Math.floor(y / 24));
        
        const duration = this.state.draggedItem.data.duration;
        const slots = Math.ceil(duration / this.config.slotMinutes);
        
        const preview = document.createElement('div');
        preview.className = 'drop-preview';
        preview.id = 'dropPreview';
        preview.style.top = `${slot * 24}px`;
        preview.style.height = `${slots * 24 - 4}px`;
        
        // Check for conflicts
        const key = `${lane.dataset.day}-${lane.dataset.theater}`;
        const excludeId = this.state.draggedItem.type === 'block' ? this.state.draggedItem.data.id : null;
        
        if (this.hasConflict(key, slot, duration, excludeId)) {
          preview.classList.add('conflict');
        }
        
        lane.appendChild(preview);
      }

      removeDropPreview() {
        const preview = document.getElementById('dropPreview');
        if (preview) preview.remove();
      }

      // Schedule Management
      addMovieToSchedule(key, startSlot, movie) {
        const block = {
          id: `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          title: movie.title,
          duration: movie.duration,
          startSlot: startSlot,
          color: movie.color
        };
        
        if (!this.state.schedules[key]) {
          this.state.schedules[key] = [];
        }
        
        if (!this.hasConflict(key, startSlot, movie.duration)) {
          this.state.schedules[key].push(block);
          this.saveSchedules();
          this.renderAllScheduledBlocks();
          this.showToast(`Added "${movie.title}" to schedule`, 'success');
        } else {
          this.showToast('Time conflict! Please choose another slot.', 'error');
        }
      }

      moveScheduleBlock(fromKey, toKey, newStartSlot, block) {
        // Remove from original position
        if (this.state.schedules[fromKey]) {
          this.state.schedules[fromKey] = this.state.schedules[fromKey].filter(b => b.id !== block.id);
          if (this.state.schedules[fromKey].length === 0) {
            delete this.state.schedules[fromKey];
          }
        }
        
        // Check for conflicts at new position
        if (!this.hasConflict(toKey, newStartSlot, block.duration, block.id)) {
          // Add to new position
          block.startSlot = newStartSlot;
          if (!this.state.schedules[toKey]) {
            this.state.schedules[toKey] = [];
          }
          this.state.schedules[toKey].push(block);
          this.saveSchedules();
          this.renderAllScheduledBlocks();
          this.showToast('Schedule updated', 'success');
        } else {
          // Restore to original position if conflict
          if (!this.state.schedules[fromKey]) {
            this.state.schedules[fromKey] = [];
          }
          this.state.schedules[fromKey].push(block);
          this.renderAllScheduledBlocks();
          this.showToast('Time conflict! Block restored to original position.', 'error');
        }
      }

      deleteScheduleBlock(key, blockId) {
        if (this.state.schedules[key]) {
          this.state.schedules[key] = this.state.schedules[key].filter(b => b.id !== blockId);
          if (this.state.schedules[key].length === 0) {
            delete this.state.schedules[key];
          }
          this.saveSchedules();
          this.renderAllScheduledBlocks();
          this.showToast('Removed from schedule', 'info');
        }
      }

      hasConflict(key, startSlot, duration, excludeId = null) {
        const blocks = this.state.schedules[key] || [];
        const slots = Math.ceil(duration / this.config.slotMinutes);
        const endSlot = startSlot + slots;
        
        return blocks.some(block => {
          if (excludeId && block.id === excludeId) return false;
          const blockSlots = Math.ceil(block.duration / this.config.slotMinutes);
          const blockEnd = block.startSlot + blockSlots;
          return (startSlot < blockEnd && endSlot > block.startSlot);
        });
      }

      // Movie Management
      openMovieDialog(movie = null) {
        const dialog = document.getElementById('movieDialog');
        const form = document.getElementById('movieForm');
        
        if (movie) {
          document.getElementById('movieId').value = movie.id;
          document.getElementById('movieTitle').value = movie.title;
          const hours = Math.floor(movie.duration / 60);
          const minutes = movie.duration % 60;
          document.getElementById('movieHours').value = hours;
          document.getElementById('movieMinutes').value = minutes;
          document.getElementById('movieColor').value = movie.color;
          dialog.querySelector('.dialog-title').textContent = 'Edit Film';
        } else {
          form.reset();
          document.getElementById('movieId').value = '';
          document.getElementById('movieColor').value = '#3b82f6';
          dialog.querySelector('.dialog-title').textContent = 'Add Film';
        }
        
        this.openDialog('movieDialog');
      }

      editMovie(id) {
        const movie = this.state.movies.find(m => m.id === id);
        if (movie) {
          this.openMovieDialog(movie);
        }
      }

      deleteMovie(id) {
        const movie = this.state.movies.find(m => m.id === id);
        if (movie && confirm(`Delete "${movie.title}" from the library?`)) {
          this.state.movies = this.state.movies.filter(m => m.id !== id);
          this.saveMovies();
          this.render();
          this.showToast('Film deleted', 'info');
        }
      }

      saveMovie() {
        const id = document.getElementById('movieId').value;
        const title = document.getElementById('movieTitle').value.trim();
        const hours = parseInt(document.getElementById('movieHours').value) || 0;
        const minutes = parseInt(document.getElementById('movieMinutes').value) || 0;
        const duration = hours * 60 + minutes;
        const color = document.getElementById('movieColor').value;
        
        if (!title) {
          this.showToast('Please enter a film title', 'error');
          return;
        }
        
        if (duration < 15) {
          this.showToast('Duration must be at least 15 minutes', 'error');
          return;
        }
        
        if (id) {
          // Edit existing movie
          const movie = this.state.movies.find(m => m.id == id);
          if (movie) {
            movie.title = title;
            movie.duration = duration;
            movie.color = color;
            this.showToast('Film updated', 'success');
          }
        } else {
          // Add new movie
          const newMovie = {
            id: Date.now(),
            title,
            duration,
            color
          };
          this.state.movies.push(newMovie);
          this.showToast('Film added to library', 'success');
        }
        
        this.saveMovies();
        this.render();
        this.closeDialog('movieDialog');
      }

      // Settings Management
      openSettings() {
        document.getElementById('startHour').value = this.config.startHour;
        document.getElementById('endHour').value = this.config.endHour;
        document.getElementById('weekStart').value = this.config.weekStartDay;
        this.openDialog('settingsDialog');
      }

      saveSettings() {
        const startHour = parseInt(document.getElementById('startHour').value);
        const endHour = parseInt(document.getElementById('endHour').value);
        const weekStartDay = parseInt(document.getElementById('weekStart').value);
        
        if (startHour >= endHour) {
          this.showToast('End hour must be after start hour', 'error');
          return;
        }
        
        this.config.startHour = startHour;
        this.config.endHour = endHour;
        this.config.weekStartDay = weekStartDay;
        
        this.saveConfig();
        this.setCurrentWeek(new Date());
        this.render();
        this.closeDialog('settingsDialog');
        this.showToast('Settings saved', 'success');
      }

      // Import/Export
      exportSchedule() {
        const data = {
          version: '2.0',
          date: new Date().toISOString(),
          config: this.config,
          movies: this.state.movies,
          week: this.getWeekKey(),
          schedules: this.state.schedules
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tsl-schedule-${this.getWeekKey()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showToast('Schedule exported', 'success');
      }

      importSchedule(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            
            if (!data.version || !data.movies || !data.schedules) {
              throw new Error('Invalid schedule file');
            }
            
            // Import movies
            this.state.movies = data.movies;
            this.saveMovies();
            
            // Import schedules for current week
            this.state.schedules = data.schedules;
            this.saveSchedules();
            
            // Import config if present
            if (data.config) {
              Object.assign(this.config, data.config);
              this.saveConfig();
            }
            
            this.render();
            this.showToast('Schedule imported successfully', 'success');
          } catch (error) {
            this.showToast('Failed to import schedule', 'error');
          }
        };
        reader.readAsText(file);
      }

      // Dialog Management
      openDialog(dialogId) {
        document.getElementById(dialogId).classList.add('open');
      }

      closeDialog(dialogId) {
        document.getElementById(dialogId).classList.remove('open');
      }

      // Event Binding
      bindEvents() {
        // Week navigation
        document.getElementById('prevWeekBtn').addEventListener('click', () => this.changeWeek(-1));
        document.getElementById('nextWeekBtn').addEventListener('click', () => this.changeWeek(1));
        document.getElementById('todayBtn').addEventListener('click', () => {
          this.saveSchedules();
          this.setCurrentWeek(new Date());
          this.loadSchedules();
          this.render();
          this.showToast('Jumped to current week', 'info');
        });
        
        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', () => {
          this.state.sidebarCollapsed = !this.state.sidebarCollapsed;
          document.getElementById('sidebar').classList.toggle('collapsed', this.state.sidebarCollapsed);
        });
        
        // Save button
        document.getElementById('saveBtn').addEventListener('click', () => {
          this.saveSchedules();
          this.saveMovies();
          this.saveConfig();
          this.showToast('All changes saved', 'success');
        });
        
        // Clear week
        document.getElementById('clearWeekBtn').addEventListener('click', () => {
          if (confirm('Clear all schedules for this week? This cannot be undone.')) {
            this.state.schedules = {};
            this.saveSchedules();
            this.render();
            this.showToast('Week schedule cleared', 'success');
          }
        });
        
        // Movie management
        document.getElementById('addMovieBtn').addEventListener('click', () => this.openMovieDialog());
        
        // Settings
        document.getElementById('settingsBtn').addEventListener('click', () => this.openSettings());
        
        // Import/Export
        document.getElementById('exportBtn').addEventListener('click', () => this.exportSchedule());
        document.getElementById('importBtn').addEventListener('click', () => {
          document.getElementById('importFile').click();
        });
        document.getElementById('importFile').addEventListener('change', (e) => {
          if (e.target.files[0]) {
            this.importSchedule(e.target.files[0]);
            e.target.value = '';
          }
        });
        
        // Global drag end
        document.addEventListener('dragend', () => this.handleDragEnd());
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Escape to close dialogs
          if (e.key === 'Escape') {
            document.querySelectorAll('.dialog.open').forEach(dialog => {
              dialog.classList.remove('open');
            });
          }
          
          // Ctrl/Cmd + S to save
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            document.getElementById('saveBtn').click();
          }
        });
        
        // Auto-save every 30 seconds
        setInterval(() => {
          this.saveSchedules();
          this.saveMovies();
        }, 30000);
      }

      // Utility Functions
      formatDuration(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (hours > 0 && mins > 0) {
          return `${hours}h ${mins}m`;
        } else if (hours > 0) {
          return `${hours}h`;
        } else {
          return `${mins}m`;
        }
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: '✓',
          error: '✗',
          info: 'ℹ',
          warning: '⚠'
        };
        
        toast.innerHTML = `
          <span style="font-size: 1.25rem; margin-right: 0.5rem;">${icons[type] || icons.info}</span>
          <span>${this.escapeHtml(message)}</span>
        `;
        
        const container = document.getElementById('toastContainer');
        container.appendChild(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
          toast.style.animation = 'slideIn 0.3s ease reverse';
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }
    }

    // Initialize app when DOM is ready
    window.tslApp = new TSLScheduler();
  </script>
</body>
</html>
