<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Scheduler v3.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        /* ===== LIBRARY PANEL ===== */
        .library-panel {
            width: 320px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .library-header {
            margin-bottom: 15px;
        }

        .library-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .library-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .library-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .library-filter {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .library-count {
            font-size: 13px;
            color: #666;
        }

        .library-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .library-item {
            padding: 12px;
            border-radius: 6px;
            cursor: grab;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .library-item:active {
            cursor: grabbing;
        }

        .library-item.movie {
            background: #a5dceb;
            border: 1px solid #8fc9db;
        }

        .library-item.event {
            background: #e74c43;
            color: white;
            border: 1px solid #d43b32;
        }

        .library-item-title {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
        }

        .library-item.event .library-item-title {
            color: white;
        }

        .library-item-meta {
            font-size: 12px;
            color: #4a4a4a;
        }

        .library-item.event .library-item-meta {
            color: rgba(255,255,255,0.9);
        }

        /* ===== SCHEDULE GRID ===== */
        .schedule-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .schedule-title {
            font-size: 18px;
            font-weight: 600;
        }

        .schedule-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: #000;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .week-nav button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .week-nav button:hover {
            background: #f5f5f5;
        }

        .week-display {
            font-size: 14px;
            font-weight: 500;
        }

        .view-mode-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            margin-left: auto;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        /* ===== GRID LAYOUT ===== */
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(var(--day-count, 4), 1fr);
            gap: 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .schedule-grid.full-week {
            --day-count: 7;
        }

        .schedule-grid.four-day {
            --day-count: 4;
        }

        .time-column {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            background: #fafafa;
        }

        .time-header {
            height: 76px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            border-bottom: 2px solid #333;
            background: #f0f0f0;
        }

        .time-labels {
            display: flex;
            flex-direction: column;
        }

        .time-label {
            height: 80px; /* 1 hour = 4 x 20px */
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 4px;
            font-size: 11px;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
        }

        .day-column {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            min-width: 180px;
            max-width: 220px;
        }

        .schedule-grid.full-week .day-column {
            min-width: 140px;
            max-width: 160px;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            height: 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f8f8;
            border-bottom: 2px solid #333;
        }

        .day-name {
            font-weight: 600;
            font-size: 13px;
        }

        .day-date {
            font-size: 11px;
            color: #666;
        }

        .theater-row {
            display: flex;
            height: 100%;
        }

        .theater-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            position: relative;
        }

        .theater-column:last-child {
            border-right: none;
        }

        .theater-header {
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
            background: #fafafa;
            border-bottom: 2px solid #333;
        }

        .theater-content {
            position: relative;
            height: 960px; /* 12 hours × 80px/hour */
            background: 
                repeating-linear-gradient(
                    to bottom,
                    transparent,
                    transparent 19px,
                    #f0f0f0 19px,
                    #f0f0f0 20px
                );
        }

        /* ===== SCHEDULED EVENTS ===== */
        .scheduled-event {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: grab;
            border: 1px solid rgba(0,0,0,0.1);
            z-index: 10;
        }

        .scheduled-event:active {
            cursor: grabbing;
        }

        .scheduled-event.movie-t1 {
            background: #a5dceb;
            color: #1a1a1a;
        }

        .scheduled-event.movie-t2 {
            background: #4bc4a5;
            color: #1a1a1a;
        }

        .scheduled-event.event {
            background: #e74c43;
            color: white;
        }

        .event-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.8;
        }

        /* ===== DRAG & DROP HELPERS ===== */
        .drag-preview {
            position: fixed;
            padding: 8px 12px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }

        .snap-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #2196F3;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .snap-indicator.visible {
            opacity: 1;
        }

        .drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .drop-zone.drag-over {
            background: rgba(33, 150, 243, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LIBRARY PANEL -->
        <div class="library-panel">
            <div class="library-header">
                <h2>Library</h2>
                <input type="text" class="library-search" placeholder="Search programs..." id="searchBox">
            </div>
            <div class="library-controls">
                <select class="library-filter" id="filterSelect">
                    <option value="recent">Recent (30 days)</option>
                    <option value="movies">Movies</option>
                    <option value="events">Events</option>
                </select>
                <span class="library-count" id="libraryCount">(0)</span>
            </div>
            <div class="library-items" id="libraryItems">
                <!-- Items loaded dynamically -->
            </div>
        </div>

        <!-- SCHEDULE PANEL -->
        <div class="schedule-panel">
            <div class="schedule-header">
                <h1 class="schedule-title">TSL Scheduler</h1>
                <div class="schedule-controls">
                    <button class="btn btn-secondary" id="syncBtn">Sync with Google</button>
                    <button class="btn btn-primary" id="pushBtn">Push to Google</button>
                </div>
            </div>

            <div class="week-nav">
                <button id="prevWeekBtn">← Previous</button>
                <span class="week-display" id="weekDisplay">Week of Nov 1</span>
                <button id="nextWeekBtn">Next →</button>
                <select class="view-mode-select" id="viewModeSelect">
                    <option value="fri-mon">Weekend (FRI-MON)</option>
                    <option value="tue-fri">Midweek (TUE-FRI)</option>
                    <option value="full">Full Week (7 Days)</option>
                </select>
            </div>

            <div class="schedule-grid" id="scheduleGrid">
                <!-- Grid built dynamically -->
            </div>
        </div>
    </div>

    <!-- Google Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://tnnkfnattwpqqrydsyux.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubmtmbmF0dHdwcXFyeWRzeXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Njc3NDAsImV4cCI6MjA3MzA0Mzc0MH0.cNzStE1v6YA7HRvTeBCXxGFPuJPq1WmnuVGVaNLjOsE';
        const GOOGLE_API_KEY = 'AIzaSyDzisAik43Rr1xTJXg2bHXNF_XRTjjZsh8';
        
        const CALENDAR_IDS = {
            events: '1ed95b09dcc5ea1a1e13267b6654eca3c892fc79c23e2e9edc1e271411967255@group.calendar.google.com',
            theater1: '007f10222d517076d028161a4cda7108e75444c18ef7ac0d79aee420313d1a7b@group.calendar.google.com',
            theater2: 'ed801a88ce91b43543ef4e87c34d1405a6e053c5254e55e2871f0d305ecc32c4@group.calendar.google.com'
        };

        // ===== STATE =====
        let library = [];
        let schedule = [];
        let currentWeekStart = getFriday(new Date());
        let draggedItem = null;
        let gapiInitialized = false;
        let viewMode = 'fri-mon'; // 'fri-mon', 'tue-fri', or 'full'

        // ===== UTILITY FUNCTIONS =====
        function getFriday(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0=Sun, 5=Fri, 6=Sat
            let diff;
            
            if (day === 5) {
                diff = 0; // Already Friday
            } else if (day === 6) {
                diff = -1; // Saturday -> go back 1 day
            } else {
                diff = -(day + 2); // Sun-Thu -> go back to previous Friday
            }
            
            d.setDate(d.getDate() + diff);
            return d;
        }

        function getTuesday(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0=Sun, 2=Tue
            let diff;
            
            if (day === 2) {
                diff = 0; // Already Tuesday
            } else if (day < 2) {
                diff = -(day + 5); // Sun-Mon -> go back to previous Tuesday
            } else {
                diff = -(day - 2); // Wed-Sat -> go back to this week's Tuesday
            }
            
            d.setDate(d.getDate() + diff);
            return d;
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekStartForMode(mode) {
            const now = new Date();
            switch(mode) {
                case 'fri-mon':
                    return getFriday(now);
                case 'tue-fri':
                    return getTuesday(now);
                case 'full':
                    return getMonday(now);
                default:
                    return getFriday(now);
            }
        }

        function getDayCount() {
            return viewMode === 'full' ? 7 : 4;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDuration(minutes) {
            if (!minutes) return '';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins}m`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}m`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function snapToGrid(y) {
            const gridSize = 20; // 15 minutes
            return Math.round(y / gridSize) * gridSize;
        }

        function pixelsToTime(pixels, startHour = 12) {
            const minutes = (pixels / 20) * 15;
            const totalMinutes = startHour * 60 + minutes;
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            return { hours, minutes: mins };
        }

        function timeToPixels(hours, minutes, startHour = 12) {
            const totalMinutes = (hours * 60 + minutes) - (startHour * 60);
            return (totalMinutes / 15) * 20;
        }

        function showStatus(message, type = 'info') {
            // Remove any existing status messages
            document.querySelectorAll('.status-message').forEach(el => el.remove());
            
            // Create new popup
            const popup = document.createElement('div');
            popup.className = `status-message status-${type}`;
            popup.textContent = message;
            document.body.appendChild(popup);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                popup.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => popup.remove(), 300);
            }, 5000);
        }

        // ===== LOAD LIBRARY FROM SUPABASE =====
        async function loadLibrary() {
            try {
                // Load movies
                const moviesResponse = await fetch(`${SUPABASE_URL}/rest/v1/movies?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const movies = await moviesResponse.json();

                // Load events
                const eventsResponse = await fetch(`${SUPABASE_URL}/rest/v1/events?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const events = await eventsResponse.json();

                // Combine and add content_type
                library = [
                    ...movies.map(m => ({ ...m, content_type: 'movie' })),
                    ...events.map(e => ({ ...e, content_type: 'event' }))
                ];

                console.log('Library loaded:', library.length, 'programs');
                renderLibrary();
            } catch (error) {
                console.error('Error loading library:', error);
                showStatus('Failed to load library', 'warning');
            }
        }

        // ===== RENDER LIBRARY =====
        function renderLibrary() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('filterSelect').value;
            
            let filtered = library.filter(item => {
                // Search filter
                if (searchTerm && !item.title.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Type filter
                if (filter === 'movies' && item.content_type !== 'movie') return false;
                if (filter === 'events' && item.content_type !== 'event') return false;
                
                // Recent filter (30 days)
                if (filter === 'recent') {
                    const created = new Date(item.created_at);
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    if (created < thirtyDaysAgo) return false;
                }

                return true;
            });

            document.getElementById('libraryCount').textContent = `(${filtered.length})`;

            const container = document.getElementById('libraryItems');
            container.innerHTML = filtered.map(item => `
                <div class="library-item ${item.content_type}" 
                     draggable="true" 
                     data-id="${item.id}">
                    <div class="library-item-title">${item.title}</div>
                    <div class="library-item-meta">
                        ${item.director || item.location || ''}
                        ${item.runtime_minutes ? ' • ' + formatDuration(item.runtime_minutes) : ''}
                    </div>
                </div>
            `).join('');

            // Attach drag listeners
            document.querySelectorAll('.library-item').forEach(el => {
                el.addEventListener('dragstart', handleLibraryDragStart);
            });
        }

        // ===== BUILD SCHEDULE GRID =====
        function buildScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const weekStart = new Date(currentWeekStart);
            const dayCount = getDayCount();
            
            // Update grid class
            grid.className = viewMode === 'full' ? 'schedule-grid full-week' : 'schedule-grid four-day';
            
            // Update week display
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + (dayCount - 1));
            document.getElementById('weekDisplay').textContent = 
                `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;

            // Build grid HTML
            let html = '';

            // Time column
            html += '<div class="time-column">';
            html += '<div class="time-header">Time</div>';
            html += '<div class="time-labels">';
            for (let hour = 12; hour < 24; hour++) {
                const displayHour = hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                html += `<div class="time-label">${displayHour}:00 ${ampm}</div>`;
            }
            html += '</div></div>';

            // Day columns
            for (let i = 0; i < dayCount; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                const dayDate = formatDate(date);
                const dateStr = date.toISOString().split('T')[0];

                html += `
                    <div class="day-column" data-date="${dateStr}">
                        <div class="day-header">
                            <div class="day-name">${dayName}</div>
                            <div class="day-date">${dayDate}</div>
                        </div>
                        <div class="theater-row">
                            <div class="theater-column" data-theater="T1">
                                <div class="theater-header">T1</div>
                                <div class="theater-content" data-date="${dateStr}" data-theater="T1">
                                    <div class="snap-indicator"></div>
                                    <div class="drop-zone"></div>
                                </div>
                            </div>
                            <div class="theater-column" data-theater="T2">
                                <div class="theater-header">T2</div>
                                <div class="theater-content" data-date="${dateStr}" data-theater="T2">
                                    <div class="snap-indicator"></div>
                                    <div class="drop-zone"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;

            // Attach drop zone listeners
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });

            // Render scheduled events
            renderScheduledEvents();
        }

        // ===== RENDER SCHEDULED EVENTS =====
        function renderScheduledEvents() {
            document.querySelectorAll('.scheduled-event').forEach(el => el.remove());

            schedule.forEach(event => {
                const container = document.querySelector(
                    `.theater-content[data-date="${event.date}"][data-theater="${event.theater}"]`
                );
                
                if (!container) return;

                const top = timeToPixels(event.startHour, event.startMinute);
                const height = (event.duration / 15) * 20;

                const eventClass = event.content_type === 'movie' 
                    ? `movie-${event.theater.toLowerCase()}`
                    : 'event';

                const eventEl = document.createElement('div');
                eventEl.className = `scheduled-event ${eventClass}`;
                eventEl.style.top = `${top}px`;
                eventEl.style.height = `${height}px`;
                eventEl.draggable = true;
                eventEl.dataset.scheduleId = event.id;
                
                const startTime = formatTime(new Date(2000, 0, 1, event.startHour, event.startMinute));
                
                eventEl.innerHTML = `
                    <div class="event-title">${event.title}</div>
                    <div class="event-time">${startTime} • ${formatDuration(event.duration)}</div>
                `;

                eventEl.addEventListener('dragstart', handleScheduledDragStart);
                container.appendChild(eventEl);
            });
        }

        // ===== DRAG & DROP HANDLERS =====
        let dragPreview = null;

        function handleLibraryDragStart(e) {
            const itemId = e.target.dataset.id;
            draggedItem = library.find(item => item.id === itemId);
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleScheduledDragStart(e) {
            const scheduleId = e.target.dataset.scheduleId;
            draggedItem = schedule.find(item => item.id === scheduleId);
            draggedItem.isRescheduling = true;
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = draggedItem?.isRescheduling ? 'move' : 'copy';

            const zone = e.currentTarget;
            const container = zone.parentElement;
            const rect = container.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const snappedY = snapToGrid(y);

            // Show snap indicator
            const indicator = container.querySelector('.snap-indicator');
            indicator.style.top = `${snappedY}px`;
            indicator.classList.add('visible');

            // Show drag preview
            const time = pixelsToTime(snappedY);
            const timeStr = `${time.hours > 12 ? time.hours - 12 : time.hours}:${time.minutes.toString().padStart(2, '0')} ${time.hours >= 12 ? 'PM' : 'AM'}`;
            
            if (!dragPreview) {
                dragPreview = document.createElement('div');
                dragPreview.className = 'drag-preview';
                document.body.appendChild(dragPreview);
            }
            
            dragPreview.textContent = draggedItem?.isRescheduling ? `Move to ${timeStr}` : `Drop at ${timeStr}`;
            dragPreview.style.left = `${e.clientX + 10}px`;
            dragPreview.style.top = `${e.clientY + 10}px`;

            zone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            const zone = e.currentTarget;
            const indicator = zone.parentElement.querySelector('.snap-indicator');
            indicator.classList.remove('visible');
            zone.classList.remove('drag-over');

            if (dragPreview) {
                dragPreview.remove();
                dragPreview = null;
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const zone = e.currentTarget;
            const container = zone.parentElement;
            const date = container.dataset.date;
            const theater = container.dataset.theater;
            const rect = container.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const snappedY = snapToGrid(y);
            const time = pixelsToTime(snappedY);

            zone.classList.remove('drag-over');
            const indicator = container.querySelector('.snap-indicator');
            indicator.classList.remove('visible');

            if (dragPreview) {
                dragPreview.remove();
                dragPreview = null;
            }

            if (!draggedItem) return;

            if (draggedItem.isRescheduling) {
                // Remove from old position
                schedule = schedule.filter(item => item.id !== draggedItem.id);
            }

            // Add to schedule
            const newEvent = {
                id: draggedItem.isRescheduling ? draggedItem.id : `sched-${Date.now()}`,
                supabaseId: draggedItem.id,
                title: draggedItem.title,
                content_type: draggedItem.content_type,
                duration: draggedItem.runtime_minutes || 120,
                date: date,
                theater: theater,
                startHour: time.hours,
                startMinute: time.minutes,
                googleEventId: draggedItem.googleEventId || null
            };

            schedule.push(newEvent);
            renderScheduledEvents();

            draggedItem = null;
            
            showStatus('Event scheduled! Click "Push to Google" to save.', 'success');
        }

        // ===== GOOGLE CALENDAR API =====
        function initGoogleAPI() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                    });
                    gapiInitialized = true;
                    console.log('Google Calendar API initialized');
                    
                    // Auto-sync on load
                    syncWithGoogle();
                } catch (error) {
                    console.error('Error initializing Google API:', error);
                    showStatus('Google Calendar connection failed', 'warning');
                }
            });
        }

        async function syncWithGoogle() {
            if (!gapiInitialized) {
                showStatus('Google Calendar not initialized', 'warning');
                return;
            }

            showStatus('Syncing with Google Calendar...', 'info');

            try {
                const weekStart = new Date(currentWeekStart);
                const weekEnd = new Date(weekStart);
                const dayCount = getDayCount();
                weekEnd.setDate(weekEnd.getDate() + dayCount);

                let matchCount = 0;

                // Sync each calendar
                for (const [calName, calId] of Object.entries(CALENDAR_IDS)) {
                    const response = await gapi.client.calendar.events.list({
                        calendarId: calId,
                        timeMin: weekStart.toISOString(),
                        timeMax: weekEnd.toISOString(),
                        singleEvents: true
                    });

                    const events = response.result.items || [];
                    
                    events.forEach(gEvent => {
                        const supabaseId = gEvent.extendedProperties?.private?.['tsl-supabase-id'];
                        if (!supabaseId) return;

                        const existing = schedule.find(s => s.supabaseId === supabaseId);
                        if (existing) {
                            existing.googleEventId = gEvent.id;
                            matchCount++;
                        }
                    });
                }

                showStatus(`Synced! Found ${matchCount} matching events.`, 'success');
            } catch (error) {
                console.error('Sync error:', error);
                showStatus('Sync failed: ' + error.message, 'warning');
            }
        }

        async function pushToGoogle() {
            if (!gapiInitialized) {
                showStatus('Google Calendar not initialized', 'warning');
                return;
            }

            showStatus('Pushing to Google Calendar...', 'info');

            try {
                let createdCount = 0;
                let updatedCount = 0;

                for (const event of schedule) {
                    const calendarId = event.content_type === 'event' 
                        ? CALENDAR_IDS.events
                        : event.theater === 'T1' 
                            ? CALENDAR_IDS.theater1 
                            : CALENDAR_IDS.theater2;

                    const startDateTime = new Date(event.date);
                    startDateTime.setHours(event.startHour, event.startMinute, 0);
                    
                    const endDateTime = new Date(startDateTime);
                    endDateTime.setMinutes(endDateTime.getMinutes() + event.duration);

                    const gEvent = {
                        summary: event.title,
                        start: {
                            dateTime: startDateTime.toISOString(),
                            timeZone: 'America/New_York'
                        },
                        end: {
                            dateTime: endDateTime.toISOString(),
                            timeZone: 'America/New_York'
                        },
                        extendedProperties: {
                            private: {
                                'tsl-supabase-id': event.supabaseId,
                                'tsl-content-type': event.content_type,
                                'tsl-theater': event.theater
                            }
                        }
                    };

                    if (event.googleEventId) {
                        // Update existing
                        await gapi.client.calendar.events.update({
                            calendarId: calendarId,
                            eventId: event.googleEventId,
                            resource: gEvent
                        });
                        updatedCount++;
                    } else {
                        // Create new
                        const response = await gapi.client.calendar.events.insert({
                            calendarId: calendarId,
                            resource: gEvent
                        });
                        event.googleEventId = response.result.id;
                        createdCount++;
                    }
                }

                showStatus(`Success! Created ${createdCount}, updated ${updatedCount} events.`, 'success');
            } catch (error) {
                console.error('Push error:', error);
                showStatus('Push failed: ' + error.message, 'warning');
            }
        }

        // ===== EVENT LISTENERS =====
        document.getElementById('searchBox').addEventListener('input', renderLibrary);
        document.getElementById('filterSelect').addEventListener('change', renderLibrary);
        
        document.getElementById('prevWeekBtn').addEventListener('click', () => {
            const dayCount = getDayCount();
            currentWeekStart.setDate(currentWeekStart.getDate() - dayCount);
            buildScheduleGrid();
        });
        
        document.getElementById('nextWeekBtn').addEventListener('click', () => {
            const dayCount = getDayCount();
            currentWeekStart.setDate(currentWeekStart.getDate() + dayCount);
            buildScheduleGrid();
        });

        document.getElementById('viewModeSelect').addEventListener('change', (e) => {
            viewMode = e.target.value;
            currentWeekStart = getWeekStartForMode(viewMode);
            buildScheduleGrid();
        });

        document.getElementById('syncBtn').addEventListener('click', syncWithGoogle);
        document.getElementById('pushBtn').addEventListener('click', pushToGoogle);

        // ===== INITIALIZATION =====
        async function init() {
            await loadLibrary();
            buildScheduleGrid();
            initGoogleAPI();
        }

        // Start the app
        init();
    </script>
</body>
</html>
