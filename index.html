<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Schedule Maker - v2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version-badge {
            font-size: 12px;
            background: #007aff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .auth-button {
            padding: 8px 16px;
            background: #34c759;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            margin-right: 15px;
        }

        .auth-button:hover {
            background: #30a852;
        }

        .auth-button.sign-out {
            background: #ff3b30;
        }

        .auth-button.sign-out:hover {
            background: #d70015;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #e8e8e8;
            border-radius: 20px;
            font-size: 14px;
            color: #86868b;
        }

        .sync-status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .week-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-navigation button {
            padding: 8px 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .week-display {
            font-size: 16px;
            font-weight: 500;
            min-width: 200px;
            text-align: center;
        }

        .week-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .push-status {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        .push-status.synced {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .push-status.needs-push {
            background: #fff3e0;
            color: #ef6c00;
        }

        .btn-primary {
            background: #007aff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-accent {
            background: #34c759;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .main-content {
            display: flex;
            gap: 20px;
        }

        .library-panel {
            width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8e8e8;
            font-weight: 600;
        }

        .library-status {
            font-size: 11px;
            color: #86868b;
            margin-bottom: 10px;
        }

        .library-item {
            background: #f5f5f7;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: move;
            font-size: 13px;
        }

        .library-item:hover {
            background: #e8e8e8;
        }

        .library-item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .library-item-meta {
            font-size: 11px;
            color: #86868b;
        }

        .schedule-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: auto;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            min-width: 1600px;
            border: 1px solid #e8e8e8;
        }

        .time-column {
            border-right: 1px solid #e8e8e8;
        }

        .time-header {
            height: 80px;
            border-bottom: 2px solid #d2d2d7;
        }

        .time-slot {
            height: 60px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 4px 8px 0 0;
            font-size: 11px;
            color: #86868b;
            border-bottom: 1px solid #e8e8e8;
        }

        .day-column {
            border-right: 1px solid #e8e8e8;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-column.hidden {
            display: none;
        }

        .day-header {
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f7;
            border-bottom: 2px solid #d2d2d7;
            font-weight: 600;
            font-size: 13px;
        }

        .day-date {
            font-size: 11px;
            color: #86868b;
            font-weight: 400;
            margin-top: 4px;
        }

        .theater-headers {
            height: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid #e8e8e8;
        }

        .theater-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #86868b;
            font-weight: 500;
            border-right: 1px solid #e8e8e8;
        }

        .theater-header:last-child {
            border-right: none;
        }

        .theaters-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
        }

        .theater-lane {
            border-right: 1px solid #e8e8e8;
            position: relative;
            min-height: 720px;
        }

        .theater-lane:last-child {
            border-right: none;
        }

        .theater-lane.drag-over {
            background: rgba(0, 122, 255, 0.05);
        }

        .drop-zone {
            height: 60px;
            border-bottom: 1px solid #e8e8e8;
            position: relative;
        }

        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            background: #007aff;
            color: white;
            border-radius: 4px;
            padding: 6px;
            font-size: 12px;
            cursor: move;
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .event-block.event-type {
            background: #34c759;
        }

        .event-block.tbd-type {
            background: #ff9500;
        }

        .event-block:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-time {
            font-size: 10px;
            opacity: 0.9;
        }

        .event-actions {
            position: absolute;
            top: 2px;
            right: 2px;
            display: flex;
            gap: 2px;
        }

        .event-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
        }

        .event-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1d1d1f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div>
                <h1>TSL Schedule Maker<span class="version-badge">v2.1</span></h1>
            </div>
            <button id="authButton" class="auth-button">Connect Google Calendar</button>
            <div class="sync-status" id="syncStatus">Not connected</div>
        </div>

        <div class="controls">
            <div class="week-navigation">
                <button id="prevWeek">← Previous</button>
                <div class="week-display" id="weekDisplay">Loading...</div>
                <button id="nextWeek">Next →</button>
            </div>
            <div class="week-actions">
                <span class="push-status synced" id="pushStatus">All synced</span>
                <button class="btn-accent" id="syncWithGoogle" style="display:none">Sync</button>
                <button class="btn-primary" id="pushToGoogle" style="display:none">Push to Google</button>
            </div>
        </div>

        <div class="main-content">
            <div class="library-panel">
                <div class="library-header">
                    <span>Library</span>
                    <span id="libraryCount">(0)</span>
                </div>
                <div class="library-status" id="libraryStatus">Loading...</div>
                <input type="text" id="librarySearch" placeholder="Search..." style="width: 100%; padding: 8px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 13px; margin-bottom: 8px;">
                <select id="libraryFilter" style="width: 100%; padding: 8px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 13px; margin-bottom: 10px;">
                    <option value="recent" selected>Recent (30 days)</option>
                    <option value="movies">Movies</option>
                    <option value="events">Events</option>
                </select>
                <div id="libraryItems"></div>
            </div>

            <div class="schedule-container">
                <div class="schedule-grid" id="scheduleGrid"></div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Configuration
        const CLIENT_ID = '10045666629-hnbmuhthec0jb7vqph3mqldi90p4f0is.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const SUPABASE_URL = 'https://tnnkfnattwpqqrydsyux.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubmtmbmF0dHdwcXFyeWRzeXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Njc3NDAsImV4cCI6MjA3MzA0Mzc0MH0.cNzStE1v6YA7HRvTeBCXxGFPuJPq1WmnuVGVaNLjOsE';
        
        const CALENDAR_IDS = {
            'events': '1ed95b09dcc5ea1a1e13267b6654eca3c892fc79c23e2e9edc1e271411967255@group.calendar.google.com',
            'non-public': '6b48156e2887ac486283a0d4a2f94b1d2ad4b1ac4dd7e19f2fc7e01dafe67700@group.calendar.google.com',
            'tbd': '7b77eba3cf2e9f4e0407d62c3acd2540170b31554d1698b71ea7eb3a11d58306@group.calendar.google.com',
            'theater-1': '007f10222d517076d028161a4cda7108e75444c18ef7ac0d79aee420313d1a7b@group.calendar.google.com',
            'theater-2': 'ed801a88ce91b43543ef4e87c34d1405a6e053c5254e55e2871f0d305ecc32c4@group.calendar.google.com'
        };

        // Time slots from 12PM to 12AM (noon to midnight)
        const TIME_SLOTS = [
            '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM',
            '6:00 PM', '7:00 PM', '8:00 PM', '9:00 PM', '10:00 PM', '11:00 PM', '12:00 AM'
        ];

        // State
        let supabase = null;
        let accessToken = null;
        let libraryEvents = [];
        let scheduledEvents = [];
        let currentWeekStart = new Date();
        
        // Set to Sunday
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
        currentWeekStart.setHours(0, 0, 0, 0);

        // Utility Functions
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins}m`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}m`;
        }

        function timeSlotToHour(slotIndex) {
            return slotIndex + 12; // 0 = 12PM, 1 = 1PM, etc.
        }

        function hourToTimeSlot(hour) {
            if (hour >= 12 && hour <= 23) return hour - 12;
            if (hour === 0) return 12;
            return -1;
        }

        // Initialize Supabase
        async function initLibrary() {
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            await loadLibrary();
        }

        async function loadLibrary() {
            try {
                libraryEvents = [];
                
                const [moviesResult, eventsResult] = await Promise.all([
                    supabase.from('movies').select('id, title, runtime_minutes, webpage_url, created_at').order('created_at', { ascending: false }),
                    supabase.from('events').select('id, event_name, duration_minutes, webpage_url, created_at').order('created_at', { ascending: false })
                ]);
                
                if (moviesResult.data) {
                    moviesResult.data.forEach(movie => {
                        libraryEvents.push({
                            id: `movie-${movie.id}`,
                            title: movie.title,
                            duration: movie.runtime_minutes || 120,
                            supabaseId: movie.id,
                            supabaseTable: 'movies',
                            webpageUrl: movie.webpage_url || '',
                            programType: 'movie',
                            calendar: 'theater',
                            createdAt: movie.created_at ? new Date(movie.created_at) : null
                        });
                    });
                }
                
                if (eventsResult.data) {
                    eventsResult.data.forEach(event => {
                        libraryEvents.push({
                            id: `event-${event.id}`,
                            title: event.event_name,
                            duration: event.duration_minutes || 120,
                            supabaseId: event.id,
                            supabaseTable: 'events',
                            webpageUrl: event.webpage_url || '',
                            programType: 'event',
                            calendar: 'events',
                            createdAt: event.created_at ? new Date(event.created_at) : null
                        });
                    });
                }
                
                renderLibrary();
                document.getElementById('libraryStatus').textContent = 
                    `${libraryEvents.length} programs loaded`;
                
            } catch (error) {
                console.error('Failed to load library:', error);
                showToast('Failed to load library');
            }
        }

        function renderLibrary() {
            const container = document.getElementById('libraryItems');
            container.innerHTML = '';
            
            const searchText = document.getElementById('librarySearch')?.value.toLowerCase() || '';
            const filter = document.getElementById('libraryFilter')?.value || 'recent';
            
            let filtered = libraryEvents;
            
            // Apply type filter
            if (filter === 'movies') {
                filtered = filtered.filter(e => e.programType === 'movie');
            } else if (filter === 'events') {
                filtered = filtered.filter(e => e.programType === 'event');
            } else if (filter === 'recent') {
                // Last 30 days
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filtered = filtered.filter(e => e.createdAt && e.createdAt >= thirtyDaysAgo);
            }
            
            // Apply search filter
            if (searchText) {
                filtered = filtered.filter(e => e.title.toLowerCase().includes(searchText));
            }
            
            filtered.forEach(event => {
                const item = document.createElement('div');
                item.className = 'library-item';
                item.draggable = true;
                
                const typeLabel = event.programType === 'movie' ? '[M]' : '[E]';
                
                item.innerHTML = `
                    <div class="library-item-title">${typeLabel} ${event.title}</div>
                    <div class="library-item-meta">${formatDuration(event.duration)}</div>
                `;
                
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify(event));
                });
                
                container.appendChild(item);
            });
            
            document.getElementById('libraryCount').textContent = `(${filtered.length})`;
        }

        // Render Schedule Grid
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            
            // Time column
            const timeColumn = document.createElement('div');
            timeColumn.className = 'time-column';
            
            // Time header
            const timeHeader = document.createElement('div');
            timeHeader.className = 'time-header';
            timeColumn.appendChild(timeHeader);
            
            // Time slots
            TIME_SLOTS.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                timeColumn.appendChild(slot);
            });
            
            grid.appendChild(timeColumn);
            
            // Days
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            days.forEach((dayName, dayIndex) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                dayColumn.dataset.day = dayIndex;
                
                // Day header
                const currentDate = new Date(currentWeekStart);
                currentDate.setDate(currentDate.getDate() + dayIndex);
                const dateStr = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                const header = document.createElement('div');
                header.className = 'day-header';
                header.innerHTML = `
                    ${dayName}
                    <span class="day-date">${dateStr}</span>
                `;
                dayColumn.appendChild(header);
                
                // Theater headers
                const theaterHeaders = document.createElement('div');
                theaterHeaders.className = 'theater-headers';
                theaterHeaders.innerHTML = `
                    <div class="theater-header">Theater 1</div>
                    <div class="theater-header">Theater 2</div>
                `;
                dayColumn.appendChild(theaterHeaders);
                
                // Theaters container
                const theatersContainer = document.createElement('div');
                theatersContainer.className = 'theaters-container';
                
                // Theater 1
                const theater1 = document.createElement('div');
                theater1.className = 'theater-lane';
                theater1.dataset.theater = '0';
                theater1.dataset.day = dayIndex;
                
                TIME_SLOTS.forEach((time, slotIndex) => {
                    const dropZone = document.createElement('div');
                    dropZone.className = 'drop-zone';
                    dropZone.dataset.slot = slotIndex;
                    setupDropZone(dropZone, dayIndex, 0, slotIndex);
                    theater1.appendChild(dropZone);
                });
                
                // Theater 2
                const theater2 = document.createElement('div');
                theater2.className = 'theater-lane';
                theater2.dataset.theater = '1';
                theater2.dataset.day = dayIndex;
                
                TIME_SLOTS.forEach((time, slotIndex) => {
                    const dropZone = document.createElement('div');
                    dropZone.className = 'drop-zone';
                    dropZone.dataset.slot = slotIndex;
                    setupDropZone(dropZone, dayIndex, 1, slotIndex);
                    theater2.appendChild(dropZone);
                });
                
                theatersContainer.appendChild(theater1);
                theatersContainer.appendChild(theater2);
                dayColumn.appendChild(theatersContainer);
                
                grid.appendChild(dayColumn);
            });
            
            renderEvents();
        }

        function setupDropZone(zone, day, theater, slot) {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.closest('.theater-lane').classList.add('drag-over');
            });
            
            zone.addEventListener('dragleave', (e) => {
                if (e.target === zone) {
                    zone.closest('.theater-lane').classList.remove('drag-over');
                }
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.closest('.theater-lane').classList.remove('drag-over');
                
                try {
                    const eventData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    
                    // Check if it's a move or new add
                    if (eventData.isScheduled) {
                        // Moving existing event
                        const existing = scheduledEvents.find(ev => ev.scheduleId === eventData.scheduleId);
                        if (existing) {
                            existing.day = day;
                            existing.theater = theater;
                            existing.timeSlot = slot;
                            existing.isModified = true;
                            updateEventDate(existing);
                        }
                    } else {
                        // Adding new event
                        const newEvent = {
                            ...eventData,
                            scheduleId: `sched-${Date.now()}-${Math.random()}`,
                            day: day,
                            theater: theater,
                            timeSlot: slot,
                            isPushed: false,
                            isModified: false,
                            isScheduled: true
                        };
                        updateEventDate(newEvent);
                        scheduledEvents.push(newEvent);
                        showToast(`Added ${newEvent.title}`);
                    }
                    
                    renderEvents();
                    updatePushStatus();
                    autoSave();
                    
                } catch (error) {
                    console.error('Drop error:', error);
                }
            });
        }

        function updateEventDate(event) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + event.day);
            const hour = timeSlotToHour(event.timeSlot);
            date.setHours(hour, 0, 0, 0);
            event.actualDate = date;
            event.startHour = hour;
            event.startMinute = 0;
        }

        function renderEvents() {
            // Clear existing event blocks
            document.querySelectorAll('.event-block').forEach(el => el.remove());
            
            scheduledEvents.forEach(event => {
                const lane = document.querySelector(
                    `.theater-lane[data-day="${event.day}"][data-theater="${event.theater}"]`
                );
                
                if (!lane) return;
                
                const block = createEventBlock(event);
                
                // Position based on time slot
                const dropZone = lane.querySelector(`.drop-zone[data-slot="${event.timeSlot}"]`);
                if (dropZone) {
                    dropZone.appendChild(block);
                    
                    // Calculate height based on duration
                    const slots = Math.ceil(event.duration / 60);
                    const height = (slots * 60) - 8;
                    block.style.height = `${height}px`;
                }
            });
        }

        function createEventBlock(event) {
            const block = document.createElement('div');
            block.className = 'event-block';
            block.draggable = true;
            
            if (event.programType === 'event') {
                block.classList.add('event-type');
            }
            if (event.calendar === 'tbd') {
                block.classList.add('tbd-type');
            }
            
            const endTime = new Date(event.actualDate);
            endTime.setMinutes(endTime.getMinutes() + event.duration);
            
            const formatTime = (date) => {
                const h = date.getHours();
                const m = date.getMinutes();
                const hour = h === 0 ? 12 : h > 12 ? h - 12 : h;
                const min = m.toString().padStart(2, '0');
                const ampm = h >= 12 ? 'PM' : 'AM';
                return `${hour}:${min}${ampm}`;
            };
            
            block.innerHTML = `
                <div class="event-title">${event.title}</div>
                <div class="event-time">${formatTime(event.actualDate)} - ${formatTime(endTime)}</div>
                <div class="event-actions">
                    <button class="event-btn" onclick="toggleTBD('${event.scheduleId}')">TBD</button>
                    <button class="event-btn" onclick="removeEvent('${event.scheduleId}')">×</button>
                </div>
            `;
            
            block.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    ...event,
                    isScheduled: true
                }));
                block.style.opacity = '0.5';
            });
            
            block.addEventListener('dragend', () => {
                block.style.opacity = '1';
            });
            
            return block;
        }

        window.toggleTBD = function(scheduleId) {
            const event = scheduledEvents.find(e => e.scheduleId === scheduleId);
            if (!event) return;
            
            if (event.calendar === 'tbd') {
                event.calendar = event.originalCalendar || (event.programType === 'movie' ? 'theater' : 'events');
                delete event.originalCalendar;
            } else {
                event.originalCalendar = event.calendar;
                event.calendar = 'tbd';
            }
            
            event.isModified = true;
            renderEvents();
            updatePushStatus();
            autoSave();
        };

        window.removeEvent = function(scheduleId) {
            const index = scheduledEvents.findIndex(e => e.scheduleId === scheduleId);
            if (index !== -1) {
                const event = scheduledEvents[index];
                scheduledEvents.splice(index, 1);
                showToast(`Removed ${event.title}`);
                renderEvents();
                updatePushStatus();
                autoSave();
            }
        };

        // Auto-save
        function autoSave() {
            try {
                localStorage.setItem('tsl_schedule_v2', JSON.stringify({
                    scheduledEvents,
                    currentWeekStart: currentWeekStart.toISOString(),
                    savedAt: new Date().toISOString()
                }));
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }

        function autoLoad() {
            try {
                const saved = localStorage.getItem('tsl_schedule_v2');
                if (saved) {
                    const data = JSON.parse(saved);
                    scheduledEvents = data.scheduledEvents.map(e => ({
                        ...e,
                        actualDate: new Date(e.actualDate)
                    }));
                    currentWeekStart = new Date(data.currentWeekStart);
                    console.log(`Auto-loaded ${scheduledEvents.length} events`);
                }
            } catch (error) {
                console.error('Auto-load failed:', error);
            }
        }

        // Google Calendar Sync
        async function syncWithGoogle() {
            if (!accessToken) {
                showToast('Not connected to Google');
                return;
            }

            showToast('Syncing with Google Calendar...');
            
            try {
                const timeMin = currentWeekStart.toISOString();
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);
                const timeMax = weekEnd.toISOString();
                
                let googleEvents = [];
                
                for (const [calType, calId] of Object.entries(CALENDAR_IDS)) {
                    try {
                        const response = await fetch(
                            `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events?` +
                            `timeMin=${encodeURIComponent(timeMin)}&` +
                            `timeMax=${encodeURIComponent(timeMax)}&singleEvents=true`,
                            { headers: { 'Authorization': `Bearer ${accessToken}` } }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.items) {
                                googleEvents.push(...data.items.map(item => ({
                                    ...item,
                                    calendarType: calType
                                })));
                            }
                        }
                    } catch (error) {
                        console.error(`Error fetching ${calType}:`, error);
                    }
                }
                
                console.log(`Found ${googleEvents.length} events in Google Calendar`);
                
                // Match with scheduled events
                let matched = 0;
                for (const scheduled of scheduledEvents) {
                    if (!scheduled.supabaseId) continue;
                    
                    const googleEvent = googleEvents.find(ge => {
                        const props = ge.extendedProperties?.private;
                        if (!props) return false;
                        
                        if (props['tsl-supabase-id'] === scheduled.supabaseId &&
                            props['tsl-supabase-table'] === scheduled.supabaseTable) {
                            const geStart = new Date(ge.start.dateTime);
                            return Math.abs(geStart - scheduled.actualDate) < 60000; // Within 1 min
                        }
                        return false;
                    });
                    
                    if (googleEvent) {
                        scheduled.googleEventId = googleEvent.id;
                        scheduled.isPushed = true;
                        scheduled.isModified = false;
                        matched++;
                    }
                }
                
                showToast(`Synced: ${matched} events matched`);
                updatePushStatus();
                autoSave();
                
            } catch (error) {
                console.error('Sync failed:', error);
                showToast('Sync failed');
            }
        }

        // Push to Google
        async function pushToGoogle() {
            if (!accessToken) {
                showToast('Not connected to Google');
                return;
            }
            
            const toPush = scheduledEvents.filter(e => !e.isPushed || e.isModified);
            
            if (toPush.length === 0) {
                showToast('Everything is already synced');
                return;
            }
            
            if (!confirm(`Push ${toPush.length} events to Google Calendar?`)) return;
            
            const pushBtn = document.getElementById('pushToGoogle');
            pushBtn.disabled = true;
            pushBtn.textContent = 'Pushing...';
            
            let created = 0, updated = 0, errors = 0;
            
            try {
                for (const event of toPush) {
                    try {
                        await createOrUpdateGoogleEvent(event);
                        if (event.googleEventId) updated++;
                        else created++;
                        event.isPushed = true;
                        event.isModified = false;
                    } catch (error) {
                        console.error(`Failed: ${event.title}`, error);
                        errors++;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                showToast(`${created} created, ${updated} updated, ${errors} errors`);
                updatePushStatus();
                autoSave();
                
            } finally {
                pushBtn.disabled = false;
                pushBtn.textContent = 'Push to Google';
            }
        }

        async function createOrUpdateGoogleEvent(event) {
            let calType = event.calendar;
            if (calType === 'theater') {
                calType = event.theater === 0 ? 'theater-1' : 'theater-2';
            }
            
            const calId = CALENDAR_IDS[calType];
            if (!calId) throw new Error(`No calendar ID for ${calType}`);
            
            const startDateTime = new Date(event.actualDate);
            const endDateTime = new Date(startDateTime);
            endDateTime.setMinutes(endDateTime.getMinutes() + event.duration);
            
            const eventData = {
                summary: event.title,
                description: event.webpageUrl ? 
                    `${event.webpageUrl}\n\nScheduled via TSL Schedule Maker v2.1` :
                    'Scheduled via TSL Schedule Maker v2.1',
                location: event.theater === 0 ? 'Theater 1' : 'Theater 2',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'America/New_York'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'America/New_York'
                },
                extendedProperties: {
                    private: {
                        'tsl-scheduler': 'true',
                        'tsl-version': '2.1',
                        'tsl-supabase-id': event.supabaseId || '',
                        'tsl-supabase-table': event.supabaseTable || '',
                        'tsl-webpage-url': event.webpageUrl || '',
                        'tsl-theater': event.theater.toString()
                    }
                }
            };
            
            // Try update if has googleEventId
            if (event.googleEventId) {
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events/${event.googleEventId}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(eventData)
                        }
                    );
                    
                    if (response.ok) {
                        console.log(`Updated: ${event.title}`);
                        return;
                    }
                } catch (error) {
                    console.log('Update failed, will create new');
                }
            }
            
            // Create new
            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                }
            );
            
            if (!response.ok) {
                throw new Error(`API Error ${response.status}`);
            }
            
            const created = await response.json();
            event.googleEventId = created.id;
            console.log(`Created: ${event.title}`);
        }

        function updatePushStatus() {
            const needsPush = scheduledEvents.filter(e => !e.isPushed || e.isModified).length;
            const statusEl = document.getElementById('pushStatus');
            
            if (needsPush > 0) {
                statusEl.className = 'push-status needs-push';
                statusEl.textContent = `${needsPush} need push`;
            } else {
                statusEl.className = 'push-status synced';
                statusEl.textContent = 'All synced';
            }
        }

        // Week Navigation
        function updateWeekDisplay() {
            const start = new Date(currentWeekStart);
            const end = new Date(currentWeekStart);
            end.setDate(end.getDate() + 6);
            
            const formatDate = (date) => {
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                return `${month} ${date.getDate()}`;
            };
            
            document.getElementById('weekDisplay').textContent = 
                `${formatDate(start)} - ${formatDate(end)}`;
        }

        document.getElementById('prevWeek').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            updateWeekDisplay();
            renderSchedule();
        });

        document.getElementById('nextWeek').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            updateWeekDisplay();
            renderSchedule();
        });

        // Google Auth
        function initGoogleAuth() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: () => {}
            });
        }

        function initOAuth() {
            window.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        updateSigninStatus(true);
                        
                        // Auto-sync after connecting!
                        await syncWithGoogle();
                    }
                }
            });
        }

        function updateSigninStatus(isSignedIn) {
            const authButton = document.getElementById('authButton');
            const syncStatus = document.getElementById('syncStatus');
            const syncButton = document.getElementById('syncWithGoogle');
            const pushButton = document.getElementById('pushToGoogle');
            
            if (isSignedIn) {
                authButton.textContent = 'Sign Out';
                authButton.classList.add('sign-out');
                syncStatus.classList.add('connected');
                syncStatus.textContent = 'Connected to Google Calendar';
                syncButton.style.display = 'block';
                pushButton.style.display = 'block';
            } else {
                authButton.textContent = 'Connect Google Calendar';
                authButton.classList.remove('sign-out');
                syncStatus.classList.remove('connected');
                syncStatus.textContent = 'Not connected';
                accessToken = null;
                syncButton.style.display = 'none';
                pushButton.style.display = 'none';
            }
        }

        document.getElementById('authButton').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    updateSigninStatus(false);
                    showToast('Disconnected');
                });
            } else {
                if (window.tokenClient) {
                    window.tokenClient.requestAccessToken();
                }
            }
        });

        document.getElementById('syncWithGoogle').addEventListener('click', syncWithGoogle);
        document.getElementById('pushToGoogle').addEventListener('click', pushToGoogle);
        
        // Library search and filter
        document.getElementById('librarySearch').addEventListener('input', renderLibrary);
        document.getElementById('libraryFilter').addEventListener('change', renderLibrary);

        // Initialize
        window.addEventListener('load', async () => {
            console.log('TSL Scheduler v2.1 initializing...');
            
            autoLoad();
            await initLibrary();
            updateWeekDisplay();
            renderSchedule();
            
            initGoogleAuth();
            initOAuth();
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
            
            console.log('Initialization complete');
        });
    </script>
</body>
</html>
