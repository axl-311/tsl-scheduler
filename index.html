<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Scheduler v2.6 - Draft/Publish</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version {
            font-size: 12px;
            background: #34c759;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.draft {
            background: #fff3cd;
            color: #856404;
        }

        .status.published {
            background: #d4edda;
            color: #155724;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0051d5;
        }

        .btn-secondary {
            background: #f0f0f2;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e0e0e2;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30a852;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .btn-warning:hover {
            background: #e68600;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Controls */
        .controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .week-display {
            font-size: 16px;
            font-weight: 500;
            min-width: 350px;
            text-align: center;
        }

        .control-actions {
            display: flex;
            gap: 10px;
        }

        /* Main Layout */
        .main {
            display: flex;
            gap: 20px;
        }

        /* Library Panel */
        .library {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 220px);
            display: flex;
            flex-direction: column;
        }

        .library-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-count {
            font-size: 14px;
            color: #86868b;
            font-weight: normal;
        }

        .library-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .library-items {
            flex: 1;
            overflow-y: auto;
        }

        .library-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: move;
            background: #f0f0f2;
            transition: all 0.2s;
            user-select: none;
            border-left: 4px solid transparent;
        }

        .library-item.movie {
            border-left-color: #007aff;
            background: #e8f4ff;
        }

        .library-item.event {
            border-left-color: #e74c43;
            background: #ffe8e6;
        }

        .library-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .library-item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .library-item-info {
            font-size: 12px;
            color: #86868b;
        }

        /* Schedule Grid */
        .schedule {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px 20px 20px 80px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .days-grid {
            display: flex;
            gap: 4px;
        }

        .day-column {
            flex: 1;
            min-width: 310px;
        }

        .day-header {
            background: #f0f0f2;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            margin-bottom: 2px;
        }

        .theaters {
            display: flex;
            gap: 2px;
        }

        .theater {
            flex: 1;
            position: relative;
            background: #fafafa;
            border-radius: 0 0 8px 8px;
        }

        .theater-header {
            background: #e8e8e8;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .theater-grid {
            position: relative;
            height: 960px;
            border-left: 1px solid #e0e0e0;
        }

        .time-slot {
            height: 80px;
            border-bottom: 1px solid #e8e8e8;
            position: relative;
        }

        .time-label {
            position: absolute;
            left: -65px;
            width: 55px;
            text-align: right;
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
            top: -10px;
            padding-right: 8px;
        }

        /* Event Blocks */
        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 8px;
            border-radius: 6px;
            cursor: move;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }

        .event-block * {
            pointer-events: none;
            user-select: none;
        }

        .event-block.movie-t1 {
            background: #a5dceb;
        }

        .event-block.movie-t2 {
            background: #4bc4a5;
        }

        .event-block.event {
            background: #e74c43;
            color: white;
        }

        .event-block:hover .delete-btn {
            opacity: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-time {
            font-size: 11px;
            opacity: 0.8;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            line-height: 1;
            pointer-events: auto !important;
        }

        .delete-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        /* Drag Preview */
        .drag-preview {
            position: absolute;
            left: 4px;
            right: 4px;
            height: 60px;
            background: rgba(0,122,255,0.2);
            border: 2px dashed #007aff;
            border-radius: 6px;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #007aff;
            font-weight: 600;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1d1d1f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>
                    TSL Scheduler
                    <span class="version">v2.6</span>
                </h1>
            </div>
            <div class="header-actions">
                <div class="status draft" id="statusBadge">DRAFT</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="week-nav">
                <button class="btn btn-secondary" id="prevWeek">Prev</button>
                <div class="week-display" id="weekDisplay">Loading...</div>
                <button class="btn btn-secondary" id="nextWeek">Next</button>
            </div>
            <div class="control-actions">
                <button class="btn btn-primary" id="refreshBtn">Refresh Library</button>
                <button class="btn btn-warning" id="saveDraftBtn">Save Draft</button>
                <button class="btn btn-success" id="publishBtn">Publish Schedule</button>
                <button class="btn btn-secondary" id="clearBtn">Clear Schedule</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Library -->
            <div class="library">
                <div class="library-header">
                    <span>Library</span>
                    <span class="library-count" id="libCount">(0)</span>
                </div>
                <select class="library-search" id="recentFilter" style="margin-bottom: 10px;">
                    <option value="all">All Items</option>
                    <option value="30" selected>Recent (30 days)</option>
                    <option value="7">This Week (7 days)</option>
                    <option value="1">Today</option>
                </select>
                <input type="text" class="library-search" id="search" placeholder="Search...">
                <div class="library-items" id="library">
                    <div class="empty-state">
                        <div class="empty-state-icon">Library</div>
                        <div>Import from database to get started</div>
                    </div>
                </div>
            </div>

            <!-- Schedule -->
            <div class="schedule">
                <div class="days-grid" id="schedule"></div>
            </div>
        </div>
    </div>

    <script>
/**
 * TSL SCHEDULER v3.0 - COMPLETE FIXED SCRIPT SECTION
 *
 * INSTRUCTIONS:
 * 1. Open your index.html on GitHub
 * 2. Find the <script> tag (around line 800)
 * 3. Select from <script> to </script>
 * 4. Replace with this ENTIRE file
 * 5. Commit and deploy
 */

// ==========================================
// SUPABASE & STATE
// ==========================================
const SUPABASE_URL = 'https://zbzdmobwwugmmjjqvtwg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpiemRtb2J3d3VnbW1qanF2dHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA2NjUwMzgsImV4cCI6MjA0NjI0MTAzOH0.AXvBxHdj_KUu2NsWJxaUqrT0t_0Yx7Qp9cDxOtlFfKw';
const WORDPRESS_URL = 'https://axlentertainment.com';

let supabase = null;
let currentWeek = new Date();
let library = [];
let scheduled = []; // ALL events across all weeks
let draggedItem = null;
let dragOffset = 0;
let weekStatuses = {}; // Track status per week
window.libraryItemsCache = {};

// ==========================================
// INITIALIZATION
// ==========================================
async function init() {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const today = new Date();
    const dayOfWeek = today.getDay();
    const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
    currentWeek = new Date(today);
    currentWeek.setDate(today.getDate() + daysUntilFriday);
    currentWeek.setHours(0, 0, 0, 0);

    await loadFromWordPress();
    await importFromSupabase();
    setWeek(0);
}

// ==========================================
// WEEK MANAGEMENT
// ==========================================
function getWeekKey() {
    const friday = new Date(currentWeek);
    friday.setHours(0, 0, 0, 0);
    return friday.toISOString().split('T')[0];
}

function getCurrentWeekStatus() {
    const key = getWeekKey();
    return weekStatuses[key] || 'draft';
}

function setCurrentWeekStatus(status) {
    const key = getWeekKey();
    weekStatuses[key] = status;
}

function setWeek(offset) {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
    const thisFriday = new Date(today);
    thisFriday.setDate(today.getDate() + daysUntilFriday);
    thisFriday.setHours(0, 0, 0, 0);

    currentWeek = new Date(thisFriday);
    currentWeek.setDate(thisFriday.getDate() + (offset * 7));

    updateWeekDisplay();
    updateStatusBadge();
    renderSchedule();
}

function updateWeekDisplay() {
    const friday = new Date(currentWeek);
    const monday = new Date(currentWeek);
    monday.setDate(friday.getDate() + 3);

    const options = { month: 'short', day: 'numeric' };
    document.getElementById('current-week').textContent =
        `${friday.toLocaleDateString('en-US', options)} - ${monday.toLocaleDateString('en-US', options)}`;
}

function updateStatusBadge() {
    const status = getCurrentWeekStatus();
    const badge = document.querySelector('.status-badge');

    badge.textContent = status === 'published' ? 'Published' : 'Draft';
    badge.className = 'status-badge ' + (status === 'published' ? 'published' : 'draft');
}

// ==========================================
// SAVE DRAFT - FIXED WITH VALIDATION
// ==========================================
async function saveDraft() {
    try {
        // ✅ NEW: Validate events before saving
        const validatedEvents = await validateEvents(scheduled);

        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                events: validatedEvents,
                weekStatuses: weekStatuses
            })
        });

        const data = await response.json();

        if (data.success) {
            // ✅ NEW: Update local state with cleaned data
            scheduled = validatedEvents;
            setCurrentWeekStatus('draft');
            updateStatusBadge();

            // ✅ NEW: Show stats if orphans removed
            if (data.stats && data.stats.orphaned_removed > 0) {
                showToast(`Draft saved! (${data.stats.orphaned_removed} orphaned events removed)`);
            } else {
                showToast('Draft saved!');
            }

            renderSchedule();
        } else {
            showToast('Failed to save draft');
        }
    } catch (error) {
        console.error('Save error:', error);
        showToast('Error saving draft');
    }
}

// ==========================================
// PUBLISH SCHEDULE - FIXED WITH REPLACE STRATEGY
// ==========================================
async function publishSchedule() {
    // Get current week boundaries
    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    // Filter to current week events only
    const currentWeekEvents = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate >= weekStart && eventDate <= weekEnd;
    });

    if (currentWeekEvents.length === 0) {
        showToast('Nothing to publish for this week!');
        return;
    }

    // ✅ NEW: Validate events have WordPress posts
    const validatedEvents = await validateEvents(currentWeekEvents);

    if (validatedEvents.length === 0) {
        showToast('No valid events to publish! All events missing WordPress posts.');
        return;
    }

    // ✅ NEW: Warn if some events skipped
    if (validatedEvents.length < currentWeekEvents.length) {
        const orphanCount = currentWeekEvents.length - validatedEvents.length;
        if (!confirm(`${orphanCount} events don't have WordPress posts and will be skipped. Continue?`)) {
            return;
        }
    }

    if (!confirm(`Publish ${validatedEvents.length} events for this week? This will create WooCommerce ticket products.`)) {
        return;
    }

    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                events: validatedEvents,
                weekKey: getWeekKey()
            })
        });

        const data = await response.json();

        if (data.success) {
            setCurrentWeekStatus('published');
            updateStatusBadge();

            // ✅ NEW: Show detailed stats
            let message = 'Schedule published!';
            if (data.stats) {
                message += ` (${data.stats.events_published} events, ${data.stats.posts_updated} posts updated)`;
            }
            showToast(message);

            renderSchedule();
        } else {
            showToast('Failed to publish schedule');
        }
    } catch (error) {
        console.error('Publish error:', error);
        showToast('Error publishing schedule');
    }
}

// ==========================================
// LOAD FROM WORDPRESS - FIXED WITH VALIDATION
// ==========================================
async function loadFromWordPress() {
    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/load`);
        const data = await response.json();

        if (data.success) {
            if (Array.isArray(data.events)) {
                scheduled = data.events;
            } else if (data.events && typeof data.events === 'object') {
                scheduled = Object.values(data.events);
            } else {
                scheduled = [];
            }

            if (data.weekStatuses && typeof data.weekStatuses === 'object') {
                weekStatuses = data.weekStatuses;
            } else {
                weekStatuses = {};
            }

            // Convert date strings to Date objects
            scheduled.forEach(event => {
                if (event.startTime && typeof event.startTime === 'string') {
                    event.startTime = new Date(event.startTime);
                }

                // Normalize actualDate format
                if (event.actualDate && event.actualDate.includes('T')) {
                    const oldDate = new Date(event.actualDate);
                    const year = oldDate.getFullYear();
                    const month = String(oldDate.getMonth() + 1).padStart(2, '0');
                    const day = String(oldDate.getDate()).padStart(2, '0');
                    const hours = String(oldDate.getHours()).padStart(2, '0');
                    const minutes = String(oldDate.getMinutes()).padStart(2, '0');
                    event.actualDate = `${year}-${month}-${day} ${hours}:${minutes}:00`;
                }
            });

            // ✅ NEW: Remove events without required fields
            const beforeCount = scheduled.length;
            scheduled = scheduled.filter(event => {
                return event.supabaseId && (event.startTime || event.actualDate);
            });
            const removedCount = beforeCount - scheduled.length;

            if (removedCount > 0) {
                console.log(`Removed ${removedCount} invalid events on load`);
            }

            updateStatusBadge();
            renderSchedule();
        } else {
            scheduled = [];
            weekStatuses = {};
            updateStatusBadge();
        }
    } catch (error) {
        console.error('Load error:', error);
        scheduled = [];
        weekStatuses = {};
        updateStatusBadge();
        showToast('Error loading schedule');
    }
}

// ==========================================
// CLEAR SCHEDULE - IMPROVED
// ==========================================
function clearSchedule() {
    if (!confirm('Clear this week\'s schedule? This cannot be undone.')) {
        return;
    }

    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const beforeCount = scheduled.length;

    scheduled = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate < weekStart || eventDate > weekEnd;
    });

    const clearedCount = beforeCount - scheduled.length;

    setCurrentWeekStatus('draft');
    renderSchedule();
    saveDraft(); // ✅ Auto-save after clear

    showToast(`Cleared ${clearedCount} event(s) from this week`);
}

// ==========================================
// DELETE EVENT - IMPROVED
// ==========================================
function deleteEvent(scheduleId) {
    const index = scheduled.findIndex(e => e.scheduleId === scheduleId);

    if (index === -1) {
        showToast('Event not found');
        return;
    }

    const event = scheduled[index];

    if (confirm(`Delete ${event.title}?`)) {
        scheduled.splice(index, 1);
        renderSchedule();
        saveDraft(); // ✅ Auto-save after delete
        showToast('Event deleted');
    }
}

// ==========================================
// NEW: VALIDATION FUNCTIONS
// ==========================================
async function validateEvents(events) {
    const validEvents = [];
    const supabaseIds = [...new Set(events.map(e => e.supabaseId).filter(id => id))];
    const existingPosts = await checkPostsExist(supabaseIds);

    for (const event of events) {
        const supabaseId = event.supabaseId;

        if (!supabaseId) {
            console.warn('Event missing supabaseId:', event.title);
            continue;
        }

        if (existingPosts.has(supabaseId)) {
            validEvents.push(event);
        } else {
            console.warn(`Event ${event.title} (${supabaseId}) has no WordPress post`);
        }
    }

    return validEvents;
}

async function checkPostsExist(supabaseIds) {
    if (supabaseIds.length === 0) {
        return new Set();
    }

    const existingSet = new Set();

    for (const id of supabaseIds) {
        if (window.libraryItemsCache && window.libraryItemsCache[id]) {
            existingSet.add(id);
        }
    }

    return existingSet;
}

// ==========================================
// NEW: MANUAL CLEANUP
// ==========================================
async function manualCleanup() {
    if (!confirm('Clean up all orphaned events? This will remove events that don\'t have WordPress posts.')) {
        return;
    }

    try {
        const response = await fetch(`${WORDPRESS_URL}/wp-json/tsl-scheduler/v1/cleanup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success && data.stats) {
            showToast(`Cleanup complete! Removed ${data.stats.removed} orphaned event(s)`);
            await loadFromWordPress();
        } else {
            showToast('Cleanup failed');
        }
    } catch (error) {
        console.error('Cleanup error:', error);
        showToast('Error during cleanup');
    }
}

// ==========================================
// SUPABASE IMPORT
// ==========================================
async function importFromSupabase() {
    try {
        const { data: movies, error: moviesError } = await supabase
            .from('Movies')
            .select('*')
            .eq('status', 'Published')
            .order('original_title');

        const { data: performances, error: performancesError } = await supabase
            .from('Performances')
            .select('*')
            .order('EventTitle');

        if (moviesError) throw moviesError;
        if (performancesError) throw performancesError;

        library = [];

        if (movies) {
            movies.forEach(movie => {
                const runtimeMatch = movie.runtime?.match(/(\d+)/);
                const minutes = runtimeMatch ? parseInt(runtimeMatch[1]) : 120;

                window.libraryItemsCache[movie.id] = {
                    id: movie.id,
                    title: movie.original_title,
                    duration: minutes,
                    type: 'movie',
                    supabaseId: movie.id,
                    table: 'Movies'
                };

                library.push(window.libraryItemsCache[movie.id]);
            });
        }

        if (performances) {
            performances.forEach(performance => {
                const runtimeMatch = performance.Runtime?.match(/(\d+)/);
                const minutes = runtimeMatch ? parseInt(runtimeMatch[1]) : 120;

                window.libraryItemsCache[performance.id] = {
                    id: performance.id,
                    title: performance.EventTitle,
                    duration: minutes,
                    type: 'performance',
                    supabaseId: performance.id,
                    table: 'Performances'
                };

                library.push(window.libraryItemsCache[performance.id]);
            });
        }

        renderLibrary();
        showToast('Library imported from Supabase!');
    } catch (error) {
        console.error('Import error:', error);
        showToast('Error importing from Supabase');
    }
}

// ==========================================
// LIBRARY RENDERING
// ==========================================
function renderLibrary() {
    const container = document.getElementById('library-items');
    const searchTerm = document.getElementById('library-search').value.toLowerCase();
    const typeFilter = document.getElementById('library-type-filter').value;

    let filtered = library;

    if (searchTerm) {
        filtered = filtered.filter(item =>
            item.title.toLowerCase().includes(searchTerm)
        );
    }

    if (typeFilter !== 'all') {
        filtered = filtered.filter(item => item.type === typeFilter);
    }

    container.innerHTML = '';

    filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'library-item';
        div.draggable = true;
        div.innerHTML = `
            <div class="lib-title">${item.title}</div>
            <div class="lib-meta">${item.duration}min • ${item.type}</div>
        `;

        div.addEventListener('dragstart', e => {
            draggedItem = { ...item, fromSchedule: false };
            dragOffset = 0;
            e.dataTransfer.effectAllowed = 'copy';
        });

        container.appendChild(div);
    });
}

// ==========================================
// SCHEDULE RENDERING
// ==========================================
function renderSchedule() {
    renderScheduledEvents();
    renderTimeLabels();
}

function renderScheduledEvents() {
    document.querySelectorAll('.scheduled-event').forEach(el => el.remove());

    const weekStart = new Date(currentWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(currentWeek);
    weekEnd.setDate(weekEnd.getDate() + 3);
    weekEnd.setHours(23, 59, 59, 999);

    const currentWeekEvents = scheduled.filter(event => {
        const eventDate = new Date(event.startTime);
        return eventDate >= weekStart && eventDate <= weekEnd;
    });

    currentWeekEvents.forEach(event => {
        const eventDate = new Date(event.startTime);
        const friday = new Date(currentWeek);
        friday.setHours(0, 0, 0, 0);
        const dayDiff = Math.floor((eventDate - friday) / (1000 * 60 * 60 * 24));

        if (dayDiff < 0 || dayDiff > 3) return;

        const column = document.querySelector(`.day-column[data-day="${dayDiff}"][data-theater="${event.theater}"]`);
        if (!column) return;

        const div = document.createElement('div');
        div.className = 'scheduled-event';
        div.draggable = true;
        div.style.top = event.position + 'px';
        div.style.height = (event.duration * 80 / 60) + 'px';

        const hours = eventDate.getHours();
        const minutes = eventDate.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        const timeStr = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;

        div.innerHTML = `
            <div class="event-title">${event.title}</div>
            <div class="event-time">${timeStr} • ${event.duration}min</div>
            <button class="delete-btn" onclick="deleteEvent('${event.scheduleId}')">×</button>
        `;

        div.addEventListener('dragstart', e => {
            draggedItem = {
                ...event,
                fromSchedule: true,
                scheduleId: event.scheduleId
            };

            const rect = div.getBoundingClientRect();
            const y = e.clientY - rect.top;
            dragOffset = y;

            e.dataTransfer.effectAllowed = 'move';

            setTimeout(() => {
                div.style.opacity = '0.3';
            }, 0);
        });

        div.addEventListener('dragend', () => {
            div.style.opacity = '1';
        });

        column.appendChild(div);
    });
}

function renderTimeLabels() {
    const container = document.querySelector('.time-labels');
    container.innerHTML = '';

    for (let hour = 12; hour <= 23; hour++) {
        const div = document.createElement('div');
        div.className = 'time-label';
        const displayHour = hour > 12 ? hour - 12 : hour;
        const ampm = hour >= 12 ? 'PM' : 'AM';
        div.textContent = `${displayHour}${ampm}`;
        container.appendChild(div);
    }
}

// ==========================================
// DRAG & DROP
// ==========================================
function setupDragAndDrop() {
    document.querySelectorAll('.day-column').forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragenter', handleDragEnter);
        column.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = draggedItem?.fromSchedule ? 'move' : 'copy';

    const rect = this.getBoundingClientRect();
    let y = e.clientY - rect.top;
    if (dragOffset > 0) y = y - dragOffset;
    const snappedY = Math.round(y / 20) * 20;

    document.querySelectorAll('.drag-preview').forEach(p => p.remove());

    const preview = document.createElement('div');
    preview.className = 'drag-preview';
    preview.style.top = snappedY + 'px';
    preview.style.height = ((draggedItem?.duration || 120) * 80 / 60) + 'px';
    this.appendChild(preview);
}

function handleDragEnter(e) {
    e.preventDefault();
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    if (e.target === this) {
        this.classList.remove('drag-over');
        document.querySelectorAll('.drag-preview').forEach(p => p.remove());
    }
}

function handleDrop(e) {
    e.preventDefault();
    document.querySelectorAll('.drag-preview').forEach(p => p.remove());
    this.classList.remove('drag-over');

    if (!draggedItem) {
        showToast('Error: No item selected');
        return;
    }

    const rect = this.getBoundingClientRect();
    let y = e.clientY - rect.top;
    if (dragOffset > 0) y = y - dragOffset;
    const snappedY = Math.round(y / 20) * 20;

    const day = parseInt(this.dataset.day);
    const theater = parseInt(this.dataset.theater);

    const hour = Math.floor(snappedY / 80) + 12;
    const min = Math.round((snappedY % 80) / 80 * 60);

    const date = new Date(currentWeek);
    date.setDate(date.getDate() + day);
    date.setHours(hour, min, 0, 0);

    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const dayOfMonth = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const localDateTime = `${year}-${month}-${dayOfMonth} ${hours}:${minutes}:00`;

    if (draggedItem.fromSchedule && draggedItem.scheduleId) {
        const index = scheduled.findIndex(e => e.scheduleId === draggedItem.scheduleId);
        if (index !== -1) scheduled.splice(index, 1);
    }

    const newEvent = {
        id: draggedItem.id,
        title: draggedItem.title,
        duration: draggedItem.duration,
        type: draggedItem.type,
        supabaseId: draggedItem.supabaseId,
        table: draggedItem.table,
        day,
        theater,
        startTime: date,
        position: snappedY,
        scheduleId: `sched-${Date.now()}`,
        fromSchedule: false,
        actualDate: localDateTime
    };

    scheduled.push(newEvent);
    renderSchedule();
    showToast('Event added!');

    draggedItem = null;
    dragOffset = 0;
}

// ==========================================
// TOAST NOTIFICATIONS
// ==========================================
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show';

    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}

// ==========================================
// EVENT LISTENERS
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    init();

    document.getElementById('prev-week').addEventListener('click', () => setWeek(Math.floor((currentWeek - new Date()) / (1000 * 60 * 60 * 24 * 7)) - 1));
    document.getElementById('next-week').addEventListener('click', () => setWeek(Math.floor((currentWeek - new Date()) / (1000 * 60 * 60 * 24 * 7)) + 1));
    document.getElementById('save-draft').addEventListener('click', saveDraft);
    document.getElementById('publish-schedule').addEventListener('click', publishSchedule);
    document.getElementById('clear-schedule').addEventListener('click', clearSchedule);
    document.getElementById('import-supabase').addEventListener('click', importFromSupabase);
    document.getElementById('library-search').addEventListener('input', renderLibrary);
    document.getElementById('library-type-filter').addEventListener('change', renderLibrary);

    setupDragAndDrop();
});

    </script>
</body>
</html>
