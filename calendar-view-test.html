<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TSL Calendar — Month View</title>
  <style>
    body {
      font-family: Helvetica, Arial, sans-serif;
      margin: 0; padding: 0;
      background: #fff; color: #202124;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; border-bottom: 1px solid #dadce0;
    }
    .nav-group {
      display: flex; align-items: center; gap: 8px;
    }
    .nav-btn {
      background: #f1f3f4; border: 1px solid #dadce0; border-radius: 4px;
      padding: 6px 12px; cursor: pointer; font-size: 14px;
    }
    .nav-btn:hover { background: #e8eaed; }
    .month-label {
      font-size: 18px; font-weight: 500; text-align: center; flex: 1;
    }
    .calendar {
      display: grid; grid-template-columns: repeat(7, 1fr);
      border-top: 1px solid #dadce0; border-left: 1px solid #dadce0;
    }
    .day-header {
      background: #f8f9fa; text-align: center; font-weight: 500;
      padding: 8px; border-right: 1px solid #dadce0; border-bottom: 1px solid #dadce0;
      font-size: 12px;
    }
    .day {
      border-right: 1px solid #dadce0; border-bottom: 1px solid #dadce0;
      min-height: 100px; display: flex; flex-direction: column;
      padding: 2px 2px 0 2px; overflow: hidden;
    }
    .day.other { background: #f8f9fa; color: #9aa0a6; }
    .date-num { font-size: 12px; font-weight: 500; margin: 2px; }
    .events { flex: 1; overflow: hidden; }
    .event {
      font-size: 11px; padding: 2px 4px; margin: 1px 0;
      border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: white; cursor: pointer;
    }
    .event.events { background: #e74c3c; }
    .event.non-public { background: #f39c12; }
    .event.tbd { background: #3498db; }
    .event.theater-1 { background: #95a5a6; }
    .event.theater-2 { background: #27ae60; }
    .event.all-day { background: #dadce0; color: #202124; border: 1px dashed #9aa0a6; }
    .more { font-size: 10px; color: #5f6368; cursor: pointer; padding: 2px; }
    .legend {
      display: flex; justify-content: center; gap: 16px; padding: 12px;
      border-top: 1px solid #dadce0; font-size: 12px;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-color { width: 12px; height: 12px; border-radius: 2px; }
    #pdfBtn {
      margin-right: 12px; background: #1a73e8; color: white;
      border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer;
      font-size: 14px;
    }
    #pdfBtn:hover { background: #1765cc; }
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1000; }
    .modal-content {
      background: white; margin: 8% auto; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 500px; position: relative;
    }
    .modal-close { position: absolute; top: 10px; right: 15px; font-size: 22px; cursor: pointer; color: #5f6368; }
    .day-list { max-height: 60vh; overflow: auto; margin-top: 10px; }
    .day-list .event-row { padding: 6px 0; border-bottom: 1px solid #dadce0; font-size: 13px; }
  </style>
</head>
<body>
  <header>
    <div class="nav-group">
      <button class="nav-btn" id="prevBtn">‹</button>
      <button class="nav-btn" id="todayBtn">Today</button>
      <button class="nav-btn" id="nextBtn">›</button>
    </div>
    <div class="month-label" id="monthLabel">Loading…</div>
    <div class="nav-group">
      <button id="pdfBtn">Download PDF</button>
    </div>
  </header>

  <div class="calendar" id="calendarGrid"></div>

  <div class="legend">
    <div class="legend-item"><div class="legend-color" style="background:#e74c3c"></div> Events</div>
    <div class="legend-item"><div class="legend-color" style="background:#f39c12"></div> Non-Public</div>
    <div class="legend-item"><div class="legend-color" style="background:#3498db"></div> TBD</div>
    <div class="legend-item"><div class="legend-color" style="background:#95a5a6"></div> Theater 1</div>
    <div class="legend-item"><div class="legend-color" style="background:#27ae60"></div> Theater 2</div>
  </div>

  <!-- Modals -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="eventClose">&times;</span>
      <div id="eventDetails"></div>
    </div>
  </div>
  <div id="dayModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="dayClose">&times;</span>
      <div id="dayDetails"></div>
      <div class="day-list" id="dayList"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const API_KEY = 'AIzaSyDzisAik43Rr1xTJXg2bHXNF_XRTjjZsh8';
    const TIME_ZONE = 'America/New_York';
    const ALL_CALENDARS = {
      'events': '1ed95b09dcc5ea1a1e13267b6654eca3c892fc79c23e2e9edc1e271411967255@group.calendar.google.com',
      'non-public': '6b48156e2887ac486283a0d4a2f94b1d2ad4b1ac4dd7e19f2fc7e01dafe67700@group.calendar.google.com',
      'tbd': '7b77eba3cf2e9f4e0407d62c3acd2540170b31554d1698b71ea7eb3a11d58306@group.calendar.google.com',
      'theater-1': '007f10222d517076d028161a4cda7108e75444c18ef7ac0d79aee420313d1a7b@group.calendar.google.com',
      'theater-2': 'ed801a88ce91b43543ef4e87c34d1405a6e053c5254e55e2871f0d305ecc32c4@group.calendar.google.com'
    };
    let currentDate = new Date();
    let allEvents = [];

    function fmtTime(date) {
      return new Intl.DateTimeFormat('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:TIME_ZONE}).format(date);
    }
    function fmtDateLong(date) {
      return new Intl.DateTimeFormat('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric',timeZone:TIME_ZONE}).format(date);
    }

    function getMonthRange(y,m){
      const first = new Date(y,m,1);
      const last = new Date(y,m+1,0);
      const start = new Date(first);
      start.setDate(first.getDate()-first.getDay());
      const end = new Date(last);
      end.setDate(last.getDate()+(6-last.getDay()));
      return {start,end};
    }

    async function fetchEvents(){
      const y=currentDate.getFullYear(), m=currentDate.getMonth();
      const {start,end}=getMonthRange(y,m);
      const timeMin=start.toISOString(), timeMax=end.toISOString();
      allEvents=[];
      const promises=Object.entries(ALL_CALENDARS).map(([type,id])=>fetchOne(type,id,timeMin,timeMax));
      const results=await Promise.all(promises);
      results.forEach(arr=>allEvents.push(...arr));
    }
    async function fetchOne(type,id,timeMin,timeMax){
      let events=[],pageToken=null;
      do{
        const url=new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(id)}/events`);
        url.searchParams.set('timeMin',timeMin);
        url.searchParams.set('timeMax',timeMax);
        url.searchParams.set('singleEvents','true');
        url.searchParams.set('orderBy','startTime');
        url.searchParams.set('maxResults','250');
        url.searchParams.set('timeZone',TIME_ZONE);
        if(pageToken) url.searchParams.set('pageToken',pageToken);
        url.searchParams.set('key',API_KEY);
        const res=await fetch(url);
        const data=await res.json();
        (data.items||[]).forEach(it=>{
          let start,end,allDay=false;
          if(it.start.dateTime){
            start=new Date(it.start.dateTime); end=new Date(it.end.dateTime);
          } else {
            allDay=true; start=new Date(it.start.date+'T00:00:00'); end=new Date(it.end.date+'T00:00:00');
          }
          events.push({title:it.summary||'Untitled',start,end,allDay,calendar:type,description:it.description||''});
        });
        pageToken=data.nextPageToken;
      } while(pageToken);
      return events;
    }

    function eventsOnDate(date){
      const y=date.getFullYear(), m=date.getMonth(), d=date.getDate();
      return allEvents.filter(ev=>{
        if(ev.allDay){
          return ev.start<=date && ev.end>date;
        } else {
          return ev.start.getFullYear()===y&&ev.start.getMonth()===m&&ev.start.getDate()===d;
        }
      });
    }

    function renderCalendar(){
      const y=currentDate.getFullYear(), m=currentDate.getMonth();
      const {start}=getMonthRange(y,m);
      document.getElementById('monthLabel').textContent=currentDate.toLocaleString('en-US',{month:'long',year:'numeric'});
      const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
        const el=document.createElement('div'); el.className='day-header'; el.textContent=d; grid.appendChild(el);
      });
      for(let i=0;i<42;i++){
        const day=new Date(start); day.setDate(start.getDate()+i);
        const cell=document.createElement('div'); cell.className='day';
        if(day.getMonth()!==m) cell.classList.add('other');
        const dn=document.createElement('div'); dn.className='date-num'; dn.textContent=day.getDate(); cell.appendChild(dn);
        const evBox=document.createElement('div'); evBox.className='events';
        const evs=eventsOnDate(day); const max=3;
        evs.slice(0,max).forEach(ev=>{
          const e=document.createElement('div'); e.className=`event ${ev.calendar}${ev.allDay?' all-day':''}`;
          e.textContent=ev.allDay?ev.title:`${fmtTime(ev.start)} ${ev.title}`;
          e.onclick=()=>showEvent(ev); evBox.appendChild(e);
        });
        if(evs.length>max){
          const more=document.createElement('div'); more.className='more'; more.textContent=`+${evs.length-max} more`;
          more.onclick=()=>showDay(day,evs); evBox.appendChild(more);
        }
        cell.appendChild(evBox); grid.appendChild(cell);
      }
    }

    function showEvent(ev){
      const box=document.getElementById('eventDetails');
      box.innerHTML=`<h3>${ev.title}</h3>
        <p><strong>Date:</strong> ${fmtDateLong(ev.start)}</p>
        <p><strong>Time:</strong> ${ev.allDay?'All day':fmtTime(ev.start)+' - '+fmtTime(ev.end)}</p>
        ${ev.description?'<p>'+ev.description+'</p>':''}`;
      document.getElementById('eventModal').style.display='block';
    }
    function showDay(date,evs){
      const list=document.getElementById('dayList'); const title=document.getElementById('dayDetails');
      title.innerHTML=`<h3>${fmtDateLong(date)}</h3>`; list.innerHTML='';
      evs.forEach(ev=>{
        const row=document.createElement('div'); row.className='event-row';
        row.textContent=ev.allDay?`All day — ${ev.title}`:`${fmtTime(ev.start)} — ${ev.title}`;
        row.onclick=()=>showEvent(ev); list.appendChild(row);
      });
      document.getElementById('dayModal').style.display='block';
    }

    function closeModal(id){ document.getElementById(id).style.display='none'; }

    async function loadCal(){ await fetchEvents(); renderCalendar(); }

    document.getElementById('prevBtn').onclick=()=>{currentDate.setMonth(currentDate.getMonth()-1);loadCal();};
    document.getElementById('nextBtn').onclick=()=>{currentDate.setMonth(currentDate.getMonth()+1);loadCal();};
    document.getElementById('todayBtn').onclick=()=>{currentDate=new Date();loadCal();};
    document.getElementById('eventClose').onclick=()=>closeModal('eventModal');
    document.getElementById('dayClose').onclick=()=>closeModal('dayModal');
    window.onclick=(e)=>{if(e.target.id==='eventModal')closeModal('eventModal');if(e.target.id==='dayModal')closeModal('dayModal');};

    // PDF Export
    document.getElementById('pdfBtn').onclick=()=>{
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF({orientation:'landscape',unit:'pt',format:'letter'});
      doc.html(document.body,{
        callback:function(pdf){
          const name=`TSL-Calendar-${currentDate.toLocaleString('en-US',{month:'long'})}-${currentDate.getFullYear()}.pdf`;
          pdf.save(name);
        },
        x:20,y:20,html2canvas:{scale:0.6}
      });
    };

    window.onload=loadCal;
    window.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft'){currentDate.setMonth(currentDate.getMonth()-1);loadCal();}
      else if(e.key==='ArrowRight'){currentDate.setMonth(currentDate.getMonth()+1);loadCal();}
      else if(e.key.toLowerCase()==='t'){currentDate=new Date();loadCal();}
    });
  </script>
</body>
</html>
