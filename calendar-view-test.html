<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            background: #fff;
            color: #3c4043;
            font-size: 14px;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #dadce0;
            padding: 8px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            font-size: 22px;
            color: #3c4043;
            font-weight: 400;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-btn {
            border: none;
            background: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 16px;
        }

        .nav-btn:hover {
            background: #f1f3f4;
        }

        .today-btn {
            background: none;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #3c4043;
        }

        .today-btn:hover {
            background: #f8f9fa;
        }

        .month-title {
            font-size: 22px;
            color: #3c4043;
            font-weight: 400;
            margin-left: 16px;
            min-width: 200px;
        }

        .view-tabs {
            display: flex;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: #fff;
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #5f6368;
            border-right: 1px solid #dadce0;
        }

        .view-tab:last-child {
            border-right: none;
        }

        .view-tab.active {
            background: #e8f0fe;
            color: #1a73e8;
            font-weight: 500;
        }

        .view-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        .calendar-container {
            height: calc(100vh - 64px);
            display: flex;
            flex-direction: column;
        }

        /* Month View Styles */
        .month-view {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid #dadce0;
            background: #fff;
        }

        .month-day-header {
            padding: 12px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: #70757a;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-right: 1px solid #dadce0;
        }

        .month-day-header:last-child {
            border-right: none;
        }

        .month-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }

        .month-day {
            border-right: 1px solid #dadce0;
            border-bottom: 1px solid #dadce0;
            position: relative;
            background: #fff;
            overflow: hidden;
            min-height: 100px;
        }

        .month-day:nth-child(7n) {
            border-right: none;
        }

        .month-day.other-month {
            background: #fafafa;
        }

        .month-day.today {
            background: #e8f0fe;
        }

        .month-day-number {
            padding: 8px;
            font-size: 12px;
            color: #3c4043;
            font-weight: 400;
        }

        .month-day.other-month .month-day-number {
            color: #9aa0a6;
        }

        .month-day.today .month-day-number {
            background: #1a73e8;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .month-events {
            padding: 0 4px 4px 4px;
            height: calc(100% - 32px);
            overflow: hidden;
        }

        .month-event {
            background: #1a73e8;
            color: white;
            font-size: 11px;
            padding: 1px 4px;
            margin-bottom: 1px;
            border-radius: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            line-height: 14px;
        }

        /* Week View Styles */
        .week-view {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .week-header {
            display: flex;
            border-bottom: 1px solid #dadce0;
            background: #fff;
            height: 80px;
        }

        .time-column-header {
            width: 60px;
            border-right: 1px solid #dadce0;
            background: #fafafa;
        }

        .week-day-header {
            flex: 1;
            border-right: 1px solid #dadce0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .week-day-header:last-child {
            border-right: none;
        }

        .week-day-name {
            font-size: 11px;
            color: #70757a;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
        }

        .week-day-number {
            font-size: 24px;
            color: #3c4043;
            font-weight: 400;
        }

        .week-day-header.today .week-day-number {
            background: #1a73e8;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .week-body {
            flex: 1;
            display: flex;
            overflow-y: auto;
        }

        .time-column {
            width: 60px;
            border-right: 1px solid #dadce0;
            background: #fafafa;
        }

        .time-slot {
            height: 60px;
            padding: 4px 8px 4px 4px;
            font-size: 10px;
            color: #70757a;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
        }

        .week-days {
            flex: 1;
            display: flex;
        }

        .week-day-column {
            flex: 1;
            border-right: 1px solid #dadce0;
            position: relative;
            background: #fff;
        }

        .week-day-column:last-child {
            border-right: none;
        }

        .theater-lanes {
            height: 100%;
            display: flex;
        }

        .theater-lane {
            flex: 1;
            border-right: 1px solid #e8e8e8;
            position: relative;
            background-image: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 59px,
                #e8e8e8 59px,
                #e8e8e8 60px
            );
        }

        .theater-lane:last-child {
            border-right: none;
        }

        .theater-lane-label {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            text-align: center;
            font-size: 10px;
            color: #70757a;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px;
            border-radius: 2px;
            z-index: 5;
        }

        .week-event {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 4px;
            padding: 2px 4px;
            overflow: hidden;
            font-size: 11px;
            color: white;
            cursor: pointer;
            z-index: 10;
            line-height: 1.2;
        }

        .week-event:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 15;
        }

        /* Event Colors */
        .event-events { background: #d93025; }
        .event-non-public { background: #f9ab00; }
        .event-tbd { background: #1a73e8; }
        .event-theater-1 { background: #9aa0a6; }
        .event-theater-2 { background: #137333; }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #5f6368;
            font-size: 16px;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fce8e6;
            color: #d93025;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #fad2cf;
            max-width: 500px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.28);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #5f6368;
        }

        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                height: auto;
                min-height: 64px;
            }

            .theater-lane-label {
                font-size: 9px;
            }

            .week-event {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">TSL Calendar</div>
            <div class="nav-controls">
                <button class="today-btn" onclick="goToToday()">Today</button>
                <button class="nav-btn" onclick="changeView(-1)">‹</button>
                <button class="nav-btn" onclick="changeView(1)">›</button>
                <div class="month-title" id="dateTitle">Loading...</div>
            </div>
        </div>
        <div class="view-tabs">
            <button class="view-tab active" onclick="switchView('month')">Month</button>
            <button class="view-tab" onclick="switchView('week')">Week</button>
        </div>
    </div>

    <div class="calendar-container">
        <div id="loadingMessage" class="loading">Loading calendar...</div>
        <div id="errorContainer"></div>
        
        <!-- Month View -->
        <div class="month-view" id="monthView" style="display: none;">
            <div class="month-header" id="monthHeader"></div>
            <div class="month-grid" id="monthGrid"></div>
        </div>

        <!-- Week View -->
        <div class="week-view" id="weekView">
            <div class="week-header">
                <div class="time-column-header"></div>
                <div id="weekHeader"></div>
            </div>
            <div class="week-body">
                <div class="time-column" id="timeColumn"></div>
                <div class="week-days" id="weekDays"></div>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_KEY = 'AIzaSyDzisAik43Rr1xTJXg2bHXNF_XRTjjZsh8';
        
        const CALENDARS = {
            'events': '1ed95b09dcc5ea1a1e13267b6654eca3c892fc79c23e2e9edc1e271411967255@group.calendar.google.com',
            'non-public': '6b48156e2887ac486283a0d4a2f94b1d2ad4b1ac4dd7e19f2fc7e01dafe67700@group.calendar.google.com',
            'tbd': '7b77eba3cf2e9f4e0407d62c3acd2540170b31554d1698b71ea7eb3a11d58306@group.calendar.google.com',
            'theater-1': '007f10222d517076d028161a4cda7108e75444c18ef7ac0d79aee420313d1a7b@group.calendar.google.com',
            'theater-2': 'ed801a88ce91b43543ef4e87c34d1405a6e053c5254e55e2871f0d305ecc32c4@group.calendar.google.com'
        };

        let currentDate = new Date();
        let currentView = 'month';
        let allEvents = [];

        function convertToTheaterHour(actualHour) {
            if (actualHour >= 14) return actualHour - 14;
            if (actualHour === 0) return 10;
            return -1;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function isSameMonth(date, month, year) {
            return date.getMonth() === month && date.getFullYear() === year;
        }

        function getDateRange() {
            if (currentView === 'month') {
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(firstDay.getDate() - firstDay.getDay());
                const endDate = new Date(lastDay);
                endDate.setDate(lastDay.getDate() + (6 - lastDay.getDay()));
                return { start: startDate, end: endDate };
            } else {
                // Week view
                const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - currentDate.getDay());
                weekStart.setHours(0, 0, 0, 0);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                return { start: weekStart, end: weekEnd };
            }
        }

        async function fetchCalendarEvents() {
            const { start, end } = getDateRange();
            allEvents = [];
            
            try {
                for (const [calendarType, calendarId] of Object.entries(CALENDARS)) {
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?` +
                        `timeMin=${start.toISOString()}&` +
                        `timeMax=${end.toISOString()}&` +
                        `showDeleted=false&` +
                        `singleEvents=true&` +
                        `orderBy=startTime&` +
                        `key=${API_KEY}`;

                    const response = await fetch(url);
                    if (!response.ok) continue;

                    const data = await response.json();
                    const events = data.items || [];

                    events.forEach(event => {
                        if (event.start && event.start.dateTime) {
                            allEvents.push({
                                title: event.summary || 'Untitled Event',
                                start: new Date(event.start.dateTime),
                                end: new Date(event.end.dateTime),
                                calendar: calendarType,
                                description: event.description || ''
                            });
                        }
                    });
                }

                allEvents.sort((a, b) => a.start - b.start);
                
            } catch (error) {
                console.error('Error fetching events:', error);
                throw error;
            }
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { start } = getDateRange();
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            document.getElementById('dateTitle').textContent = `${monthNames[month]} ${year}`;
            
            // Render headers
            const headerContainer = document.getElementById('monthHeader');
            headerContainer.innerHTML = '';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            dayNames.forEach(name => {
                const header = document.createElement('div');
                header.className = 'month-day-header';
                header.textContent = name;
                headerContainer.appendChild(header);
            });
            
            // Render calendar
            const gridContainer = document.getElementById('monthGrid');
            gridContainer.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(start);
                cellDate.setDate(start.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'month-day';
                
                if (!isSameMonth(cellDate, month, year)) {
                    dayCell.classList.add('other-month');
                }
                if (isToday(cellDate)) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'month-day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'month-events';
                
                const dayEvents = allEvents.filter(event => 
                    event.start.toDateString() === cellDate.toDateString()
                );
                
                dayEvents.slice(0, 3).forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `month-event event-${event.calendar}`;
                    eventElement.textContent = `${formatTime(event.start)} ${event.title}`;
                    eventElement.onclick = () => showEventDetails(event);
                    eventsContainer.appendChild(eventElement);
                });
                
                dayCell.appendChild(eventsContainer);
                gridContainer.appendChild(dayCell);
            }
        }

        function renderWeekView() {
            const { start } = getDateRange();
            const weekStart = new Date(start);
            
            document.getElementById('dateTitle').textContent = 
                `${weekStart.toLocaleDateString()} - ${new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString()}`;
            
            // Render time column
            const timeContainer = document.getElementById('weekTimeColumn');
            timeContainer.innerHTML = '';
            
            for (let hour = 14; hour <= 24; hour++) {
                const displayHour = hour % 24;
                const timeSlot = document.createElement('div');
                timeSlot.className = 'week-time-slot';
                const h = displayHour === 0 ? 12 : displayHour > 12 ? displayHour - 12 : displayHour;
                const period = displayHour < 12 ? 'AM' : 'PM';
                timeSlot.textContent = `${h} ${period}`;
                timeContainer.appendChild(timeSlot);
            }
            
            // Render week days
            const daysContainer = document.getElementById('weekDaysContainer');
            daysContainer.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                
                const dayColumn = document.createElement('div');
                dayColumn.className = 'week-day-column';
                
                // Day header
                const dayHeader = document.createElement('div');
                dayHeader.className = 'week-day-header';
                if (isToday(date)) dayHeader.classList.add('today');
                
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = date.getDate();
                
                dayHeader.innerHTML = `
                    <div class="week-day-name">${dayName}</div>
                    <div class="week-day-number">${dayNumber}</div>
                `;
                dayColumn.appendChild(dayHeader);
                
                // Day content with theater lanes
                const dayContent = document.createElement('div');
                dayContent.className = 'week-day-content';
                
                const theaterLanes = document.createElement('div');
                theaterLanes.className = 'theater-lanes';
                
                ['Theater 1', 'Theater 2'].forEach((theaterName, theaterIndex) => {
                    const lane = document.createElement('div');
                    lane.className = 'theater-lane';
                    
                    const label = document.createElement('div');
                    label.className = 'theater-lane-label';
                    label.textContent = theaterName;
                    lane.appendChild(label);
                    
                    // Add events for this day/theater
                    const dayEvents = allEvents.filter(event => {
                        const eventDate = event.start.toDateString() === date.toDateString();
                        const eventTheater = event.calendar === 'theater-1' ? 0 : 
                                           event.calendar === 'theater-2' ? 1 : 
                                           theaterIndex; // Default behavior for other calendars
                        return eventDate && eventTheater === theaterIndex;
                    });
                    
                    dayEvents.forEach(event => {
                        const theaterHour = convertToTheaterHour(event.start.getHours());
                        if (theaterHour >= 0) {
                            const top = theaterHour * 60 + (event.start.getMinutes() / 15) * 15;
                            const duration = (event.end - event.start) / 60000;
                            const height = Math.max((duration / 60) * 60, 20);
                            
                            const eventElement = document.createElement('div');
                            eventElement.className = 'week-event';
                            eventElement.style.top = `${top + 16}px`; // +16 for label space
                            eventElement.style.height = `${height}px`;
                            eventElement.title = `${event.title}\n${formatTime(event.start)} - ${formatTime(event.end)}`;
                            eventElement.onclick = () => showEventDetails(event);
                            
                            const dot = document.createElement('div');
                            dot.className = `event-dot dot-${event.calendar}`;
                            
                            const text = document.createElement('div');
                            text.className = 'event-text';
                            text.textContent = event.title;
                            
                            eventElement.appendChild(dot);
                            eventElement.appendChild(text);
                            
                            lane.appendChild(eventElement);
                        }
                    });
                    
                    theaterLanes.appendChild(lane);
                });
                
                dayContent.appendChild(theaterLanes);
                dayColumn.appendChild(dayContent);
                daysContainer.appendChild(dayColumn);
            }
        }

        function renderScheduleView() {
            const { start } = getDateRange();
            const weekStart = new Date(start);
            
            document.getElementById('dateTitle').textContent = 
                `${weekStart.toLocaleDateString()} - ${new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString()}`;
            
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            
            // Group events by day
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                
                const dayEvents = allEvents.filter(event => 
                    event.start.toDateString() === date.toDateString()
                ).sort((a, b) => a.start - b.start);
                
                if (dayEvents.length > 0) {
                    const daySection = document.createElement('div');
                    daySection.className = 'schedule-day-section';
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'schedule-day-header';
                    if (isToday(date)) dayHeader.classList.add('today');
                    
                    const dayName = date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    dayHeader.textContent = dayName;
                    
                    daySection.appendChild(dayHeader);
                    
                    dayEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'schedule-event';
                        eventElement.onclick = () => showEventDetails(event);
                        
                        const timeElement = document.createElement('div');
                        timeElement.className = 'schedule-time';
                        timeElement.textContent = formatTime(event.start);
                        
                        const contentElement = document.createElement('div');
                        contentElement.className = 'schedule-event-content';
                        
                        const dot = document.createElement('div');
                        dot.className = `event-dot dot-${event.calendar}`;
                        
                        const titleElement = document.createElement('div');
                        titleElement.className = 'schedule-event-title';
                        titleElement.textContent = event.title;
                        
                        const duration = Math.round((event.end - event.start) / 60000);
                        const hours = Math.floor(duration / 60);
                        const minutes = duration % 60;
                        const durationStr = hours > 0 ? 
                            (minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`) : 
                            `${minutes}m`;
                        
                        const theater = event.calendar === 'theater-1' ? 'Theater 1' : 
                                       event.calendar === 'theater-2' ? 'Theater 2' : '';
                        
                        const detailsText = theater ? `${durationStr} • ${theater}` : durationStr;
                        
                        const detailsElement = document.createElement('div');
                        detailsElement.className = 'schedule-event-details';
                        detailsElement.textContent = detailsText;
                        
                        contentElement.appendChild(dot);
                        contentElement.appendChild(titleElement);
                        
                        eventElement.appendChild(timeElement);
                        eventElement.appendChild(contentElement);
                        eventElement.appendChild(detailsElement);
                        
                        daySection.appendChild(eventElement);
                    });
                    
                    container.appendChild(daySection);
                }
            }
            
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #5f6368; padding: 40px;">
                        No events scheduled for this week
                    </div>
                `;
            }
        }

        function showEventDetails(event) {
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('modalContent');
            
            const duration = Math.round((event.end - event.start) / 60000);
            const hours = Math.floor(duration / 60);
            const minutes = duration % 60;
            const durationStr = hours > 0 ? 
                (minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`) : 
                `${minutes}m`;
            
            const calendarNames = {
                'events': 'Main Events',
                'non-public': 'Non-Public',
                'tbd': 'TBD (Tentative)',
                'theater-1': 'Theater 1',
                'theater-2': 'Theater 2'
            };
            
            content.innerHTML = `
                <h3 style="margin-bottom: 16px; font-size: 20px; color: #3c4043;">${event.title}</h3>
                <div style="color: #5f6368; line-height: 1.5;">
                    <p style="margin-bottom: 8px;"><strong>Date:</strong> ${event.start.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</p>
                    <p style="margin-bottom: 8px;"><strong>Time:</strong> ${formatTime(event.start)} - ${formatTime(event.end)}</p>
                    <p style="margin-bottom: 8px;"><strong>Duration:</strong> ${durationStr}</p>
                    <p style="margin-bottom: 8px;"><strong>Calendar:</strong> ${calendarNames[event.calendar]}</p>
                    ${event.description ? `<p style="margin-bottom: 8px;"><strong>Description:</strong> ${event.description}</p>` : ''}
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function switchView(view) {
            currentView = view;
            
            // Update tab styles
            document.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchView('${view}')"]`).classList.add('active');
            
            // Show/hide views
            document.getElementById('monthView').style.display = view === 'month' ? 'flex' : 'none';
            document.getElementById('weekView').style.display = view === 'week' ? 'flex' : 'none';
            
            loadCalendar();
        }

        function changeView(direction) {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            } else {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            }
            loadCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            loadCalendar();
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <div style="font-weight: 500; margin-bottom: 8px;">Unable to load calendar data</div>
                    <div style="font-size: 12px;">${message}</div>
                </div>
            `;
        }

        async function loadCalendar() {
            const loadingMessage = document.getElementById('loadingMessage');
            const monthView = document.getElementById('monthView');
            const weekView = document.getElementById('weekView');
            const errorContainer = document.getElementById('errorContainer');
            
            errorContainer.innerHTML = '';
            loadingMessage.style.display = 'block';
            monthView.style.display = 'none';
            weekView.style.display = 'none';
            
            try {
                await fetchCalendarEvents();
                
                if (currentView === 'month') {
                    renderMonthView();
                    monthView.style.display = 'flex';
                } else {
                    renderWeekView();
                    weekView.style.display = 'flex';
                }
                
                loadingMessage.style.display = 'none';
            } catch (error) {
                console.error('Failed to load calendar:', error);
                loadingMessage.style.display = 'none';
                showError('Please check your internet connection or try refreshing the page.');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Auto-refresh every 15 minutes
        setInterval(loadCalendar, 15 * 60 * 1000);

        // Initialize
        window.addEventListener('load', () => {
            switchView('month'); // Start with month view
        });
    </script>
</body>
</html>
