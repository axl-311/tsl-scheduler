<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time & Space Limited Calendar</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.4;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 48px 24px;
            min-height: 100vh;
        }

        .header {
            margin-bottom: 48px;
            border-bottom: 1px solid #000000;
            padding-bottom: 32px;
        }

        .brand {
            display: flex;
            align-items: baseline;
            gap: 16px;
            margin-bottom: 24px;
        }

        .brand h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #1a1a1a;
        }

        .brand .status {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .nav-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
        }

        .month-display {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .view-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 2px;
            gap: 2px;
        }

        .view-btn {
            background: none;
            border: none;
            color: #666;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .view-btn.active {
            background: white;
            color: #1a1a1a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-btn {
            background: none;
            border: 1px solid #000000;
            color: #666;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .nav-btn:hover {
            border-color: #1a1a1a;
            color: #1a1a1a;
        }

        .legend {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .special-events { background: #ef4444; }
        .movies { background: #3b82f6; }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #000000;
            border-radius: 8px;
            border: 2px solid #000000;
            overflow: hidden;
            margin-bottom: 48px;
        }

        .week-view {
            gap: 12px;
            background: transparent;
            border: none;
            grid-template-columns: repeat(7, 1fr);
        }

        .week-view .day-cell {
            background: white;
            border: 1px solid #000000;
            border-radius: 8px;
            min-height: 400px;
            padding: 16px 12px;
        }

        .week-view .day-header {
            background: #f8f8f8;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 12px 8px;
        }

        .day-header {
            background: #f8f8f8;
            padding: 16px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #666;
        }

        .day-cell {
            background: white;
            min-height: 120px;
            padding: 12px 8px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .day-cell.other-month {
            background: #fafafa;
            color: #ccc;
        }

        .day-number {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .other-month .day-number {
            color: #ccc;
        }

        .event {
            background: #f8f9fa;
            border-left: 3px solid #ef4444;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            line-height: 1.3;
            color: #1a1a1a;
            margin-bottom: 2px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: block;
        }

        .event:hover {
            background: #f1f5f9;
            transform: translateX(2px);
        }

        .event.movies {
            border-left-color: #3b82f6;
        }

        .event-time {
            font-size: 10px;
            color: #666;
            font-weight: 400;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: #666;
            font-size: 14px;
        }

        .footer {
            text-align: center;
            padding-top: 32px;
            border-top: 1px solid #000000;
            color: #666;
            font-size: 13px;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin: 24px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .calendar-container {
                padding: 24px 16px;
            }
            
            .brand h1 {
                font-size: 24px;
            }
            
            .nav-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .legend {
                gap: 16px;
            }
            
            .day-cell {
                min-height: 100px;
                padding: 8px 6px;
            }
            
            .event {
                font-size: 10px;
            }

            .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .calendar-grid {
                gap: 0;
            }
            
            .day-header {
                padding: 12px 4px;
                font-size: 11px;
            }
            
            .day-cell {
                min-height: 80px;
                padding: 6px 4px;
            }

            .week-view .day-cell {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <header class="header">
            <div class="brand">
                <h1>Time & Space Limited Calendar</h1>
                <span class="status">Live</span>
            </div>
            
            <div class="nav-section">
                <div class="month-display" id="monthDisplay">Loading...</div>
                
                <div class="controls">
                    <div class="view-toggle">
                        <button class="view-btn active" id="monthViewBtn">Month</button>
                        <button class="view-btn" id="weekViewBtn">Week</button>
                    </div>
                    <button class="nav-btn" id="prevBtn">← Previous</button>
                    <button class="nav-btn" id="todayBtn">Today</button>
                    <button class="nav-btn" id="nextBtn">Next →</button>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot special-events"></div>
                        <span>Special Events</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot movies"></div>
                        <span>Movies</span>
                    </div>
                </div>
            </div>
        </header>

        <div id="loadingMessage" class="loading">
            Initializing calendar...
        </div>

        <div class="calendar-grid" id="calendarGrid" style="display: none;">
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
            <div class="day-header">Sun</div>
        </div>

        <footer class="footer">
            <p>Updated in real-time from Google Calendar</p>
        </footer>
    </div>

    <script>
        // Google Calendar API Configuration
        const CLIENT_ID = '805806936738-svig4rs4b96t849n81b7e5hi8p44qo0v.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDzisAik43Rr1xTJXg2bHXNF_XRTjjZsh8';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events';

        // TSL Calendar IDs - Production Configuration (PUBLIC ONLY)
        const CALENDARS = {
            '1ed95b09dcc5ea1a1e13267b6654eca3c892fc79c23e2e9edc1e271411967255@group.calendar.google.com': { 
                name: 'Special Events', 
                class: 'special-events' 
            },
            '007f10222d517076d028161a4cda7108e75444c18ef7ac0d79aee420313d1a7b@group.calendar.google.com': { 
                name: 'Movies', 
                class: 'movies' 
            },
            'ed801a88ce91b43543ef4e87c34d1405a6e053c5254e55e2871f0d305ecc32c4@group.calendar.google.com': { 
                name: 'Movies', 
                class: 'movies' 
            }
        };

        let gapi;
        let currentDate = new Date();
        let currentView = 'month'; // 'month' or 'week'

        // Initialize Google API
        async function initializeGapi() {
            try {
                // Load Google API script
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                gapi = window.gapi;
                
                // Initialize the API client
                await new Promise((resolve) => {
                    gapi.load('client', resolve);
                });

                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                
                console.log('Google Calendar API initialized successfully');
                document.getElementById('loadingMessage').textContent = 'Loading events...';
                await loadCalendar();
                
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showError('Failed to initialize Google Calendar API. Please check your internet connection and refresh the page.');
            }
        }

        // Show error message
        function showError(message) {
            const loadingElement = document.getElementById('loadingMessage');
            loadingElement.innerHTML = `
                <div class="error-message">
                    ${message}
                </div>
            `;
        }

        // Load calendar events
        async function loadCalendar() {
            try {
                let startDate, endDate;
                
                if (currentView === 'week') {
                    // Week view: show current week (Monday to Sunday)
                    const today = new Date(currentDate);
                    const dayOfWeek = today.getDay();
                    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust for Monday start
                    
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() + mondayOffset);
                    
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                } else {
                    // Month view: show full month with extended weeks
                    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    
                    startDate = new Date(startOfMonth);
                    const startDay = startOfMonth.getDay();
                    const daysToSubtract = startDay === 0 ? 6 : startDay - 1;
                    startDate.setDate(startDate.getDate() - daysToSubtract);
                    
                    endDate = new Date(endOfMonth);
                    const endDay = endOfMonth.getDay();
                    const daysToAdd = endDay === 0 ? 0 : 7 - endDay;
                    endDate.setDate(endDate.getDate() + daysToAdd);
                }

                const allEvents = [];
                let successfulCalendars = 0;

                // Fetch events from all calendars
                for (const [calendarId, config] of Object.entries(CALENDARS)) {
                    try {
                        console.log(`Loading calendar: ${config.name}`);
                        
                        const response = await gapi.client.calendar.events.list({
                            calendarId: calendarId,
                            timeMin: startDate.toISOString(),
                            timeMax: endDate.toISOString(),
                            singleEvents: true,
                            orderBy: 'startTime',
                            maxResults: 250
                        });

                        if (response.result.items) {
                            console.log(`Found ${response.result.items.length} events in ${config.name}`);
                            response.result.items.forEach(event => {
                                allEvents.push({
                                    ...event,
                                    calendarType: config.class,
                                    calendarName: config.name
                                });
                            });
                            successfulCalendars++;
                        }
                    } catch (error) {
                        console.warn(`Could not load calendar ${config.name}:`, error);
                        if (error.status === 404) {
                            console.warn(`Calendar ${config.name} not found or not public`);
                        }
                    }
                }

                if (successfulCalendars === 0) {
                    showError('No calendars could be loaded. Please check that the calendars are public and the IDs are correct.');
                    return;
                }

                console.log(`Total events loaded: ${allEvents.length}`);
                renderCalendar(startDate, endDate, allEvents);
                updateMonthDisplay();
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('calendarGrid').style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading calendar:', error);
                showError('Error loading calendar events. Please try refreshing the page.');
            }
        }

        // Render calendar grid
        function renderCalendar(startDate, endDate, events) {
            const grid = document.getElementById('calendarGrid');
            
            // Apply week view class if needed
            if (currentView === 'week') {
                grid.classList.add('week-view');
            } else {
                grid.classList.remove('week-view');
            }
            
            // Clear existing day cells (keep headers)
            const dayCells = grid.querySelectorAll('.day-cell');
            dayCells.forEach(cell => cell.remove());

            const currentMonth = currentDate.getMonth();
            const date = new Date(startDate);

            while (date <= endDate) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (currentView === 'month' && date.getMonth() !== currentMonth) {
                    dayCell.classList.add('other-month');
                }

                // For week view, add day name
                if (currentView === 'week') {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    dayHeader.textContent = `${dayName} ${date.getDate()}`;
                    dayCell.appendChild(dayHeader);
                } else {
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = date.getDate();
                    dayCell.appendChild(dayNumber);
                }

                // Add events for this day
                const dayEvents = events.filter(event => {
                    const eventDate = new Date(event.start.dateTime || event.start.date);
                    return eventDate.toDateString() === date.toDateString();
                });

                // Sort events by time
                dayEvents.sort((a, b) => {
                    const timeA = new Date(a.start.dateTime || a.start.date);
                    const timeB = new Date(b.start.dateTime || b.start.date);
                    return timeA - timeB;
                });

                dayEvents.forEach(event => {
                    const eventElement = document.createElement('a');
                    eventElement.className = `event ${event.calendarType}`;
                    
                    // Extract URL from event description or use Google Calendar link
                    let eventLink = event.htmlLink; // Default to Google Calendar
                    
                    if (event.description) {
                        // Look for URLs in the description
                        const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`[\]]+)/gi;
                        const matches = event.description.match(urlRegex);
                        if (matches && matches.length > 0) {
                            eventLink = matches[0]; // Use the first URL found
                        }
                    }
                    
                    // Set the link target
                    if (eventLink) {
                        eventElement.href = eventLink;
                        eventElement.target = '_blank';
                        eventElement.rel = 'noopener noreferrer';
                    } else {
                        eventElement.href = '#';
                        eventElement.onclick = (e) => e.preventDefault();
                    }
                    
                    let eventTime = '';
                    if (event.start.dateTime) {
                        const time = new Date(event.start.dateTime);
                        eventTime = time.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        });
                    }

                    const eventTitle = event.summary || 'Untitled Event';
                    
                    eventElement.innerHTML = `
                        <div>${eventTitle}</div>
                        ${eventTime ? `<div class="event-time">${eventTime}</div>` : ''}
                    `;
                    
                    dayCell.appendChild(eventElement);
                });

                grid.appendChild(dayCell);
                date.setDate(date.getDate() + 1);
            }
        }

        // Update month display
        function updateMonthDisplay() {
            if (currentView === 'week') {
                // Show week range
                const today = new Date(currentDate);
                const dayOfWeek = today.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() + mondayOffset);
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                
                const startText = startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endText = endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                document.getElementById('monthDisplay').textContent = `${startText} - ${endText}`;
            } else {
                // Show month and year
                const options = { month: 'long', year: 'numeric' };
                document.getElementById('monthDisplay').textContent = 
                    currentDate.toLocaleDateString('en-US', options);
            }
        }

        // Navigation functions
        function previousMonth() {
            if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            document.getElementById('loadingMessage').style.display = 'flex';
            document.getElementById('calendarGrid').style.display = 'none';
            loadCalendar();
        }

        function nextMonth() {
            if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            document.getElementById('loadingMessage').style.display = 'flex';
            document.getElementById('calendarGrid').style.display = 'none';
            loadCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            document.getElementById('loadingMessage').style.display = 'flex';
            document.getElementById('calendarGrid').style.display = 'none';
            loadCalendar();
        }

        // View switching functions
        function switchToMonthView() {
            currentView = 'month';
            document.getElementById('monthViewBtn').classList.add('active');
            document.getElementById('weekViewBtn').classList.remove('active');
            loadCalendar();
        }

        function switchToWeekView() {
            currentView = 'week';
            document.getElementById('weekViewBtn').classList.add('active');
            document.getElementById('monthViewBtn').classList.remove('active');
            loadCalendar();
        }

        // Event listeners
        document.getElementById('prevBtn').addEventListener('click', previousMonth);
        document.getElementById('nextBtn').addEventListener('click', nextMonth);
        document.getElementById('todayBtn').addEventListener('click', goToToday);
        document.getElementById('monthViewBtn').addEventListener('click', switchToMonthView);
        document.getElementById('weekViewBtn').addEventListener('click', switchToWeekView);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing calendar...');
            initializeGapi();
        });
    </script>
</body>
</html>
