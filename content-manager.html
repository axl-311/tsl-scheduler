<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Content Manager</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version-badge {
            font-size: 12px;
            background: #007aff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
            font-weight: 500;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #e8e8e8;
            border-radius: 20px;
            font-size: 14px;
            color: #86868b;
        }

        .sync-status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sync-status.error {
            background: #fce4ec;
            color: #c62828;
        }

        .nav-tabs {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: #e0e0e2;
        }

        .nav-tab.active {
            background: #007aff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0051d5;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30a852;
        }

        .btn-secondary {
            background: #f0f0f2;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e0e0e2;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #007aff;
        }

        .stat-label {
            font-size: 14px;
            color: #86868b;
            margin-top: 5px;
        }

        .controls-bar {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .content-tabs {
            display: flex;
            gap: 10px;
        }

        .tab-button {
            padding: 8px 16px;
            border: 1px solid #d2d2d7;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #f0f0f2;
        }

        .tab-button.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .content-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .card-meta {
            font-size: 12px;
            color: #86868b;
        }

        .card-details {
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f2;
        }

        .detail-label {
            color: #86868b;
        }

        .detail-value {
            color: #1d1d1f;
            font-weight: 500;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-actions .btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 13px;
        }

        .main-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .content-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .type-option {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            text-align: center;
            background: white;
            font-size: 14px;
        }

        .type-option:hover {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .type-option.active {
            border-color: #007aff;
            background: #007aff;
            color: white;
        }

        .upload-section {
            border: 3px dashed #007aff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f0f7ff;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #0051d5;
            background: #e3f2ff;
        }

        .upload-section.dragover {
            border-color: #34c759;
            background: #e8f5e9;
        }

        .file-input {
            display: none;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #1d1d1f;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #007aff;
            padding-bottom: 10px;
        }

        .form-grid-three {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #1d1d1f;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #323232;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        .extraction-preview {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .raw-text-viewer {
            background: #f8f9fa;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .raw-text-content {
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .spinner {
            border: 3px solid #f0f0f2;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div>
                <h1>TSL Content Manager<span class="version-badge">v2.0</span></h1>
            </div>
            <div class="sync-status" id="connectionStatus">
                <span>‚óã</span>
                <span>Connecting...</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">
                <span>üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="nav-tab" onclick="switchTab('importer')">
                <span>üì•</span>
                <span>Import Press Kit</span>
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="moviesCount">0</div>
                        <div class="stat-label">Movies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="eventsCount">0</div>
                        <div class="stat-label">Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="galleriesCount">0</div>
                        <div class="stat-label">Galleries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                </div>
            </div>

            <div class="controls-bar">
                <div class="search-section">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by title...">
                    <button onclick="searchContent()" class="btn btn-primary">Search</button>
                </div>
                <div class="content-tabs">
                    <button class="tab-button active" onclick="filterContent('all')">All</button>
                    <button class="tab-button" onclick="filterContent('movies')">Movies</button>
                    <button class="tab-button" onclick="filterContent('events')">Events</button>
                    <button class="tab-button" onclick="filterContent('galleries')">Galleries</button>
                </div>
            </div>

            <div id="contentContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading content...</div>
                </div>
            </div>
        </div>

        <!-- Importer Tab -->
        <div id="importer-tab" class="tab-content">
            <div class="main-panel">
                <div class="content-type-selector">
                    <div class="type-option active" onclick="selectContentType('movie')">üé¨ Movie</div>
                    <div class="type-option" onclick="selectContentType('event')">üé≠ Event</div>
                    <div class="type-option" onclick="selectContentType('gallery')">üñºÔ∏è Gallery</div>
                </div>
                
                <div class="upload-section" id="uploadSection">
                    <div style="font-size: 18px; color: #007aff; margin-bottom: 10px; font-weight: 600;">
                        üìÑ Drop Press Kit PDF Here
                    </div>
                    <div style="color: #86868b; font-size: 14px;">Or click to browse files</div>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt" onchange="handleFile(event)">
                    <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary" style="margin-top: 15px;">
                        Choose File
                    </button>
                </div>
                
                <div id="extractionPreview" class="extraction-preview hidden">
                    <h4>üìã Extracted Information</h4>
                    <div id="extractedData"></div>
                    <div class="action-buttons">
                        <button onclick="toggleRawText()" class="btn btn-secondary">üëÅÔ∏è Show Raw Text</button>
                        <button onclick="downloadData()" class="btn btn-success">üì• Download Data</button>
                    </div>
                </div>

                <div id="rawTextViewer" class="raw-text-viewer hidden">
                    <h4>üìÑ Raw Extracted Text</h4>
                    <div class="raw-text-content" id="rawTextContent"></div>
                    <button onclick="copyRawText()" class="btn btn-secondary" style="margin-top: 10px;">
                        üìã Copy to Clipboard
                    </button>
                </div>
                
                <div class="form-section">
                    <h3>üìù Movie Details</h3>
                    <div class="form-grid-three">
                        <div class="form-group">
                            <label class="form-label">Title *</label>
                            <input type="text" id="title" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Director</label>
                            <input type="text" id="director" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Runtime (minutes)</label>
                            <input type="number" id="runtime_minutes" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Release Year</label>
                            <input type="number" id="year" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Language</label>
                            <input type="text" id="language" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Distributor</label>
                            <input type="text" id="distributor" class="form-input" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Logline</label>
                        <textarea id="logline" class="form-input" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Synopsis</label>
                        <textarea id="synopsis" class="form-input" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Critics Quote</label>
                        <textarea id="criticsQuote" class="form-input" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üé• Media Links</h3>
                    <div class="form-grid-three">
                        <div class="form-group">
                            <label class="form-label">Trailer URL</label>
                            <input type="url" id="trailerUrl" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">SimpleTix Embed Code</label>
                            <input type="text" id="simpletix_embed_code" class="form-input" />
                        </div>
                    </div>
                </div>
                
                <button onclick="saveContent()" class="btn btn-success" style="width: 100%; margin-top: 20px; padding: 12px;">
                    üíæ Save Movie to Database
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Global variables
        let supabase = null;
        let currentContentType = 'movie';
        let currentTab = 'all';
        let allContent = [];
        
        // Initialize Supabase
        async function initSupabase() {
            const url = 'https://tnnkfnattwpqqrydsyux.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubmtmbmF0dHdwcXFyeWRzeXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Njc3NDAsImV4cCI6MjA3MzA0Mzc0MH0.cNzStE1v6YA7HRvTeBCXxGFPuJPq1WmnuVGVaNLjOsE';
            
            try {
                supabase = window.supabase.createClient(url, key);
                
                // Test connection
                const { error } = await supabase.from('movies').select('count').limit(1);
                if (error) throw error;
                
                // Update connection status
                const statusEl = document.getElementById('connectionStatus');
                statusEl.classList.add('connected');
                statusEl.innerHTML = '<span>‚úì</span><span>Connected</span>';
                
                // Load initial content
                await loadContent();
            } catch (error) {
                console.error('Connection error:', error);
                const statusEl = document.getElementById('connectionStatus');
                statusEl.classList.add('error');
                statusEl.innerHTML = '<span>‚úó</span><span>Connection failed</span>';
            }
        }
        
        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'dashboard') {
                document.querySelector('.nav-tab:first-child').classList.add('active');
                document.getElementById('dashboard-tab').classList.add('active');
                loadContent(); // Refresh content when switching to dashboard
            } else {
                document.querySelector('.nav-tab:last-child').classList.add('active');
                document.getElementById('importer-tab').classList.add('active');
            }
        }
        
        // Select content type
        function selectContentType(type) {
            currentContentType = type;
            document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update form title
            const titleMap = {
                'movie': 'üìù Movie Details',
                'event': 'üé≠ Event Details',
                'gallery': 'üñºÔ∏è Gallery Details'
            };
            document.querySelector('.form-section h3').textContent = titleMap[type];
            
            // Update save button text
            const btnText = 'üíæ Save ' + type.charAt(0).toUpperCase() + type.slice(1) + ' to Database';
            document.querySelector('.btn-success').textContent = btnText;
        }
        
        // Load content
        async function loadContent() {
            if (!supabase) return;
            
            try {
                const [moviesRes, eventsRes, galleriesRes] = await Promise.all([
                    supabase.from('movies').select('*').order('created_at', { ascending: false }),
                    supabase.from('events').select('*').order('created_at', { ascending: false }),
                    supabase.from('galleries').select('*').order('created_at', { ascending: false })
                ]);
                
                const movies = moviesRes.data || [];
                const events = eventsRes.data || [];
                const galleries = galleriesRes.data || [];
                
                // Update stats
                document.getElementById('moviesCount').textContent = movies.length;
                document.getElementById('eventsCount').textContent = events.length;
                document.getElementById('galleriesCount').textContent = galleries.length;
                document.getElementById('totalCount').textContent = movies.length + events.length + galleries.length;
                
                // Combine all content
                allContent = [
                    ...movies.map(m => ({ ...m, type: 'movie' })),
                    ...events.map(e => ({ ...e, type: 'event' })),
                    ...galleries.map(g => ({ ...g, type: 'gallery' }))
                ];
                
                renderContent();
            } catch (error) {
                console.error('Load error:', error);
                showToast('Failed to load content');
            }
        }
        
        // Render content
        function renderContent(searchTerm = '') {
            let filteredContent = allContent;
            
            // Filter by type
            if (currentTab !== 'all') {
                const typeMap = { 'movies': 'movie', 'events': 'event', 'galleries': 'gallery' };
                filteredContent = filteredContent.filter(item => item.type === typeMap[currentTab]);
            }
            
            // Filter by search
            if (searchTerm) {
                filteredContent = filteredContent.filter(item => {
                    const title = item.title || item.event_name || item.exhibition_title || '';
                    return title.toLowerCase().includes(searchTerm.toLowerCase());
                });
            }
            
            const container = document.getElementById('contentContainer');
            
            if (filteredContent.length === 0) {
                container.innerHTML = '<div class="empty-state">üì≠<br>No content found</div>';
                return;
            }
            
            let html = '<div class="content-grid">';
            filteredContent.forEach(item => {
                const title = item.title || item.event_name || item.exhibition_title;
                const creator = item.director || item.presenter || item.artist || 'N/A';
                const typeEmoji = { 'movie': 'üé¨', 'event': 'üé≠', 'gallery': 'üñºÔ∏è' };
                
                html += `
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-title">${typeEmoji[item.type]} ${title}</div>
                            <div class="card-meta">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</div>
                        </div>
                        <div class="card-details">
                            <div class="detail-item">
                                <span class="detail-label">Creator:</span>
                                <span class="detail-value">${creator}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="editContent('${item.id}', '${item.type}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteContent('${item.id}', '${item.type}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Search content
        function searchContent() {
            const searchTerm = document.getElementById('searchInput').value;
            renderContent(searchTerm);
        }
        
        // Filter content
        function filterContent(type) {
            currentTab = type;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderContent();
        }
        
        // Handle file upload
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type === 'application/pdf') {
                processPDF(file);
            } else if (file.type === 'text/plain') {
                processTextFile(file);
            } else {
                showToast('Please upload a PDF or text file');
            }
        }
        
        // Process PDF
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                parseContent(fullText);
                showToast('PDF processed successfully');
            } catch (error) {
                console.error('PDF processing error:', error);
                showToast('Error processing PDF');
            }
        }
        
        // Process text file
        async function processTextFile(file) {
            try {
                const text = await file.text();
                parseContent(text);
                showToast('Text file processed successfully');
            } catch (error) {
                console.error('Text file error:', error);
                showToast('Error processing text file');
            }
        }
        
        // Parse content
        function parseContent(text) {
            // Store raw text
            document.getElementById('rawTextContent').textContent = text;
            
            // Extract data
            const extracted = extractMovieData(text);
            
            // Display extracted data
            displayExtractedData(extracted);
            
            // Fill form
            fillForm(extracted);
            
            // Show preview sections
            document.getElementById('extractionPreview').classList.remove('hidden');
        }
        
        // Extract movie data
        function extractMovieData(text) {
            // Clean up common PDF artifacts
            function cleanText(str) {
                return str
                    .replace(/\s+/g, ' ')  // Multiple spaces to single
                    .replace(/[\r\n]+/g, '\n')  // Normalize line breaks
                    .trim();
            }
            
            const fixedText = fixSpacing(text);
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const cleanedText = fixedText.replace(/\s+/g, ' ').trim();
            
            const extracted = {
                title: '',
                director: '',
                runtime: '',
                year: '',
                language: '',
                distributor: '',
                logline: '',
                synopsis: '',
                criticsQuote: ''
            };
            
            // TITLE EXTRACTION - Enhanced for press kit formats
            const titlePatterns = [
                // All caps titles (common in press kits)
                /^([A-Z][A-Z\s&]+)$/m,
                /^"([^"]+)"$/m,  // Titles in quotes
                /\*\*([^*]+)\*\*/,  // Bold markdown titles
                // Specific patterns
                /\bA\s+Savage\s+Art\b/i,
                /\bDEATH\s*&\s*TAXES\b/i,
                /\bRABBIT\s+TRAP\b/i,
                /\bRIEFENSTAHL\b/i,
                // After common headers
                /(?:PRESENTS?|RELEASE)\s+([A-Z][A-Za-z\s&]+?)(?:\n|Written|Directed|A\s+Film)/i,
                // Title patterns with "A Film"
                /^([^.]+?)\s+A\s+Film\s+by/im
            ];
            
            for (const pattern of titlePatterns) {
                const match = fixedText.match(pattern);
                if (match) {
                    let title = match[1] || match[0];
                    title = fixSpacing(title).trim();
                    // Validate it's a title
                    if (title && 
                        title.length > 2 && 
                        title.length < 100 &&
                        !title.match(/^(LOGLINE|SYNOPSIS|PRESS|FINAL|DISTRIBUTOR|CONTACT|CAST|CREW)/i)) {
                        extracted.title = title.replace(/\s+/g, ' ').trim();
                        break;
                    }
                }
            }
            
            // If no title found, look in first 20 lines for something that looks like a title
            if (!extracted.title) {
                for (let i = 0; i < Math.min(20, lines.length); i++) {
                    const line = fixSpacing(lines[i]);
                    
                    // Check if this could be a title
                    if (line && 
                        line.length > 2 && 
                        line.length < 80 &&
                        (line === line.toUpperCase() || // All caps
                         line.match(/^[A-Z]/) || // Starts with capital
                         line.match(/^"[^"]+"$/)) && // In quotes
                        !line.match(/^(MAGNET|FINAL|PRESS|NOTES|CONTACT|DISTRIBUTOR|PUBLICITY|CAST|CREW|SYNOPSIS|LOGLINE)/i) &&
                        !line.includes('@') &&
                        !line.match(/^\d{4}/) &&
                        !line.match(/\.(com|org|net)$/i)) {
                        extracted.title = line;
                        break;
                    }
                }
            }
            
            // DIRECTOR EXTRACTION - Multiple patterns
            const directorPatterns = [
                /(?:Directed\s+and\s+Produced\s+by|Directed\s+by)\s+([A-Z][a-z]+\s+[A-Z][a-z]+)/i,
                /(?:Written\s+(?:and|&)\s+)?Directed\s+by\s+([A-Z][a-zA-Z\s]+?)(?:\n|$|\.|\||Running|Produced)/i,
                /(?:A\s+Film\s+by|Director)\s*:?\s*([A-Z][a-zA-Z\s]+?)(?:\n|$|\.|\||Running)/i,
                /(?:FILMED\s+AND\s+DIRECTED\s+BY|DIRECTED\s+BY)\s+([A-Z][a-zA-Z\s]+?)(?:\n|$|PRODUCED)/i,
                /Director\s*:?\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)(?:\n|$)/i,
                /([A-Z][a-z]+\s+[A-Z][a-z]+)\s+\((?:Director|Writer[/-]Director)\)/i
            ];
            
            // First check for Bill Banowsky specifically
            if (cleanedText.match(/Bill\s+Banowsky/i)) {
                extracted.director = "Bill Banowsky";
            } else {
                for (const pattern of directorPatterns) {
                    const match = cleanedText.match(pattern);
                    if (match && match[1]) {
                        const director = match[1].trim();
                        // Validate it's a name and not partial text
                        if (director.length > 5 && !director.match(/debut|feature|film|award/i)) {
                            extracted.director = director;
                            break;
                        }
                    }
                }
            }
            
            // RUNTIME EXTRACTION
            const runtimePatterns = [
                /(\d{2,3})\s*(?:min(?:ute)?s?|m)\b/i,
                /Running\s+Time\s*:?\s*(\d{2,3})/i,
                /Duration\s*:?\s*(\d{2,3})/i,
                /\|\s*(\d{2,3})\s*minutes?\s*\|/i,
                /\b(\d{2,3})\s+mins?\s*\|/i
            ];
            
            for (const pattern of runtimePatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    const runtime = parseInt(match[1]);
                    if (runtime > 40 && runtime < 300) { // Reasonable movie length
                        extracted.runtime = match[1];
                        break;
                    }
                }
            }
            
            // YEAR EXTRACTION
            const yearPatterns = [
                /\|\s*(19\d{2}|20\d{2})\s*\|/,
                /\b(19\d{2}|20\d{2})\s*\|/,
                /(?:Year|Released?|Date)\s*:?\s*(19\d{2}|20\d{2})/i,
                /\b(2024|2025|2023|2022)\b/ // Recent years
            ];
            
            for (const pattern of yearPatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    const year = parseInt(match[1]);
                    if (year >= 1900 && year <= 2030) {
                        extracted.year = match[1];
                        break;
                    }
                }
            }
            
            // LANGUAGE EXTRACTION
            const langPatterns = [
                /\|\s*([A-Za-z]+)\s+(?:with|w\/)\s+English\s+subtitles/i,
                /\|\s*(English|Spanish|French|German|Italian|Japanese|Chinese|Korean|Portuguese)\b/i,
                /Language\s*:?\s*([A-Za-z]+)/i,
                /\d{4}\s*\/\s*\d+m?\s*\/\s*([A-Za-z]+)/i,
                /\|\s*([A-Z]+(?:\s+[A-Z]+)?)\s*$/m  // Country code at end of line
            ];
            
            for (const pattern of langPatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    const lang = match[1].trim();
                    if (lang.length > 2 && !lang.match(/^(FINAL|PRESS|NOTES)$/i)) {
                        extracted.language = lang;
                        break;
                    }
                }
            }
            
            // DISTRIBUTOR EXTRACTION
            const distPatterns = [
                /(?:Distributor|Distribution|Distributed\s+by)\s*:?\s*([A-Za-z][A-Za-z\s]+?(?:Pictures|Films|Entertainment|Studios|Releasing|Features))/i,
                /\b(Magnolia\s+Pictures|Sony\s+Pictures|Warner\s+Bros|Universal|Paramount|Disney|Netflix|Amazon\s+Studios|A24|Kino\s+Lorber|IFC\s+Films|Neon)\b/i,
                /(?:AN?\s+)?([A-Z0-9]+(?:\s+[A-Z]+)*)\s+(?:THEATRICAL\s+)?RELEASE/i,
                /Contact\s*:?\s*([A-Za-z\s]+?(?:Pictures|Films))/i
            ];
            
            for (const pattern of distPatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    let dist = match[1].trim();
                    // Clean up distributor name
                    dist = dist.replace(/(?:Contact|George|Rebecca|Louis|Distributor).*/i, '').trim();
                    if (dist) {
                        extracted.distributor = dist;
                        break;
                    }
                }
            }
            
            // LOGLINE EXTRACTION
            const loglinePatterns = [
                /(?:LOG\s*LINE|Logline)\s*:?\s*([^.]+\.)(?:\s|$)/i,
                /(?:SHORT\s+SYNOPSIS|One[\-\s]liner?)\s*:?\s*([^.]+\.)/i,
                /^([^.]{50,200}\.)(?:\s|$)/m  // First sentence if reasonable length
            ];
            
            for (const pattern of loglinePatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    let logline = fixSpacing(match[1]);
                    // Remove labels
                    logline = logline.replace(/^(LOGLINE|LOG\s*LINE)\s*/i, '').trim();
                    if (logline.length > 20) {
                        extracted.logline = logline;
                        break;
                    }
                }
            }
            
            // SYNOPSIS EXTRACTION
            const synopsisPatterns = [
                /(?:SYNOPSIS|Synopsis)\s*:?\s*([\s\S]{100,}?)(?:\n\n|DIRECTOR|CAST|CREDITS|ABOUT|$)/i,
                /(?:FILM\s+SUMMARY|Description)\s*:?\s*([\s\S]{100,}?)(?:\n\n|$)/i,
                /(?:About\s+the\s+Film|Story|Plot)\s*:?\s*([\s\S]{100,}?)(?:\n\n|Credits|Cast|$)/i
            ];
            
            for (const pattern of synopsisPatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    let synopsis = fixSpacing(match[1]);
                    // Clean up
                    synopsis = synopsis.split(/(?:CREDITS|CAST|DIRECTOR'S\s+STATEMENT|ABOUT\s+THE)/i)[0];
                    synopsis = synopsis.replace(/^(SYNOPSIS|LOGLINE)\s*/i, '').trim();
                    
                    if (synopsis.length > 100) {
                        // Limit length
                        if (synopsis.length > 2000) {
                            synopsis = synopsis.substring(0, 2000) + '...';
                        }
                        extracted.synopsis = synopsis;
                        break;
                    }
                }
            }
            
            // If no synopsis found, look for substantial paragraphs
            if (!extracted.synopsis) {
                const paragraphs = text.split(/\n\n+/).filter(p => {
                    const wordCount = p.split(/\s+/).length;
                    return wordCount > 50 && wordCount < 500 && 
                           !p.match(/^(CAST|CREDITS|DIRECTOR|PRODUCER|CONTACT)/i);
                });
                
                if (paragraphs.length > 0) {
                    extracted.synopsis = fixSpacing(paragraphs[0]);
                }
            }
            
            // CRITICS QUOTE EXTRACTION
            const quotePatterns = [
                /"([^"]{20,300})"\s*[-‚Äì‚Äî]\s*([^,\n]+)/g,
                /(?:Reviews?|Critics?|Praise)\s*:?\s*"([^"]+)"/i,
                /"([^"]{30,300})".*(?:Variety|Hollywood\s+Reporter|Times|Post|Guardian)/i
            ];
            
            for (const pattern of quotePatterns) {
                const match = cleanedText.match(pattern);
                if (match) {
                    extracted.criticsQuote = match[0].trim();
                    break;
                }
            }
            
            return extracted;
        }
        
        // Display extracted data
        function displayExtractedData(data) {
            const container = document.getElementById('extractedData');
            let html = '';
            
            for (const [key, value] of Object.entries(data)) {
                if (value) {
                    const label = key.charAt(0).toUpperCase() + key.slice(1);
                    html += `<div><strong>${label}:</strong> ${value}</div>`;
                }
            }
            
            container.innerHTML = html || '<div>No data extracted</div>';
        }
        
        // Fill form
        function fillForm(data) {
            document.getElementById('title').value = data.title || '';
            document.getElementById('director').value = data.director || '';
            document.getElementById('runtime_minutes').value = data.runtime || '';
            document.getElementById('year').value = data.year || '';
            document.getElementById('language').value = data.language || '';
            document.getElementById('distributor').value = data.distributor || '';
            document.getElementById('logline').value = data.logline || '';
            document.getElementById('synopsis').value = data.synopsis || '';
            document.getElementById('criticsQuote').value = data.criticsQuote || '';
        }
        
        // Toggle raw text
        function toggleRawText() {
            const viewer = document.getElementById('rawTextViewer');
            viewer.classList.toggle('hidden');
        }
        
        // Copy raw text
        function copyRawText() {
            const text = document.getElementById('rawTextContent').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard');
            });
        }
        
        // Download data
        function downloadData() {
            const title = document.getElementById('title').value || 'extracted';
            const data = {
                title: document.getElementById('title').value,
                director: document.getElementById('director').value,
                runtime_minutes: document.getElementById('runtime_minutes').value,
                year: document.getElementById('year').value,
                language: document.getElementById('language').value,
                distributor: document.getElementById('distributor').value,
                logline: document.getElementById('logline').value,
                synopsis: document.getElementById('synopsis').value,
                criticsQuote: document.getElementById('criticsQuote').value
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Save content
        async function saveContent() {
            if (!supabase) {
                showToast('Database not connected');
                return;
            }
            
            const title = document.getElementById('title').value.trim();
            if (!title) {
                showToast('Please enter a title');
                return;
            }
            
            try {
                const table = currentContentType === 'movie' ? 'movies' : 
                             currentContentType === 'event' ? 'events' : 'galleries';
                
                const data = {
                    title: title,
                    director: document.getElementById('director').value || null,
                    runtime_minutes: parseInt(document.getElementById('runtime_minutes').value) || null,
                    release_year: parseInt(document.getElementById('year').value) || null,
                    language: document.getElementById('language').value || null,
                    distributor: document.getElementById('distributor').value || null,
                    logline: document.getElementById('logline').value || null,
                    synopsis: document.getElementById('synopsis').value || null,
                    critics_quote: document.getElementById('criticsQuote').value || null,
                    trailer_url: document.getElementById('trailerUrl').value || null,
                    simpletix_embed_code: document.getElementById('simpletix_embed_code').value || null
                };
                
                // Add type-specific fields
                if (currentContentType === 'event') {
                    data.event_name = title;
                    data.presenter = data.director;
                    data.duration_minutes = data.runtime_minutes;
                    data.event_type = data.language;
                } else if (currentContentType === 'gallery') {
                    data.exhibition_title = title;
                    data.artist = data.director;
                    data.art_medium = data.language;
                    data.gallery_space = data.distributor;
                }
                
                const { error } = await supabase.from(table).insert([data]);
                
                if (error) throw error;
                
                showToast('Saved successfully!');
                
                // Clear form
                document.querySelectorAll('.form-input').forEach(input => input.value = '');
                document.getElementById('extractionPreview').classList.add('hidden');
                document.getElementById('rawTextViewer').classList.add('hidden');
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save: ' + error.message);
            }
        }
        
        // Edit content
        function editContent(id, type) {
            // This would open a modal or inline editor
            showToast('Edit functionality coming soon');
        }
        
        // Delete content
        async function deleteContent(id, type) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                const table = type === 'movie' ? 'movies' : 
                             type === 'event' ? 'events' : 'galleries';
                
                const { error } = await supabase.from(table).delete().eq('id', id);
                
                if (error) throw error;
                
                showToast('Deleted successfully');
                await loadContent();
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete');
            }
        }
        
        // Show toast notification
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Setup drag and drop
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        
        // File input change event
        fileInput.addEventListener('change', (e) => {
            console.log('File selected:', e.target.files[0]);
            if (e.target.files.length > 0) {
                handleFile({ target: { files: [e.target.files[0]] } });
            }
        });
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'application/pdf' || file.type === 'text/plain') {
                    document.getElementById('fileInput').files = files;
                    handleFile({ target: { files: [file] } });
                } else {
                    showToast('Please drop a PDF or text file');
                }
            }
        });
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initSupabase();
        });
    </script>
</body>
</html>
