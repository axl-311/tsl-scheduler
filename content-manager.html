<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL Content Manager</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .version-badge {
            font-size: 12px;
            background: #007aff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 10px;
            font-weight: 500;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #e8e8e8;
            border-radius: 20px;
            font-size: 14px;
            color: #86868b;
        }

        .sync-status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sync-status.error {
            background: #fce4ec;
            color: #c62828;
        }

        .editing-indicator {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            animation: slideDown 0.3s ease;
        }

        .editing-indicator.active {
            display: flex;
        }

        .editing-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editing-info .icon {
            font-size: 20px;
        }

        .editing-title {
            font-weight: 600;
            color: #856404;
        }

        .cancel-edit-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .cancel-edit-btn:hover {
            background: #5a6268;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-tabs {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .nav-tab:hover {
            background: #e0e0e2;
        }

        .nav-tab.active {
            background: #007aff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0051d5;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30a852;
        }

        .btn-secondary {
            background: #f0f0f2;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e0e0e2;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #007aff;
        }

        .stat-label {
            font-size: 14px;
            color: #86868b;
            margin-top: 5px;
        }

        .controls-bar {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .content-tabs {
            display: flex;
            gap: 10px;
        }

        .tab-button {
            padding: 8px 16px;
            border: 1px solid #d2d2d7;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #f0f0f2;
        }

        .tab-button.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .content-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .card-meta {
            font-size: 12px;
            color: #86868b;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-actions .btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 13px;
        }

        .main-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .content-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .type-option {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            text-align: center;
            background: white;
            font-size: 14px;
        }

        .type-option:hover {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .type-option.active {
            border-color: #007aff;
            background: #007aff;
            color: white;
        }

        .upload-section {
            border: 3px dashed #007aff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f0f7ff;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #0051d5;
            background: #e3f2ff;
        }

        .upload-section.dragover {
            border-color: #34c759;
            background: #e8f5e9;
        }

        .file-input {
            display: none;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #1d1d1f;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #007aff;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #1d1d1f;
            font-size: 14px;
            text-transform: capitalize;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #323232;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        .extraction-preview {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .raw-text-viewer {
            background: #f8f9fa;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .raw-text-content {
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .spinner {
            border: 3px solid #f0f0f2;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .schema-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .schema-info strong {
            color: #856404;
        }

        .image-upload-area {
            border: 2px dashed #d2d2d7;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .image-upload-area:hover {
            border-color: #007aff;
            background: #f0f7ff;
        }

        .upload-placeholder {
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            color: #86868b;
        }

        .upload-placeholder span {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .upload-hint {
            font-size: 12px;
            color: #86868b;
        }

        .image-preview {
            position: relative;
            width: 100%;
        }

        .poster-preview img {
            width: 100%;
            height: 280px;
            object-fit: contain;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .graphics-preview img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .image-preview img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-image-btn:hover {
            background: #ff3b30;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div>
                <h1>TSL Content Manager<span class="version-badge">v5.0 Clean</span></h1>
            </div>
            <div class="sync-status" id="connectionStatus">
                <span>‚óã</span>
                <span>Connecting...</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard', this)">
                Dashboard
            </button>
            <button class="nav-tab" onclick="switchTab('importer', this)">
                Add New
            </button>
        </div>

        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="moviesCount">0</div>
                        <div class="stat-label">Movies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="eventsCount">0</div>
                        <div class="stat-label">Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="galleriesCount">0</div>
                        <div class="stat-label">Galleries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                </div>
            </div>

            <div class="controls-bar">
                <div class="search-section">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by title...">
                    <button onclick="searchContent()" class="btn btn-primary">Search</button>
                </div>
                <div class="content-tabs">
                    <button class="tab-button active" onclick="filterContent('all', this)">All</button>
                    <button class="tab-button" onclick="filterContent('movies', this)">Movies</button>
                    <button class="tab-button" onclick="filterContent('events', this)">Events</button>
                    <button class="tab-button" onclick="filterContent('galleries', this)">Galleries</button>
                </div>
            </div>

            <div id="contentContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading content...</div>
                </div>
            </div>
        </div>

        <div id="importer-tab" class="tab-content">
            <div class="editing-indicator" id="editingIndicator">
                <div class="editing-info">
                    <span class="icon">‚úèÔ∏è</span>
                    <div>
                        <div class="editing-title">Currently Editing: <span id="editingItemTitle"></span></div>
                        <div style="font-size: 12px; color: #856404;">Changes will update the existing item</div>
                    </div>
                </div>
                <button class="cancel-edit-btn" onclick="cancelEdit()">Cancel Edit</button>
            </div>
            
            <div class="main-panel">
                <div class="content-type-selector">
                    <div class="type-option active" onclick="selectContentType('movies', this)">Movie</div>
                    <div class="type-option" onclick="selectContentType('events', this)">Event</div>
                    <div class="type-option" onclick="selectContentType('galleries', this)">Gallery</div>
                </div>
                
                <div id="schemaInfo" class="schema-info hidden">
                    <strong>Table Schema:</strong> <span id="schemaDetails"></span>
                </div>
                
                <div class="upload-section" id="uploadSection">
                    <div style="font-size: 18px; color: #007aff; margin-bottom: 10px; font-weight: 600;">
                        Drop Press Kit PDF Here
                    </div>
                    <div style="color: #86868b; font-size: 14px;">Or click to browse files</div>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt">
                    <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary" style="margin-top: 15px;">
                        Choose File
                    </button>
                </div>
                
                <div id="extractionPreview" class="extraction-preview hidden">
                    <h4>Extracted Information</h4>
                    <div id="extractedData"></div>
                    <div class="action-buttons">
                        <button onclick="toggleRawText()" class="btn btn-secondary">Show Raw Text</button>
                        <button onclick="downloadData()" class="btn btn-success">Download Data</button>
                        <button onclick="downloadRawText()" class="btn btn-primary">Download Text</button>
                    </div>
                </div>

                <div id="rawTextViewer" class="raw-text-viewer hidden">
                    <h4>Raw Extracted Text</h4>
                    <div class="raw-text-content" id="rawTextContent"></div>
                    <button onclick="copyRawText()" class="btn btn-secondary" style="margin-top: 10px;">
                        Copy to Clipboard
                    </button>
                </div>
                
                <div id="dynamicForm" class="form-section">
                    <h3 id="formTitle">Loading Schema...</h3>
                    <div id="formFields">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>Loading form fields...</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveContent()" id="saveBtn" class="btn btn-success" style="flex: 1; padding: 12px;">
                        <span id="saveButtonText">Save to Database</span>
                    </button>
                    
                    <button onclick="cancelAndReturnToDashboard()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
                        Cancel & Return to Dashboard
                    </button>
                </div>
                
                <button onclick="deleteCurrentItem()" id="deleteBtn" class="btn btn-danger hidden" style="width: 100%; margin-top: 10px; padding: 12px;">
                    Delete This Item
                </button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let supabase = null;
        let currentContentType = 'movies';
        let currentTab = 'all';
        let allContent = [];
        let tableSchemas = {};
        let titleFields = {};
        let currentEditingItem = null;

        async function initSupabase() {
            const url = 'https://tnnkfnattwpqqrydsyux.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubmtmbmF0dHdwcXFyeWRzeXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Njc3NDAsImV4cCI6MjA3MzA0Mzc0MH0.cNzStE1v6YA7HRvTeBCXxGFPuJPq1WmnuVGVaNLjOsE';
            
            console.log('Attempting to connect to Supabase...');
            
            try {
                supabase = window.supabase.createClient(url, key);
                console.log('Supabase client created');
                
                const { data: testData, error: testError } = await supabase
                    .from('movies')
                    .select('count', { count: 'exact', head: true });
                
                if (testError) {
                    console.error('Connection test error:', testError);
                    throw testError;
                }
                
                console.log('Connection test successful');
                await loadTableSchemas();
                
                const statusEl = document.getElementById('connectionStatus');
                statusEl.classList.add('connected');
                statusEl.innerHTML = '<span>‚úì</span><span>Connected</span>';
                
                await loadContent();
                await generateDynamicForm();
                
            } catch (error) {
                console.error('Connection error:', error);
                const statusEl = document.getElementById('connectionStatus');
                statusEl.classList.add('error');
                statusEl.innerHTML = '<span>‚úó</span><span>Connection failed</span>';
                showToast('Failed to connect to database');
            }
        }

        async function loadTableSchemas() {
            try {
                const tables = ['movies', 'events', 'galleries'];
                const schemas = {};
                const titles = {};
                
                for (const table of tables) {
                    try {
                        console.log(`Detecting schema for ${table}...`);
                        
                        // Method 1: Try to get actual data
                        const { data: sampleData, error: sampleError } = await supabase
                            .from(table)
                            .select('*')
                            .limit(1);
                        
                        if (!sampleError && sampleData && sampleData.length > 0) {
                            schemas[table] = Object.keys(sampleData[0]);
                            console.log(`‚úì Schema from data for ${table}:`, schemas[table]);
                        } else {
                            console.log(`${table} is empty, using known schema...`);
                            
                            // Method 2: Use manually maintained schemas that match your actual Supabase structure
                            const knownSchemas = {
                                events: [
                                    'id', 'event_name', 'presented_by', 'duration_minutes', 
                                    'description', 'critic_quotes', 'simpletix_embed_code', 
                                    'created_at', 'updated_at', 'poster_url', 'web_graphics_url', 
                                    'webpage_url', 'sub_title', 'secondary_description'
                                ],
                                movies: [
                                    'id', 'title', 'director', 'runtime_minutes', 'release_year', 
                                    'language', 'distributor', 'logline', 'synopsis', 'critic_quotes', 
                                    'trailer_url', 'simpletix_embed_code', 'poster_url', 'web_graphics_url', 
                                    'created_at', 'updated_at'
                                ],
                                galleries: [
                                    'id', 'exhibition_title', 'artist', 'art_medium', 'gallery_space', 
                                    'description', 'content_type', 'poster_url', 'web_graphics_url', 
                                    'created_at', 'updated_at'
                                ]
                            };
                            
                            if (knownSchemas[table]) {
                                schemas[table] = knownSchemas[table];
                                console.log(`‚úì Using known schema for ${table}:`, schemas[table]);
                            } else {
                                schemas[table] = getDefaultSchema(table);
                                console.log(`‚ö† Using default schema for ${table}:`, schemas[table]);
                            }
                        }
                        
                        titles[table] = detectTitleField(schemas[table]);
                        
                    } catch (tableError) {
                        console.error(`‚ùå Error with ${table}:`, tableError);
                        schemas[table] = getDefaultSchema(table);
                        titles[table] = detectTitleField(schemas[table]);
                    }
                }
                
                tableSchemas = schemas;
                titleFields = titles;
                console.log('üìä Final schemas:', tableSchemas);
                
            } catch (error) {
                console.error('‚ùå Schema loading failed:', error);
                // Emergency fallback
                tableSchemas = {
                    movies: getDefaultSchema('movies'),
                    events: getDefaultSchema('events'),
                    galleries: getDefaultSchema('galleries')
                };
                titleFields = {
                    movies: 'title',
                    events: 'event_name', 
                    galleries: 'exhibition_title'
                };
            }
        }

        function getDefaultSchema(table) {
            const defaults = {
                movies: ['id', 'title', 'director', 'runtime_minutes', 'release_year', 'language', 'distributor', 'logline', 'synopsis', 'critic_quotes', 'trailer_url', 'simpletix_embed_code', 'poster_url', 'web_graphics_url', 'created_at', 'updated_at'],
                events: ['id', 'event_name', 'event_type', 'presenter', 'duration_minutes', 'description', 'critic_quotes', 'simpletix_embed_code', 'content_type', 'poster_url', 'web_graphics_url', 'created_at', 'updated_at'],
                galleries: ['id', 'exhibition_title', 'artist', 'art_medium', 'gallery_space', 'description', 'content_type', 'poster_url', 'web_graphics_url', 'created_at', 'updated_at']
            };
            return defaults[table] || ['id', 'title', 'description', 'created_at', 'updated_at'];
        }

        function detectTitleField(columns) {
            const titleCandidates = [
                'title', 'name', 'event_name', 'exhibition_title', 'movie_title', 
                'film_title', 'show_title', 'exhibition_name', 'event_title'
            ];
            
            for (const candidate of titleCandidates) {
                if (columns.includes(candidate)) {
                    return candidate;
                }
            }
            
            const textFields = columns.filter(col => 
                !col.includes('id') && 
                !col.includes('created_at') && 
                !col.includes('updated_at') &&
                !col.includes('url')
            );
            
            return textFields[0] || columns[0];
        }

        function getFieldType(columnName) {
            if (!columnName) return 'text';
            
            const name = columnName.toLowerCase();
            
            if (name.includes('poster_url') || name.includes('web_graphics_url') || name.includes('image_url')) {
                return 'file';
            }
            
            if (name.includes('year') || name.includes('minutes') || name.includes('duration') || name.includes('runtime') || name.includes('count')) {
                return 'number';
            }
            
            if (name.includes('url') || name.includes('link')) {
                return 'url';
            }
            
            if (name.includes('email')) {
                return 'email';
            }
            
            if (name.includes('date') || name.includes('time')) {
                return 'datetime-local';
            }
            
            if (name.includes('synopsis') || name.includes('description') || name.includes('logline') || 
                name.includes('quote') || name.includes('bio') || name.includes('notes') ||
                name.includes('summary') || name.length > 20) {
                return 'textarea';
            }
            
            return 'text';
        }

        function formatFieldLabel(columnName) {
            return columnName
                .replace(/_/g, ' ')
                .replace(/([a-z])([A-Z])/g, '$1 $2')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        function generateUrlSlug(text) {
            return text
                .toLowerCase()
                .replace(/[^\w\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/--+/g, '-') // Replace multiple hyphens with single hyphen
                .replace(/^-+/, '') // Remove starting hyphen
                .replace(/-+$/, ''); // Remove ending hyphen
        }

        function generateWebpageUrl(contentType, title) {
            const baseUrl = 'https://timeandspace.org'; // Your actual domain
            const slug = generateUrlSlug(title);
            const typeSegment = contentType.slice(0, -1); // Remove 's' from 'movies' -> 'movie'
            return `${baseUrl}/${contentType}/${slug}`;
        }

        async function generateDynamicForm() {
            const schema = tableSchemas[currentContentType];
            if (!schema) {
                document.getElementById('formFields').innerHTML = 
                    `<div class="empty-state">No schema found for ${currentContentType} table</div>`;
                return;
            }
            
            const schemaInfo = document.getElementById('schemaInfo');
            const schemaDetails = document.getElementById('schemaDetails');
            schemaDetails.textContent = `${currentContentType} table has ${schema.length} columns: ${schema.join(', ')}`;
            schemaInfo.classList.remove('hidden');
            
            if (currentEditingItem) {
                document.getElementById('formTitle').textContent = `Editing ${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1).slice(0, -1)}`;
                document.getElementById('saveButtonText').textContent = `Update ${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1).slice(0, -1)}`;
            } else {
                document.getElementById('formTitle').textContent = `${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1)} Details`;
                document.getElementById('saveButtonText').textContent = `Save ${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1).slice(0, -1)} to Database`;
            }
            
            const formFields = document.getElementById('formFields');
            let fieldsHTML = '';
            
            const userFields = schema.filter(col => 
                !col.includes('id') && 
                !col.includes('created_at') && 
                !col.includes('updated_at') &&
                col !== 'id'
            );
            
            const shortFields = [];
            const longFields = [];
            const imageFields = [];

            userFields.forEach(column => {
                const fieldType = getFieldType(column);
                if (fieldType === 'textarea') {
                    longFields.push(column);
                } else if (fieldType === 'file') {
                    imageFields.push(column);
                } else {
                    shortFields.push(column);
                }
            });
            
            if (shortFields.length > 0) {
                fieldsHTML += '<div class="form-grid">';
                shortFields.forEach(column => {
                    const fieldType = getFieldType(column);
                    const label = formatFieldLabel(column);
                    const required = column === titleFields[currentContentType] ? ' *' : '';
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label class="form-label">${label}${required}</label>
                            <input type="${fieldType}" id="${column}" class="form-input" data-column="${column}" />
                        </div>
                    `;
                });
                fieldsHTML += '</div>';
            }
            
            longFields.forEach(column => {
                const label = formatFieldLabel(column);
                const rows = column.toLowerCase().includes('synopsis') || column.toLowerCase().includes('description') ? '5' : '2';
                
                fieldsHTML += `
                    <div class="form-group">
                        <label class="form-label">${label}</label>
                        <textarea id="${column}" class="form-input" rows="${rows}" data-column="${column}"></textarea>
                    </div>
                `;
            });

            if (imageFields.length > 0) {
                fieldsHTML += '<h4 style="margin: 20px 0 15px 0; color: #1d1d1f;">Images</h4>';
                fieldsHTML += '<div class="form-grid">';
                imageFields.forEach(column => {
                    const label = formatFieldLabel(column);
                    
                    let previewClass = 'image-preview';
                    if (column.includes('poster')) {
                        previewClass = 'image-preview poster-preview';
                    } else if (column.includes('graphics') || column.includes('graphic')) {
                        previewClass = 'image-preview graphics-preview';
                    }
                    
                    fieldsHTML += `
                        <div class="form-group">
                            <label class="form-label">${label}</label>
                            <div class="image-upload-area" id="${column}Upload">
                                <input type="file" id="${column}Input" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('${column}Input').click()">
                                    <span>Click to upload ${label.toLowerCase()}</span>
                                    <div class="upload-hint">JPG, PNG, WebP (max 5MB)</div>
                                </div>
                                <div id="${column}Preview" class="${previewClass} hidden">
                                    <img id="${column}Img" src="" alt="${label} preview">
                                    <button type="button" onclick="removeImage('${column}')" class="remove-image-btn">√ó</button>
                                </div>
                            </div>
                            <input type="hidden" id="${column}" class="form-input" data-column="${column}">
                        </div>
                    `;
                });
                fieldsHTML += '</div>';
            }
            
            formFields.innerHTML = fieldsHTML;
            
            // Add auto-generation listener for webpage_url
            setTimeout(() => {
                const titleField = titleFields[currentContentType];
                const titleInput = document.getElementById(titleField);
                const webpageUrlInput = document.getElementById('webpage_url');
                
                if (titleInput && webpageUrlInput) {
                    titleInput.addEventListener('input', function() {
                        // Only auto-generate if the URL field is empty or was previously auto-generated
                        if (!webpageUrlInput.dataset.manuallyEdited) {
                            webpageUrlInput.value = generateWebpageUrl(currentContentType, titleInput.value);
                        }
                    });
                    
                    // Mark as manually edited if user types in the URL field
                    webpageUrlInput.addEventListener('input', function() {
                        this.dataset.manuallyEdited = 'true';
                    });
                    
                    // Clear manual edit flag when form is cleared
                    webpageUrlInput.addEventListener('change', function() {
                        if (!this.value) {
                            delete this.dataset.manuallyEdited;
                        }
                    });
                }
                
                
const imageInputs = document.querySelectorAll('[id$="Input"]');
imageInputs.forEach(input => {
    const column = input.id.replace('Input', '');

    // If this input already has a handler, remove it first
    if (input._uploadHandler) {
        input.removeEventListener('change', input._uploadHandler);
    }

    // Define a single handler and attach it
    input._uploadHandler = (e) => handleImageUpload(e, column);
    input.addEventListener('change', input._uploadHandler);
});

}, 100);
        }

        async function switchTab(tab, element) {
            try {
                // Clear editing state when switching to dashboard
                if (tab === 'dashboard' && currentEditingItem) {
                    currentEditingItem = null;
                    const indicator = document.getElementById('editingIndicator');
                    if (indicator) indicator.classList.remove('active');
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) saveBtn.removeAttribute('data-editing-id');
                    const deleteBtn = document.getElementById('deleteBtn');
                    if (deleteBtn) {
                        deleteBtn.classList.add('hidden');
                        deleteBtn.removeAttribute('data-delete-id');
                        deleteBtn.removeAttribute('data-delete-type');
                    }
                }
                
                // If clicking Add New while editing, clear edit state and start fresh
                if ((tab === 'importer' || tab === 'add-new') && currentEditingItem) {
                    currentEditingItem = null;
                    const indicator = document.getElementById('editingIndicator');
                    if (indicator) indicator.classList.remove('active');
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) saveBtn.removeAttribute('data-editing-id');
                    const deleteBtn = document.getElementById('deleteBtn');
                    if (deleteBtn) {
                        deleteBtn.classList.add('hidden');
                        deleteBtn.removeAttribute('data-delete-id');
                        deleteBtn.removeAttribute('data-delete-type');
                    }
                    
                    // Clear the form and regenerate
                    clearDynamicForm();
                    
                    // Reset form titles
                    document.getElementById('formTitle').textContent = `${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1)} Details`;
                    document.getElementById('saveButtonText').textContent = `Save ${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1).slice(0, -1)} to Database`;
                }
                
                // Update tab styles
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                if (element) element.classList.add('active');
                
                // Hide ALL tab content first
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                });
                
                // Then show only the selected tab
                if (tab === 'dashboard') {
                    const dashboardTab = document.getElementById('dashboard-tab');
                    dashboardTab.classList.add('active');
                    dashboardTab.style.display = 'block';
                    await loadContent();
                } else if (tab === 'importer' || tab === 'add-new') {
                    const importerTab = document.getElementById('importer-tab');
                    importerTab.classList.add('active');
                    importerTab.style.display = 'block';
                    await generateDynamicForm();
                }
            } catch (error) {
                console.error('Error switching tabs:', error);
                // Ensure proper display even on error
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                });
                if (tab === 'dashboard') {
                    const dashboardTab = document.getElementById('dashboard-tab');
                    dashboardTab.classList.add('active');
                    dashboardTab.style.display = 'block';
                } else {
                    const importerTab = document.getElementById('importer-tab');
                    importerTab.classList.add('active');
                    importerTab.style.display = 'block';
                }
            }
        }

        async function selectContentType(type, element) {
            currentContentType = type;
            document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Clear form but stay in Add New
            clearDynamicForm();
            
            // Reset editing state without changing tabs
            currentEditingItem = null;
            const indicator = document.getElementById('editingIndicator');
            if (indicator) {
                indicator.classList.remove('active');
            }
            
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.removeAttribute('data-editing-id');
            }
            
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                deleteBtn.classList.add('hidden');
                deleteBtn.removeAttribute('data-delete-id');
                deleteBtn.removeAttribute('data-delete-type');
            }
            
            // Reset form titles
            const formTitle = document.getElementById('formTitle');
            const saveButtonText = document.getElementById('saveButtonText');
            
            if (formTitle && saveButtonText) {
                formTitle.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Details`;
                saveButtonText.textContent = `Save ${type.charAt(0).toUpperCase() + type.slice(1).slice(0, -1)} to Database`;
            }
            
            await generateDynamicForm();
            
            // Explicitly ensure we stay in Add New tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.nav-tab:nth-child(2)').classList.add('active'); // Add New tab
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('importer-tab').classList.add('active');
        }

        function cancelEdit() {
            currentEditingItem = null;
            
            const indicator = document.getElementById('editingIndicator');
            if (indicator) {
                indicator.classList.remove('active');
            }
            
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.removeAttribute('data-editing-id');
            }
            
            // Hide delete button when not editing
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                deleteBtn.classList.add('hidden');
                deleteBtn.removeAttribute('data-delete-id');
                deleteBtn.removeAttribute('data-delete-type');
            }
            
            clearDynamicForm();
            
            const formTitle = document.getElementById('formTitle');
            const saveButtonText = document.getElementById('saveButtonText');
            
            if (formTitle && saveButtonText) {
                formTitle.textContent = `${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1)} Details`;
                saveButtonText.textContent = `Save ${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1).slice(0, -1)} to Database`;
            }
            
            // Stay in Add New mode after canceling edit
            // User can click "Cancel & Return to Dashboard" if they want to leave
        }
        
        async function cancelAndReturnToDashboard() {
            // Clear any editing state
            if (currentEditingItem) {
                cancelEdit();
            }
            
            // Clear the form
            clearDynamicForm();
            
            // Return to Dashboard
            await switchTab('dashboard', document.querySelector('.nav-tab:first-child'));
        }

        async function loadContent() {
            if (!supabase) return;
            
            try {
                const results = {};
                const tables = Object.keys(tableSchemas);
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase.from(table).select('*').order('created_at', { ascending: false });
                        if (!error && data) {
                            results[table] = data;
                        } else {
                            console.warn(`Error loading ${table}:`, error);
                            results[table] = [];
                        }
                    } catch (tableError) {
                        console.warn(`Error accessing ${table}:`, tableError);
                        results[table] = [];
                    }
                }
                
                document.getElementById('moviesCount').textContent = (results.movies || []).length;
                document.getElementById('eventsCount').textContent = (results.events || []).length;
                document.getElementById('galleriesCount').textContent = (results.galleries || []).length;
                
                const total = Object.values(results).reduce((sum, arr) => sum + arr.length, 0);
                document.getElementById('totalCount').textContent = total;
                
                allContent = [];
                Object.entries(results).forEach(([table, data]) => {
                    allContent = allContent.concat(data.map(item => ({ ...item, type: table })));
                });
                
                renderContent();
            } catch (error) {
                console.error('Load error:', error);
                showToast('Failed to load content');
            }
        }

        function renderContent(searchTerm = '') {
            let filteredContent = allContent;
            
            if (currentTab !== 'all') {
                filteredContent = filteredContent.filter(item => item.type === currentTab);
            }
            
            if (searchTerm) {
                filteredContent = filteredContent.filter(item => {
                    const titleField = titleFields[item.type];
                    const title = titleField ? item[titleField] : '';
                    return title && title.toLowerCase().includes(searchTerm.toLowerCase());
                });
            }
            
            const container = document.getElementById('contentContainer');
            
            if (filteredContent.length === 0) {
                container.innerHTML = '<div class="empty-state">No content found</div>';
                return;
            }
            
            let html = '<div class="content-grid">';
            filteredContent.forEach(item => {
                const titleField = titleFields[item.type];
                const title = titleField ? item[titleField] : 'Untitled';
                const webGraphicUrl = item.web_graphics_url || item.image_url || item.poster_url;

                html += `
                    <div class="content-card">
                        <div class="card-header">
                            <div class="card-title">${title}</div>
                            <div class="card-meta">${item.type.charAt(0).toUpperCase() + item.type.slice(1, -1)}</div>
                        </div>
                        ${webGraphicUrl ? `<div style="margin-bottom: 15px;"><img src="${webGraphicUrl}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;" alt="${title}"></div>` : ''}
                        <div class="card-actions">
                            <button class="btn btn-secondary" onclick="editContent('${item.id}', '${item.type}')">Edit</button>
                            <button class="btn btn-primary" onclick="downloadContent('${item.id}', '${item.type}')">Download</button>
                            <button class="btn btn-danger" onclick="deleteContent('${item.id}', '${item.type}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function searchContent() {
            const searchTerm = document.getElementById('searchInput').value;
            renderContent(searchTerm);
        }

        function filterContent(type, element) {
            currentTab = type;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            renderContent();
        }

        function fixSpacing(str) {
            return str
                .replace(/√¢‚Ç¨‚Ñ¢/g, "'")
                .replace(/√¢‚Ç¨≈ì/g, '"')
                .replace(/√¢‚Ç¨\x9D/g, '"')
                .replace(/√¢‚Ç¨"/g, '‚Äî')
                .replace(/√¢‚Ç¨"/g, '‚Äì')
                .replace(/√Ç/g, '')
                .trim();
        }

        function extractMovieData(text) {
            const cleanedText = fixSpacing(text);
            const data = {};
            
            const fieldMapping = {
                'title': 'title',
                'director': 'director',
                'runtime minutes': 'runtime_minutes',
                'runtime': 'runtime_minutes',
                'release year': 'release_year',
                'year': 'release_year',
                'language': 'language',
                'distributor': 'distributor',
                'synopsis': 'synopsis',
                'logline': 'logline',
                'description': 'synopsis',
                'event name': 'event_name',
                'event type': 'event_type',
                'presenter': 'presenter',
                'duration minutes': 'duration_minutes',
                'duration': 'duration_minutes',
                'exhibition title': 'exhibition_title',
                'artist': 'artist',
                'art medium': 'art_medium',
                'gallery space': 'gallery_space',
                'critics quote': 'critic_quotes',
                'critic quote': 'critic_quotes',
                'critic quotes': 'critic_quotes',
                'trailer url': 'trailer_url',
                'poster url': 'poster_url',
                'web graphics url': 'web_graphics_url',
                'simpletix embed code': 'simpletix_embed_code'
            };
            
            const lines = cleanedText.split('\n');
            let currentField = null;
            let currentValue = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const fieldMatch = line.match(/^([A-Za-z][A-Za-z\s]+?):\s*(.*)$/);
                
                if (fieldMatch) {
                    if (currentField && currentValue.length > 0) {
                        const value = currentValue.join('\n').trim();
                        if (value && !value.toLowerCase().includes('[not provided]')) {
                            data[currentField] = value;
                        }
                    }
                    
                    const fieldName = fieldMatch[1].toLowerCase().trim();
                    const immediateValue = fieldMatch[2].trim();
                    
                    currentField = fieldMapping[fieldName] || null;
                    currentValue = immediateValue ? [immediateValue] : [];
                    
                } else if (currentField) {
                    if (line.trim() || currentField === 'synopsis' || currentField === 'logline') {
                        currentValue.push(line);
                    }
                }
            }
            
            if (currentField && currentValue.length > 0) {
                const value = currentValue.join('\n').trim();
                if (value && !value.toLowerCase().includes('[not provided]')) {
                    data[currentField] = value;
                }
            }
            
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'string') {
                    data[key] = data[key].trim();
                    if (data[key] === '' || data[key].toLowerCase() === '[not provided]') {
                        delete data[key];
                    }
                }
            });
            
            console.log('Extracted data:', data);
            return data;
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type === 'application/pdf') {
                processPDF(file);
            } else if (file.type === 'text/plain') {
                processTextFile(file);
            } else {
                showToast('Please upload a PDF or text file');
            }
        }

        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                parseContent(fullText);
                showToast('PDF processed successfully');
            } catch (error) {
                console.error('PDF processing error:', error);
                showToast('Error processing PDF');
            }
        }

        async function processTextFile(file) {
            try {
                const text = await file.text();
                parseContent(text);
                showToast('Text file processed successfully');
            } catch (error) {
                console.error('Text file error:', error);
                showToast('Error processing text file');
            }
        }

        function parseContent(text) {
            document.getElementById('rawTextContent').textContent = text;
            const extractedData = extractMovieData(text);
            displayExtractedData(extractedData);
            fillDynamicForm(extractedData);
            document.getElementById('extractionPreview').classList.remove('hidden');
        }

        function displayExtractedData(data) {
            const container = document.getElementById('extractedData');
            let html = '';
            
            for (const [key, value] of Object.entries(data)) {
                if (value) {
                    const label = formatFieldLabel(key);
                    html += `<div><strong>${label}:</strong> ${value}</div>`;
                }
            }
            
            container.innerHTML = html || '<div>No data extracted</div>';
        }

        function fillDynamicForm(data) {
            const formFields = document.querySelectorAll('#formFields input, #formFields textarea');
            formFields.forEach(field => {
                if (field.dataset.column !== undefined) {
                    field.value = '';
                }
            });
            
            console.log('Attempting to fill form with data:', data);
            
            Object.entries(data).forEach(([key, value]) => {
                const field = document.getElementById(key);
                if (field && value) {
                    field.value = value;
                    console.log(`Filled ${key} with value:`, value);
                } else if (!field && value) {
                    console.log(`Field not found for ${key}, attempted value:`, value);
                }
            });
        }

        function toggleRawText() {
            const viewer = document.getElementById('rawTextViewer');
            viewer.classList.toggle('hidden');
        }

        function copyRawText() {
            const text = document.getElementById('rawTextContent').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard');
            });
        }

        function downloadData() {
            const data = {};
            const formFields = document.querySelectorAll('#formFields input, #formFields textarea');
            formFields.forEach(field => {
                if (field.value) {
                    data[field.dataset.column] = field.value;
                }
            });
            
            const title = data[titleFields[currentContentType]] || 'extracted';
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadRawText() {
            const rawText = document.getElementById('rawTextContent').textContent;
            if (!rawText) {
                showToast('No text to download');
                return;
            }
            
            const blob = new Blob([rawText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extracted-text.txt';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Text file downloaded');
        }

        async function saveContent() {
            if (!supabase) {
                showToast('Database not connected');
                return;
            }
            
            const schema = tableSchemas[currentContentType];
            if (!schema) {
                showToast('No schema found for this content type');
                return;
            }
            
            const data = {};
            const formFields = document.querySelectorAll('#formFields input, #formFields textarea');
            formFields.forEach(field => {
                const column = field.dataset.column;
                if (column && field.value.trim()) {
                    let value = field.value.trim();
                    
                    if (field.type === 'number' && value) {
                        value = parseInt(value) || null;
                    }
                    
                    data[column] = value;
                }
            });
            
            const titleField = titleFields[currentContentType];
            if (titleField && !data[titleField]) {
                showToast(`Please enter a ${formatFieldLabel(titleField)}`);
                return;
            }
            
            // Auto-generate webpage_url if the field exists in schema and has a title
            if (schema.includes('webpage_url') && titleField && data[titleField]) {
                // Only auto-generate if the field is empty or not manually edited
                if (!data.webpage_url) {
                    data.webpage_url = generateWebpageUrl(currentContentType, data[titleField]);
                    // Update the form field to show the generated URL
                    const urlField = document.getElementById('webpage_url');
                    if (urlField) {
                        urlField.value = data.webpage_url;
                    }
                }
            }
            
            try {
                const saveBtn = document.getElementById('saveBtn');
                const editingId = saveBtn.getAttribute('data-editing-id');
                
                if (editingId) {
                    const { error } = await supabase.from(currentContentType).update(data).eq('id', editingId);
                    if (error) throw error;
                    showToast('Updated successfully!');
                    
                    // After update, stay in edit mode so user can continue editing
                    // Just refresh the form with the updated data
                    loadContent(); // Update stats
                    
                } else {
                    const { error } = await supabase.from(currentContentType).insert([data]);
                    if (error) throw error;
                    showToast('Saved successfully!');
                    
                    // After saving new item, return to dashboard to see it in context
                    clearDynamicForm();
                    await switchTab('dashboard', document.querySelector('.nav-tab:first-child'));
                }
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save: ' + error.message);
            }
        }

        async function editContent(id, type) {
            try {
                const { data, error } = await supabase.from(type).select('*').eq('id', id).single();
                if (error) throw error;
                
                currentEditingItem = data;
                
                await switchTab('importer');
                
                currentContentType = type;
                document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('active'));
                document.querySelector(`.type-option:nth-child(${type === 'movies' ? 1 : type === 'events' ? 2 : 3})`).classList.add('active');
                
                await generateDynamicForm();
                
                const indicator = document.getElementById('editingIndicator');
                const titleField = titleFields[type];
                const title = data[titleField] || 'Untitled';
                document.getElementById('editingItemTitle').textContent = title;
                indicator.classList.add('active');
                
                setTimeout(() => {
                    Object.entries(data).forEach(([column, value]) => {
                        const field = document.getElementById(column);
                        if (field && value !== null) {
                            field.value = value;
                            
                            if (getFieldType(column) === 'file' && value) {
                                const imgElement = document.getElementById(column + 'Img');
                                const previewElement = document.getElementById(column + 'Preview');
                                const placeholderElement = document.querySelector(`#${column}Upload .upload-placeholder`);
                                
                                if (imgElement && previewElement) {
                                    imgElement.src = value;
                                    previewElement.classList.remove('hidden');
                                    if (placeholderElement) {
                                        placeholderElement.style.display = 'none';
                                    }
                                }
                            }
                        }
                    });
                }, 100);
                
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.setAttribute('data-editing-id', id);
                document.getElementById('formTitle').textContent = `Editing ${type.charAt(0).toUpperCase() + type.slice(1).slice(0, -1)}`;
                document.getElementById('saveButtonText').textContent = `Update ${type.charAt(0).toUpperCase() + type.slice(1).slice(0, -1)}`;
                
                // Show delete button when editing
                const deleteBtn = document.getElementById('deleteBtn');
                if (deleteBtn) {
                    deleteBtn.classList.remove('hidden');
                    deleteBtn.setAttribute('data-delete-id', id);
                    deleteBtn.setAttribute('data-delete-type', type);
                }
                
                showToast('Loaded for editing');
                
            } catch (error) {
                console.error('Edit load error:', error);
                showToast('Failed to load item for editing');
            }
        }
        
        async function deleteCurrentItem() {
            const deleteBtn = document.getElementById('deleteBtn');
            const id = deleteBtn.getAttribute('data-delete-id');
            const type = deleteBtn.getAttribute('data-delete-type');
            
            if (!id || !type) {
                showToast('No item selected for deletion');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await supabase.from(type).delete().eq('id', id);
                if (error) throw error;
                
                showToast('Item deleted successfully');
                
                // Clear everything and return to dashboard
                cancelEdit();
                await switchTab('dashboard', document.querySelector('.nav-tab:first-child'));
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete item');
            }
        }

        async function deleteContent(id, type) {
            if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await supabase.from(type).delete().eq('id', id);
                if (error) throw error;
                showToast('Item deleted successfully');
                loadContent();
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete item');
            }
        }

        async function downloadContent(id, type) {
            try {
                const { data, error } = await supabase.from(type).select('*').eq('id', id).single();
                if (error) throw error;
                
                const titleField = titleFields[type];
                const title = titleField ? data[titleField] : 'Untitled';
                
                let textContent = `${title.toUpperCase()}\n`;
                textContent += '='.repeat(title.length) + '\n\n';
                
                Object.entries(data).forEach(([column, value]) => {
                    if (value && column !== 'id' && !column.includes('created_at') && !column.includes('updated_at')) {
                        const label = formatFieldLabel(column);
                        textContent += `${label}: ${value}\n`;
                    }
                });
                
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-zA-Z0-9]/g, '-')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Content downloaded as text file');
                
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download content');
            }
        }

        function clearDynamicForm() {
            const formFields = document.querySelectorAll('#formFields input, #formFields textarea');
            formFields.forEach(field => {
                field.value = '';
                
                if (field.dataset.column && getFieldType(field.dataset.column) === 'file') {
                    const column = field.dataset.column;
                    removeImage(column);
                }
            });
            
            document.getElementById('extractionPreview').classList.add('hidden');
            document.getElementById('rawTextViewer').classList.add('hidden');
            document.getElementById('rawTextContent').textContent = '';
            document.getElementById('extractedData').innerHTML = '';
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        

async function handleImageUpload(event, column, movieId = "misc") {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        showToast('Please select an image file');
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        showToast('Image must be smaller than 5MB');
        return;
    }

    try {
        // Decide bucket based on field name
        let bucket = "posters";
        if (column.toLowerCase().includes("web_graphics")) {
            bucket = "web-graphics";
        }

        // Sanitize + unique filename
        const cleanName = file.name
            .replace(/\s+/g, '-')        
            .replace(/[^a-zA-Z0-9.\-_]/g, '');
        const uniqueSuffix = Math.random().toString(36).substring(2, 8);
        const fileName = `${Date.now()}-${uniqueSuffix}-${cleanName}`;

        // Subfolder per movie
        const filePath = `movies/${movieId}/${fileName}`;

        // Upload into correct bucket
        const { error: uploadError } = await supabase.storage
            .from(bucket)
            .upload(filePath, file, { upsert: true });

        if (uploadError) {
            console.error('Upload error:', uploadError);
            showToast('Failed to upload image');
            return;
        }

        // Get public URL
        const { data: urlData } = supabase.storage
            .from(bucket)
            .getPublicUrl(filePath);

        const publicUrl = urlData.publicUrl;

        // Save URL into hidden field
        document.getElementById(column).value = publicUrl;

        // Update preview
        document.getElementById(column + 'Img').src = publicUrl;
        document.getElementById(column + 'Preview').classList.remove('hidden');
        document.querySelector(`#${column}Upload .upload-placeholder`).style.display = 'none';

        showToast(`Image uploaded to ${bucket} successfully!`);
    } catch (error) {
        showToast('Error uploading image: ' + error.message);
        console.error('Image upload error:', error);
    }
}


function removeImage(column) {
            const field = document.getElementById(column);
            const img = document.getElementById(column + 'Img');
            const preview = document.getElementById(column + 'Preview');
            const placeholder = document.querySelector(`#${column}Upload .upload-placeholder`);
            const input = document.getElementById(column + 'Input');
            
            if (field) field.value = '';
            if (img) img.src = '';
            if (preview) preview.classList.add('hidden');
            if (placeholder) placeholder.style.display = 'block';
            if (input) input.value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
            document.getElementById('fileInput').addEventListener('change', handleFile);
            
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf' || file.type === 'text/plain') {
                        const fileInput = document.getElementById('fileInput');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        handleFile({ target: { files: [file] } });
                    } else {
                        showToast('Please drop a PDF or text file');
                    }
                }
            });
            
            uploadSection.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchContent();
                }
            });
        });
    </script>
</body>
</html>
